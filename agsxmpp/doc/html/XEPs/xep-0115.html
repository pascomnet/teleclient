<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>XEP-0115: Entity Capabilities</title><link rel="stylesheet" type="text/css" href="/xmpp.css" /><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" /><meta name="DC.Title" content="Entity Capabilities" /><meta name="DC.Creator" content="Joe Hildebrand" /><meta name="DC.Creator" content="Peter Saint-Andre" /><meta name="DC.Creator" content="Remko Tron&#xE7;on" /><meta name="DC.Creator" content="Jacek Konieczny" /><meta name="DC.Description" content="This document defines an XMPP protocol extension for broadcasting and dynamically discovering client, device, or generic entity capabilities. In order to minimize network impact, the transport mechanism is standard XMPP presence broadcast (thus forestalling the need for polling related to service discovery data), the capabilities information can be cached either within a session or across sessions, and the format has been kept as small as possible." /><meta name="DC.Publisher" content="XMPP Standards Foundation" /><meta name="DC.Contributor" content="XMPP Extensions Editor" /><meta name="DC.Date" content="2008-02-26" /><meta name="DC.Type" content="XMPP Extension Protocol" /><meta name="DC.Format" content="XHTML" /><meta name="DC.Identifier" content="XEP-0115" /><meta name="DC.Language" content="en" /><meta name="DC.Rights" content="This XMPP Extension Protocol is copyright (c) 1999 - 2008 by the XMPP Standards Foundation (XSF)." /></head><body><h1>XEP-0115: Entity Capabilities</h1><p>This document defines an XMPP protocol extension for broadcasting and dynamically discovering client, device, or generic entity capabilities. In order to minimize network impact, the transport mechanism is standard XMPP presence broadcast (thus forestalling the need for polling related to service discovery data), the capabilities information can be cached either within a session or across sessions, and the format has been kept as small as possible.</p><hr /><p style="color:green">NOTICE: The protocol defined herein is a Draft Standard of the XMPP Standards Foundation. Implementations are encouraged and the protocol is appropriate for deployment in production systems, but some changes to the protocol are possible before it becomes a Final Standard.</p><hr /><h2>Document Information</h2><p class="indent">
            Series: <a href="http://www.xmpp.org/extensions/">XEP</a><br />
            Number: 0115<br />
            Publisher: <a href="/xsf/">XMPP Standards Foundation</a><br />
            Status: 
            <a href="http://www.xmpp.org/extensions/xep-0001.html#states-Draft">Draft</a><br />
            Type:
            <a href="http://www.xmpp.org/extensions/xep-0001.html#types-Standards Track">Standards Track</a><br />
            Version: 1.5<br />
            Last Updated: 2008-02-26<br />
                Approving Body: <a href="http://www.xmpp.org/council/">XMPP Council</a><br />Dependencies: XMPP Core, XMPP IM, XEP-0030<br />
                Supersedes: None<br />
                Superseded By: None<br />
            Short Name: caps<br />
        Schema: &lt;<a href="http://www.xmpp.org/schemas/caps.xsd">http://www.xmpp.org/schemas/caps.xsd</a>&gt;<br />
              Wiki Page: &lt;<a href="http://wiki.jabber.org/index.php/Entity Capabilities (XEP-0115)">http://wiki.jabber.org/index.php/Entity Capabilities (XEP-0115)</a>&gt;
            </p><hr /><h2>Author Information</h2><div class="indent"><h3>Joe Hildebrand</h3><p class="indent">
        Email:
        <a href="mailto:jhildebrand@jabber.com">jhildebrand@jabber.com</a><br />
        JabberID: 
        <a href="xmpp:hildjj@jabber.org">hildjj@jabber.org</a><br /></p><h3>Peter Saint-Andre</h3><p class="indent">
        JabberID: 
        <a href="xmpp:stpeter@jabber.org">stpeter@jabber.org</a><br />
        URI: 
        <a href="https://stpeter.im/">https://stpeter.im/</a><br /></p><h3>Remko Tronçon</h3><p class="indent">
        Email:
        <a href="mailto:public@el-tramo.be">public@el-tramo.be</a><br />
        JabberID: 
        <a href="xmpp:public@el-tramo.be">public@el-tramo.be</a><br /></p><h3>Jacek Konieczny</h3><p class="indent">
        Email:
        <a href="mailto:jajcus@jajcus.net">jajcus@jajcus.net</a><br />
        JabberID: 
        <a href="xmpp:jajcus@jabber.bnet.pl">jajcus@jabber.bnet.pl</a><br /></p></div><hr /><h2>Legal Notices</h2><div class="indent"><h3>Copyright</h3>This XMPP Extension Protocol is copyright (c) 1999 - 2008 by the XMPP Standards Foundation (XSF).<h3>Permissions</h3>Permission is hereby granted, free of charge, to any person obtaining a copy of this specification (the "Specification"), to make use of the Specification without restriction, including without limitation the rights to implement the Specification in a software program, deploy the Specification in a network service, and copy, modify, merge, publish, translate, distribute, sublicense, or sell copies of the Specification, and to permit persons to whom the Specification is furnished to do so, subject to the condition that the foregoing copyright notice and this permission notice shall be included in all copies or substantial portions of the Specification. Unless separate permission is granted, modified works that are redistributed shall not contain misleading information regarding the authors, title, number, or publisher of the Specification, and shall not claim endorsement of the modified works by the authors, any organization or project to which the authors belong, or the XMPP Standards Foundation.<h3>Disclaimer of Warranty</h3><span style="font-weight: bold">## NOTE WELL: This Specification is provided on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or implied, including, without limitation, any warranties or conditions of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A PARTICULAR PURPOSE. In no event shall the XMPP Standards Foundation or the authors of this Specification be liable for any claim, damages, or other liability, whether in an action of contract, tort, or otherwise, arising from, out of, or in connection with the Specification or the implementation, deployment, or other use of the Specification. ##</span><h3>Limitation of Liability</h3>In no event and under no legal theory, whether in tort (including negligence), contract, or otherwise, unless required by applicable law (such as deliberate and grossly negligent acts) or agreed to in writing, shall the XMPP Standards Foundation or any author of this Specification be liable for damages, including any direct, indirect, special, incidental, or consequential damages of any character arising out of the use or inability to use the Specification (including but not limited to damages for loss of goodwill, work stoppage, computer failure or malfunction, or any and all other commercial damages or losses), even if the XMPP Standards Foundation or such author has been advised of the possibility of such damages.<h3>IPR Conformance</h3>This XMPP Extension Protocol has been contributed in full conformance with the XSF's Intellectual Property Rights Policy (a copy of which may be found at &lt;<a href="http://www.xmpp.org/extensions/ipr-policy.shtml">http://www.xmpp.org/extensions/ipr-policy.shtml</a>&gt; or obtained by writing to XSF, P.O. Box 1641, Denver, CO 80201 USA).</div><hr /><h2>Discussion Venue</h2><p class="indent">The preferred venue for discussion of this document is the Standards discussion list: &lt;<a href="http://mail.jabber.org/mailman/listinfo/standards">http://mail.jabber.org/mailman/listinfo/standards</a>&gt;.</p><p class="indent">Errata may be sent to &lt;<a href="mailto:editor@xmpp.org">editor@xmpp.org</a>&gt;.</p><h2>Relation to XMPP</h2><p class="indent">The Extensible Messaging and Presence Protocol (XMPP) is defined in the XMPP Core (RFC 3920) and XMPP IM (RFC 3921) specifications contributed by the XMPP Standards Foundation to the Internet Standards Process, which is managed by the Internet Engineering Task Force in accordance with RFC 2026. Any protocol defined in this document has been developed outside the Internet Standards Process and is to be understood as an extension to XMPP rather than as an evolution, development, or modification of XMPP itself.</p><h2>Conformance Terms</h2><p class="indent">The following keywords as used in this document are to be interpreted as described in <a href="http://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>: "MUST", "SHALL", "REQUIRED"; "MUST NOT", "SHALL NOT"; "SHOULD", "RECOMMENDED"; "SHOULD NOT", "NOT RECOMMENDED"; "MAY", "OPTIONAL".</p><hr /><h2>Table of Contents</h2><div class="indent"><p><br />1.  <a href="#intro">Introduction</a><br />   
      1.1.  <a href="#motivation">Motivation</a><br />   
      1.2.  <a href="#howitworks">How It Works</a><br />2.  <a href="#assumptions">Assumptions</a><br />3.  <a href="#reqs">Requirements</a><br />4.  <a href="#protocol">Protocol</a><br />5.  <a href="#ver">Verification String</a><br />   
      5.1.  <a href="#ver-gen">Generation Method</a><br />   
      5.2.  <a href="#ver-gen-simple">Simple Generation Example</a><br />   
      5.3.  <a href="#ver-gen-complex">Complex Generation Example</a><br />   
      5.4.  <a href="#ver-proc">Processing Method</a><br />6.  <a href="#usecases">Use Cases</a><br />   
      6.1.  <a href="#advertise">Advertising Capabilities</a><br />   
      6.2.  <a href="#discover">Discovering Capabilities</a><br />   
      6.3.  <a href="#stream">Stream Feature</a><br />7.  <a href="#support">Determining Support</a><br />8.  <a href="#impl">Implementation Notes</a><br />   
      8.1.  <a href="#impl-hash">Hashing Algorithm Support</a><br />   
      8.2.  <a href="#impl-cache">Caching</a><br />   
      8.3.  <a href="#impl-presence">Directed Presence</a><br />   
      8.4.  <a href="#impl-optimize">Caps Optimization</a><br />9.  <a href="#security">Security Considerations</a><br />   
      9.1.  <a href="#security-mti">Mandatory-to-Implement Technologies</a><br />   
      9.2.  <a href="#security-preimage">Preimage Attacks</a><br />   
      9.3.  <a href="#security-poisoning">Caps Poisoning</a><br />   
      9.4.  <a href="#security-exposure">Information Exposure</a><br />10.  <a href="#iana">IANA Considerations</a><br />11.  <a href="#registrar">XMPP Registrar Considerations</a><br />   
      11.1.  <a href="#ns">Protocol Namespaces</a><br />   
      11.2.  <a href="#registrar-features">Service Discovery Features</a><br />12.  <a href="#schema">XML Schema</a><br />13.  <a href="#legacy">Legacy Format</a><br />14.  <a href="#ack">Acknowledgements</a><br /><a href="#notes">Notes</a><br /><a href="#revs">Revision History</a></p></div><hr /><h2>1.
       <a name="intro" id="intro">Introduction</a></h2>
    <div class="indent"><h3>1.1 <a name="motivation" id="motivation">Motivation</a></h3>
      <p class="" style="">It is often desirable for an XMPP application (commonly but not necessarily a client) to take different actions depending on the capabilities of another application from which it receives presence information. Examples include:</p>
      <ul class="" style="">
        <li class="" style="">Showing a different set of icons depending on the capabilities of other entities.</li>
        <li class="" style="">Not sending <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0071.html">XHTML-IM</a></span>  [<a href="#nt-id2251582">1</a>] or other rich content to plaintext clients such as cell phones.</li> 
        <li class="" style="">Allowing the initiation of a Voice over IP (VoIP) session only to clients that support <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0166.html">Jingle</a></span>  [<a href="#nt-id2261178">2</a>] and <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0167.html">Jingle Audio via RTP</a></span>  [<a href="#nt-id2261203">3</a>].</li>
        <li class="" style="">Not showing a "Send a File" button if another user's client does not support <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0096.html">SI File Transfer</a></span>  [<a href="#nt-id2261230">4</a>].</li>
        <li class="" style="">Filtering <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0060.html">Publish-Subscribe</a></span>  [<a href="#nt-id2261258">5</a>] notifications based on advertised subscriber interests.</li>
      </ul>
      <p class="" style="">In the past, after logging in some Jabber clients sent one <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0030.html">Service Discovery</a></span>  [<a href="#nt-id2261295">6</a>] and one <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0092.html">Software Version</a></span>  [<a href="#nt-id2261321">7</a>] request to each entity from which they received presence. That "disco/version flood" resulted in an excessive use of bandwidth and was impractical on a larger scale, particularly for users with large rosters. Therefore this document defines a more robust and scalable solution: namely, a presence-based mechanism  [<a href="#nt-id2261274">8</a>] for exchanging information about entity capabilities. Clients should not engage in the older "disco/version flood" behavior and instead should use Entity Capabilities as specified herein.</p>
    </div>
    <div class="indent"><h3>1.2 <a name="howitworks" id="howitworks">How It Works</a></h3>
      <p class="" style="">This section provides a friendly introduction to entity capabilities ("caps").</p>
      <p class="" style="">Imagine that you are a Shakespearean character named Juliet and one of your contacts, a handsome fellow named Romeo, becomes available. His client wants to publish its capabilities, and does this by adding to its presence packets a &lt;c/&gt; element with special attributes. As a result, your client receives the following presence packet:</p>
      <p class="caption"></p><div class="indent"><pre>
&lt;presence from='romeo@montague.lit/orchard'&gt;
  &lt;c xmlns='http://jabber.org/protocol/caps' 
     hash='sha-1'
     node='http://code.google.com/p/exodus'
     ver='SrFo9ar2CCk2EnOH4q4QANeuxLQ='/&gt;
&lt;/presence&gt;
      </pre></div>
      <p class="" style="">The 'node' attribute represents the client software Romeo is using. The 'ver' attribute is a specially-constructed string (called a "verification string") that represents the entity's service discovery identity (category and type as registered at &lt;<a href="http://www.xmpp.org/registrar/disco-categories.html">http://www.xmpp.org/registrar/disco-categories.html</a>&gt;, as well as, optionally, xml:lang and name) and supported features (as registered at &lt;<a href="http://www.xmpp.org/registrar/disco-features.html">http://www.xmpp.org/registrar/disco-features.html</a>&gt; as well as, optionally, extended service discovery information data registered at &lt;<a href="http://www.xmpp.org/registrar/formtypes.html">http://www.xmpp.org/registrar/formtypes.html</a>&gt;).</p>
      <p class="" style="">At this point, your client has no idea what the capabilities are of someone with a version string 'SrFo9ar2CCk2EnOH4q4QANeuxLQ='. Your client therefore sends a service discovery query to Romeo, asking what his client can do.</p>
      <p class="caption"></p><div class="indent"><pre>
&lt;iq from='juliet@capulet.lit/chamber' 
    id='disco1'
    to='romeo@montague.lit/orchard' 
    type='get'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'
         node='http://code.google.com/p/exodus#SrFo9ar2CCk2EnOH4q4QANeuxLQ='/&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">The response is:</p>
      <p class="caption"></p><div class="indent"><pre>
&lt;iq from='romeo@montague.lit/orchard' 
    id='disco1'
    to='juliet@capulet.lit/chamber' 
    type='result'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'
         node='http://code.google.com/p/exodus#SrFo9ar2CCk2EnOH4q4QANeuxLQ='&gt;
    &lt;identity category='client' name='Exodus 0.9.1' type='pc'/&gt;
    &lt;feature var='http://jabber.org/protocol/disco#info'/&gt;
    &lt;feature var='http://jabber.org/protocol/disco#items'/&gt;
    &lt;feature var='http://jabber.org/protocol/muc'/&gt;
  &lt;/query&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">At this point, your client knows that anyone advertising a version string of 'SrFo9ar2CCk2EnOH4q4QANeuxLQ=' has a client that can do <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0045.html">Multi-User Chat</a></span>  [<a href="#nt-id2261494">9</a>] and the other features returned by Romeo's client (the string can be relied upon because of how it is generated and checked, as explained later in this document). Your client remembers this information, so that it does not need to explicitly query the capabilities of a contact with the same version string. For example, your Nurse may use the same client that Romeo does:</p>
      <p class="caption"></p><div class="indent"><pre>
&lt;presence from='nurse@capulet.lit/chamber'&gt;
  &lt;c xmlns='http://jabber.org/protocol/caps' 
     hash='sha-1'
     node='http://code.google.com/p/exodus'
     ver='SrFo9ar2CCk2EnOH4q4QANeuxLQ='/&gt;
&lt;/presence&gt;
      </pre></div>
      <p class="" style="">Therefore you know that she also supports the same features that Romeo does.</p>
      <p class="" style="">On the other hand, for a person with the following presence ...</p>
      <p class="caption"></p><div class="indent"><pre>
&lt;presence from='benvolio@capulet.lit/230193'&gt;
  &lt;c xmlns='http://jabber.org/protocol/caps' 
     hash='sha-1'
     node='http://psi-im.org'
     ver='8lu+88MRxmKM7yO3MEzY7YmTsWs='/&gt;
&lt;/presence&gt;
      </pre></div>
      <p class="" style="">... or the following presence ...</p>
      <p class="caption"></p><div class="indent"><pre>
&lt;presence from='bard@shakespeare.lit/globe'&gt;
  &lt;c xmlns='http://jabber.org/protocol/caps' 
     hash='sha-1'
     node='http://www.chatopus.com'
     ver='zHyEOgxTrkpSdGcQKH8EFPLsriY='/&gt;
&lt;/presence&gt;
      </pre></div>
      <p class="" style="">... you have no information about what this contact's client is capable of unless you have cached previous entity capabilities information; therefore you need to query for capabilities explicitly again via service discovery.</p>
    </div>
  <h2>2.
       <a name="assumptions" id="assumptions">Assumptions</a></h2>
    <p class="" style="">This document makes several assumptions:</p>
    <ul class="" style="">
      <li class="" style="">The identity of the client I am using is of interest to the people in my roster.</li>
      <li class="" style="">Clients for the people on my roster might want to make user interface decisions based on my capabilities.</li>
      <li class="" style="">Members of a community tend to cluster around a small set of clients with a small set of capabilities. More specifically, multiple people in my roster use the same client, and they upgrade versions relatively slowly (commonly a few times a year, perhaps once a week at most, certainly not once a minute).</li>
      <li class="" style="">Some clients are running on networks without server-to-server connectivity enabled and without access to the Internet via HTTP.</li>
      <li class="" style="">Conversations are possible between users who are not on each other's rosters.</li>
      <li class="" style="">Client capabilities may change over the course of a presence session, as features are enabled or disabled.</li>
    </ul>
  <h2>3.
       <a name="reqs" id="reqs">Requirements</a></h2>
    <p class="" style="">The protocol defined herein addresses the following requirements:</p>
    <ol start="" class="" style="">
      <li class="" style="">Clients must be able to participate even if they support only <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc3920">XMPP Core</a></span>  [<a href="#nt-id2261696">10</a>], <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc3921">XMPP IM</a></span>  [<a href="#nt-id2261720">11</a>], and <span class="ref">XEP-0030</span>.</li>
      <li class="" style="">Clients must be able to participate even if they are on networks without connectivity to other XMPP servers, services offering specialized XMPP extensions, or HTTP servers. [<a href="#nt-id2261734">12</a>]</li>
      <li class="" style="">Clients must be able to retrieve information without querying every entity with which they communicate.</li>
      <li class="" style="">Since presence is normally broadcast to many contacts, the byte size of the proposed extension must be as small as possible.</li>
      <li class="" style="">It must be possible to write a XEP-0045 server implementation that passes the given information along.</li>
      <li class="" style="">It must be possible to publish a change in capabilities within a single presence session.</li>
      <li class="" style="">Server infrastructure above and beyond that defined in <span class="ref">XMPP Core</span> and <span class="ref">XMPP IM</span> must not be required for this approach to work, although additional server infrastructure may be used for optimization purposes.</li>
      <li class="" style="">The defined mechanism must not be limited to clients but must be usable by servers, components, and other network entities.</li>
    </ol>
  <h2>4.
       <a name="protocol" id="protocol">Protocol</a></h2>
    <p class="" style="">Entity capabilities are encapsulated in a &lt;c/&gt; element qualified by the 'http://jabber.org/protocol/caps' namespace. The attributes of the &lt;c/&gt; element are as follows.</p>
    <p class="caption"><a name="table-1" id="table-1"></a>Table 1: Attributes</p><table border="1" cellpadding="3" cellspacing="0">
      <tr class="body">
        <th colspan="" rowspan="">Name</th>
        <th colspan="" rowspan="">Definition</th>
        <th colspan="" rowspan="">Inclusion</th>
      </tr>
      <tr class="body">
        <td colspan="" rowspan="">ext</td>
        <td colspan="" rowspan="">A set of nametokens specifying additional feature bundles; this attribute is deprecated (see the <a href="#legacy">Legacy Format</a> section of this document).</td>
        <td colspan="" rowspan="">DEPRECATED</td>
      </tr>
      <tr class="body">
        <td colspan="" rowspan="">hash</td>
        <td colspan="" rowspan="">The hashing algorithm used to generate the verification string; see <a href="#security-mti">Mandatory-to-Implement Technologies</a> regarding supported hashing algorithms.</td>
        <td colspan="" rowspan="">REQUIRED</td>
      </tr>
      <tr class="body">
        <td colspan="" rowspan="">node</td>
        <td colspan="" rowspan="">A URI that uniquely identifies a software application, typically a URL at the website of the project or company that produces the software. *</td>
        <td colspan="" rowspan="">REQUIRED</td>
      </tr>
      <tr class="body">
        <td colspan="" rowspan="">ver</td>
        <td colspan="" rowspan="">A string that is used to verify the identity and supported features of the entity. **</td>
        <td colspan="" rowspan="">REQUIRED</td>
      </tr>
    </table>
    <p class="" style="">* Note: It is RECOMMENDED for the value of the 'node' attribute to be an HTTP URL at which a user could find further information about the software product, such as "http://psi-im.org" for the Psi client; this enables a processing application to also determine a unique string for the generating application, which it could maintain in a list of known software implementations (e.g., associating the name received via the disco#info reply with the URL found in the caps data).</p>
    <p class="" style="">**  Note: Before version 1.4 of this specification, the 'ver' attribute was used to specify the released version of the software; while the values of the 'ver' attribute that result from use of the algorithm specified herein are backwards-compatible, applications SHOULD appropriately handle the <a href="#legacy">Legacy Format</a>.</p>
  <h2>5.
       <a name="ver" id="ver">Verification String</a></h2>
    <div class="indent"><h3>5.1 <a name="ver-gen" id="ver-gen">Generation Method</a></h3>
      <p class="" style="">In order to help prevent poisoning of entity capabilities information, the value of the verification string MUST be generated according to the following method.</p>
      <p class="" style="">Note: All sorting operations MUST be performed using "i;octet" collation as specified in Section 9.3 of <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc4790">RFC 4790</a></span>  [<a href="#nt-id2262060">13</a>].</p>
      <ol start="" class="" style="">
        <li class="" style="">Initialize an empty string S.</li>
        <li class="" style="">Sort the service discovery identities  [<a href="#nt-id2262085">14</a>] by category and then by type (if it exists) and then by xml:lang (if it exists), formatted as CATEGORY '/' [TYPE] '/' [LANG] '/' [NAME]. Note that each slash is included even if the TYPE, LANG, or NAME is not included.</li>
        <li class="" style="">For each identity, append the 'category/type/lang/name' to S, followed by the '&lt;' character.</li>
        <li class="" style="">Sort the supported service discovery features.  [<a href="#nt-id2262122">15</a>]</li>
        <li class="" style="">For each feature, append the feature to S, followed by the '&lt;' character.</li>
        <li class="" style="">If the service discovery information response includes <span class="ref">XEP-0128</span> data forms, sort the forms by the FORM_TYPE (i.e., by the XML character data of the &lt;value/&gt; element).</li>
        <li class="" style="">For each extended service discovery information form:
          <ol start="" class="" style="">
            <li class="" style="">Append the XML character data of the FORM_TYPE field's &lt;value/&gt; element, followed by the '&lt;' character.</li>
            <li class="" style="">Sort the fields by the value of the "var" attribute.</li>
            <li class="" style="">For each field:
              <ol start="" class="" style="">
                <li class="" style="">Append the value of the "var" attribute, followed by the '&lt;' character.</li>
                <li class="" style="">Sort values by the XML character data of the &lt;value/&gt; element.</li>
                <li class="" style="">For each &lt;value/&gt; element, append the XML character data, followed by the '&lt;' character.</li>
              </ol>
            </li>
          </ol>
        </li>
        <li class="" style="">Ensure that S is encoded according to the UTF-8 encoding (<span class="ref" style=""><a href="http://tools.ietf.org/html/rfc3269">RFC 3269</a></span>  [<a href="#nt-id2262279">16</a>]).</li>
        <li class="" style="">Compute the verification string by hashing S using the algorithm specified in the 'hash' attribute (e.g., SHA-1 as defined in <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc3174">RFC 3174</a></span>  [<a href="#nt-id2262313">17</a>]). The hashed data MUST be generated with binary output and encoded using Base64 as specified in Section 4 of <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc4648">RFC 4648</a></span>  [<a href="#nt-id2262342">18</a>] (note: the Base64 output MUST NOT include whitespace and MUST set padding bits to zero).  [<a href="#nt-id2262293">19</a>]</li>
      </ol>
    </div>
    <div class="indent"><h3>5.2 <a name="ver-gen-simple" id="ver-gen-simple">Simple Generation Example</a></h3>
      <p class="" style="">Consider an entity whose category is "client", whose service discovery type is "pc", whose service discovery name is "Exodus 0.9.1", and whose supported features are "http://jabber.org/protocol/disco#info", "http://jabber.org/protocol/disco#items", and "http://jabber.org/protocol/muc". Using the SHA-1 algorithm, the verification string would be generated as follows:</p>
      <ol start="" class="" style="">
        <li class="" style="">S = ''</li>
        <li class="" style="">Only one identity: "client/pc"</li>
        <li class="" style="">S = 'client/pc//Exodus 0.9.1&lt;'</li>
        <li class="" style="">Sort the features: "http://jabber.org/protocol/disco#info", "http://jabber.org/protocol/disco#items", "http://jabber.org/protocol/muc".</li>
        <li class="" style="">S = 'client/pc//Exodus 0.9.1&lt;http://jabber.org/protocol/disco#info&lt;http://jabber.org/protocol/disco#items&lt;http://jabber.org/protocol/muc&lt;'</li>
        <li class="" style="">ver = SrFo9ar2CCk2EnOH4q4QANeuxLQ=</li>
      </ol>
    </div>
    <div class="indent"><h3>5.3 <a name="ver-gen-complex" id="ver-gen-complex">Complex Generation Example</a></h3>
      <p class="" style="">Consider a more complex example, where the entity includes several identities (with the service discovery name in different languages) as well as extended information formatted according to <span class="ref">XEP-0128</span>.</p>
      <p class="caption"></p><div class="indent"><pre>
&lt;iq from='benvolio@capulet.lit/230193'&gt;
    id='disco1'
    to='juliet@capulet.lit/chamber' 
    type='result'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'
         node='http://psi-im.org#8lu+88MRxmKM7yO3MEzY7YmTsWs='&gt;
    &lt;identity xml:lang='en' category='client' name='Psi 0.9.1' type='pc'/&gt;
    &lt;identity xml:lang='el' category='client' name='Ψ 0.9.1' type='pc'/&gt;
    &lt;feature var='http://jabber.org/protocol/disco#info'/&gt;
    &lt;feature var='http://jabber.org/protocol/disco#items'/&gt;
    &lt;feature var='http://jabber.org/protocol/muc'/&gt;
    &lt;x xmlns='jabber:x:data' type='result'&gt;
      &lt;field var='FORM_TYPE' type='hidden'&gt;
        &lt;value&gt;urn:xmpp:dataforms:softwareinfo&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='ip_version'&gt;
        &lt;value&gt;ipv4&lt;/value&gt;
        &lt;value&gt;ipv6&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='os'&gt;
        &lt;value&gt;Mac&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='os_version'&gt;
        &lt;value&gt;10.5.1&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='software'&gt;
        &lt;value&gt;Psi&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='software_version'&gt;
        &lt;value&gt;0.11&lt;/value&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/query&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">Using the SHA-1 algorithm, the verification string would be generated as follows (note: line breaks in the verification string are included only for the purposes of readability):</p>
      <ol start="" class="" style="">
        <li class="" style="">S = ''</li>
        <li class="" style="">Two identities: "client/pc/Psi" and "client/pc/Ψ"</li>
        <li class="" style="">S = 'client/pc/el/Ψ 0.9.1&lt;client/pc/en/Psi 0.9.1&lt;'</li>
        <li class="" style="">Sort the features: "http://jabber.org/protocol/caps", http://jabber.org/protocol/disco#info", "http://jabber.org/protocol/disco#items", "http://jabber.org/protocol/muc".</li>
        <li class="" style="">S = 'client/pc/el/Ψ 0.9.1&lt;client/pc/en/Psi 0.9.1&lt;http://jabber.org/protocol/caps&lt;http://jabber.org/protocol/disco#info
        &lt;http://jabber.org/protocol/disco#items&lt;http://jabber.org/protocol/muc'.</li>
        <li class="" style="">Sort the extended service discovery forms by FORM_TYPE (there is only one: "urn:xmpp:dataforms:softwareinfo").</li>
        <li class="" style="">S = 'client/pc/el/Ψ 0.9.1&lt;client/pc/en/Psi 0.9.1&lt;http://jabber.org/protocol/caps&lt;http://jabber.org/protocol/disco#info
        &lt;http://jabber.org/protocol/disco#items&lt;http://jabber.org/protocol/muc&lt;urn:xmpp:dataforms:softwareinfo&lt;'</li>
        <li class="" style="">Sort the fields by var and append the value(s): "ip_version&lt;ipv4&lt;ipv6", "os&lt;Mac", "os_version&lt;10.5.1", "software&lt;Psi", "software_version&lt;0.11".</li>
        <li class="" style="">S = 'client/pc/el/Ψ 0.9.1&lt;client/pc/en/Psi 0.9.1&lt;http://jabber.org/protocol/caps
        &lt;http://jabber.org/protocol/disco#info&lt;http://jabber.org/protocol/disco#items&lt;http://jabber.org/protocol/muc
        &lt;urn:xmpp:dataforms:softwareinfo&lt;ip_version&lt;ipv4&lt;ipv6&lt;os&lt;Mac&lt;os_version&lt;10.5.1&lt;software&lt;Psi&lt;software_version&lt;0.11&lt;'</li>
        <li class="" style="">ver = 8lu+88MRxmKM7yO3MEzY7YmTsWs=</li>
      </ol>
    </div>
    <div class="indent"><h3>5.4 <a name="ver-proc" id="ver-proc">Processing Method</a></h3>
      <p class="" style="">When an entity receives a value of the 'ver' attribute that appears to be a verification string generated in accordance with the generation method defined in this specification, it MUST process the 'ver' according to the following method.</p>
      <ol start="" class="" style="">
        <li class="" style="">Verify that the &lt;c/&gt; element includes a 'hash' attribute. If it does not, ignore the 'ver' or treat it as generated in accordance with the <a href="#legacy">Legacy Format</a> (if supported).</li>
        <li class="" style="">If the value of the 'hash' attribute does not match one of the processing application's supported hash functions, do the following:
          <ol start="" class="" style="">
            <li class="" style="">Send a service discovery information request to the generating entity.</li>
            <li class="" style="">Receive a service discovery information response from the generating entity.</li>
            <li class="" style="">Do not validate or globally cache the verification string as described below; instead, the processing application SHOULD associate the discovered identity+features <span class="em">only</span> with the JabberID of the generating entity.</li>
          </ol>
        </li>
        <li class="" style="">If the value of the 'hash' attribute matches one of the processing application's supported hash functions, validate the verification string by doing the following:
          <ol start="" class="" style="">
            <li class="" style="">Send a service discovery information request to the generating entity.</li>
            <li class="" style="">Receive a service discovery information response from the generating entity.</li>
            <li class="" style="">If the response includes more than one service discovery identity with the same category/type/lang/name, consider the entire response to be ill-formed.</li>
            <li class="" style="">If the response includes more than one service discovery feature with the same XML character data, consider the entire response to be ill-formed.</li>
            <li class="" style="">If the response includes more than one extended service discovery information form with the same FORM_TYPE or the FORM_TYPE field contains more than one &lt;value/&gt; element with different XML character data, consider the entire response to be ill-formed.</li>
            <li class="" style="">If the response includes an extended service discovery information form where the FORM_TYPE field is not of type "hidden" or the form does not include a FORM_TYPE field, ignore the form but continue processing.</li>
            <li class="" style="">If the response is considered well-formed, reconstruct the hash by using the service discovery information response to generate a local hash in accordance with the <a href="#ver-gen">Generation Method</a>).</li>
            <li class="" style="">If the values of the received and reconstructed hashes match, the processing application MUST consider the result to be valid and SHOULD globally cache the result for all JabberIDs with which it communicates.</li>
            <li class="" style="">If the values of the received and reconstructed hashes do not match, the processing application MUST consider the result to be invalid and MUST NOT globally cache the verification string; however, it SHOULD check the service discovery identity and supported features of another generating entity who advertises that value.</li>
          </ol>
        </li>
      </ol>
    </div>
  <h2>6.
       <a name="usecases" id="usecases">Use Cases</a></h2>
    <div class="indent"><h3>6.1 <a name="advertise" id="advertise">Advertising Capabilities</a></h3>
      <p class="" style="">Each time a generating entity sends presence, it annotates that presence with an entity identifier ('node' attribute) and identity and feature identifier ('ver' attribute). So that servers can remember the last presence for use in responding to probes, a client SHOULD include entity capabilities with every presence notification it sends.</p>
      <p class="caption"><a name="example-1" id="example-1"></a>Example 1. Presence with caps</p><div class="indent"><pre>
&lt;presence&gt;
  &lt;c xmlns='http://jabber.org/protocol/caps'
     hash='sha-1'
     node='http://code.google.com/p/exodus'
     ver='SrFo9ar2CCk2EnOH4q4QANeuxLQ='/&gt;
&lt;/presence&gt;
      </pre></div>
       <p class="" style="">If the supported features change during a generating entity's presence session (e.g., a user installs an updated version of a client plugin), the application MUST recompute the verification string and SHOULD send a new presence broadcast.</p>
      <p class="caption"><a name="example-2" id="example-2"></a>Example 2. Presence with recomputed ver attribute</p><div class="indent"><pre>
&lt;presence&gt;
  &lt;c xmlns='http://jabber.org/protocol/caps'
     hash='sha-1'
     node='http://code.google.com/p/exodus'
     ver='66/0NaeaBKkwk85efJTGmU47vXI='/&gt;
&lt;/presence&gt;
      </pre></div>
    </div>

    <div class="indent"><h3>6.2 <a name="discover" id="discover">Discovering Capabilities</a></h3>
      <p class="" style="">An application (the "requesting entity") can learn what features another entity supports by sending a disco#info request (see <span class="ref">XEP-0030</span>) to the entity that generated the caps information (the "generating entity").</p>

      <p class="caption"><a name="example-3" id="example-3"></a>Example 3. Disco#info request</p><div class="indent"><pre>
&lt;iq from='juliet@capulet.lit/balcony' 
    id='disco1'
    to='romeo@montague.lit/orchard' 
    type='get'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'
         node='http://code.google.com/p/exodus#SrFo9ar2CCk2EnOH4q4QANeuxLQ='/&gt;
&lt;/iq&gt;
      </pre></div>

      <p class="" style="">The disco#info request is sent by the requesting entity to the generating entity. The value of the 'to' attribute MUST be the exact JID of the generating entity, which in the case of a client will be the full JID (&lt;localpart@domain.tld/resource&gt;).</p>

      <p class="" style="">The disco 'node' attribute MUST be included for backwards-compatibility. The value of the 'node' attribute SHOULD be generated by concatenating the value of the caps 'node' attribute (e.g., "http://code.google.com/p/exodus") as provided by the generating entity, the "#" character, and the value of the caps 'ver' attribute (e.g., "SrFo9ar2CCk2EnOH4q4QANeuxLQ=") as provided by the generating entity.</p>

      <p class="" style="">The generating entity then returns all of the capabilities it supports.</p>

      <p class="caption"><a name="example-4" id="example-4"></a>Example 4. Disco#info response</p><div class="indent"><pre>
&lt;iq from='romeo@montague.lit/orchard' 
    id='disco1'
    to='juliet@capulet.lit/balcony' 
    type='result'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'/&gt;
         node='http://code.google.com/p/exodus#SrFo9ar2CCk2EnOH4q4QANeuxLQ='&gt;
    &lt;identity category='client' type='pc'/&gt;
    &lt;feature var='http://jabber.org/protocol/disco#info'/&gt;
    &lt;feature var='http://jabber.org/protocol/disco#items'/&gt;
    &lt;feature var='http://jabber.org/protocol/muc'/&gt;
  &lt;/query&gt;
&lt;/iq&gt;
      </pre></div>

      <p class="" style="">Note: If the generating entity incorporated multiple identities with different xml:lang values in its verification string, it MUST return all of the identities even if the request specified a particular xml:lang.</p>

    </div>

    <div class="indent"><h3>6.3 <a name="stream" id="stream">Stream Feature</a></h3>
      <p class="" style="">A server MAY include its entity capabilities in a stream feature element so that connecting clients and peer servers do not need to send service discovery requests each time they connect.</p>
      <p class="caption"><a name="example-5" id="example-5"></a>Example 5. Stream feature element including capabilities</p><div class="indent"><pre>
&lt;stream:features&gt;
  &lt;c xmlns='http://jabber.org/protocol/caps'
     hash='sha-1'
     node='http://jabberd.org'
     ver='ItBTI0XLDFvVxZ72NQElAzKS9sU='&gt;
&lt;/stream:features&gt;
      </pre></div>
      <p class="" style="">When a connected client or peer server sends a service discovery information request to determine the entity capabilities of a server that advertises capabilities via the stream feature, the requesting entity MUST send the disco#info request to the server's JID as provided in the 'from' attribute of the response stream header (the 'from' attribute was recommended by <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc3920">RFC 3920</a></span>  [<a href="#nt-id2263078">20</a>] and is required by <span class="ref" style=""><a href="http://tools.ietf.org/html/draft-saintandre-rfc3920bis">rfc3920bis</a></span>  [<a href="#nt-id2263065">21</a>]). To enable this functionality, a server that advertises support for entity capabilities MUST provide a 'from' address in its response stream headers, in accordance with <span class="ref">rfc3920bis</span>.</p>
    </div>
  <h2>7.
       <a name="support" id="support">Determining Support</a></h2>
    <p class="" style="">If an entity supports the entity capabilities protocol, it MUST advertise that fact by returning a feature of <span class="strong">'http://jabber.org/protocol/caps'</span> in response to a service discovery information request.</p>
    <p class="caption"><a name="example-6" id="example-6"></a>Example 6. Service discovery information request</p><div class="indent"><pre>
&lt;iq from='romeo@montague.lit/orchard'
    id='disco2'
    to='juliet@capulet.lit/balcony'
    type='get'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="caption"><a name="example-7" id="example-7"></a>Example 7. Service discovery information response</p><div class="indent"><pre>
&lt;iq from='juliet@capulet.lit/balcony'
    id='disco2'
    to='romeo@montague.lit/orchard'
    type='result'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'&gt;
    ...
    &lt;feature var='http://jabber.org/protocol/caps'/&gt;
    ...
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If a server supports the <a href="#impl-optimize">Caps Optimization</a> functionality, it MUST also return a feature of <span class="strong">'http://jabber.org/protocol/caps#optimize'</span> in response to service discovery information requests.</p>
    <p class="caption"><a name="example-8" id="example-8"></a>Example 8. Service discovery information request</p><div class="indent"><pre>
&lt;iq from='juliet@capulet.lit/balcony'
    id='disco3'
    to='capulet.lit'
    type='get'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="caption"><a name="example-9" id="example-9"></a>Example 9. Service discovery information response</p><div class="indent"><pre>
&lt;iq from='capulet.lit'
    id='disco3'
    to='juliet@capulet.lit/balcony'
    type='result'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'&gt;
    ...
    &lt;feature var='http://jabber.org/protocol/caps#optimize'/&gt;
    ...
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>
  <h2>8.
       <a name="impl" id="impl">Implementation Notes</a></h2>
    <div class="indent"><h3>8.1 <a name="impl-hash" id="impl-hash">Hashing Algorithm Support</a></h3>
      <p class="" style="">An application SHOULD maintain a list of hashing algorithms it supports, which MUST include the algorithm or algorithms listed in the <a href="#security-mti">Mandatory-to-Implement Technologies</a> section of this document.</p>
    </div>
    <div class="indent"><h3>8.2 <a name="impl-cache" id="impl-cache">Caching</a></h3>
      <p class="" style="">It is RECOMMENDED for an application that processes entity capabilities information to cache associations between the verification string and discovered identity+features within the scope of one presence session. This obviates the need for extensive service discovery requests within a session.</p>
      <p class="" style="">It is RECOMMENDED for an application to cache associations across presence sessions, since this obviates the need for extensive service discovery requests at the beginning of a session (this is especially helpful in bandwidth-constrained environments).</p>
    </div>
    <div class="indent"><h3>8.3 <a name="impl-presence" id="impl-presence">Directed Presence</a></h3>
      <p class="" style="">If two entities exchange messages but they do not normally exchange presence (i.e., via presence subscription), the entities MAY choose to send directed presence to each other, where the presence information SHOULD be annotated with the same capabilities information as each entity sends in presence broadcasts. Until and unless capabilities information has been received from another entity, an application MUST assume that the other entity does not support capabilities.</p>
    </div>
    <div class="indent"><h3>8.4 <a name="impl-optimize" id="impl-optimize">Caps Optimization</a></h3>
      <p class="" style="">A server that is managing an connected client's presence session MAY optimize presence notification traffic sent through the server by stripping off redundant capabilities annotations. Because of this, receivers of presence notifications MUST NOT expect an annotation on every presence notification they receive. If the server performs caps optimization, it MUST ensure that the first presence notification each subscriber receives contains the annotation. The server MUST also ensure that any changes in the caps information (e.g., an updated 'ver' attribute) are sent to all subscribers.</p>
      <p class="" style="">If a connected client determines that its server supports caps optimization, it MAY choose to send the capabilities annotation only on the first presence packet, as well as whenever its capabilities change.</p>
    </div>
  <h2>9.
       <a name="security" id="security">Security Considerations</a></h2>
    <div class="indent"><h3>9.1 <a name="security-mti" id="security-mti">Mandatory-to-Implement Technologies</a></h3>
      <p class="" style="">The SHA-1 hashing algorithm is mandatory to implement. All implementations MUST support SHA-1.</p>
      <p class="" style="">An implementation MAY support other algorithms. Any such algorithm SHOULD be registered in the <span class="ref" style=""><a href="http://www.iana.org/assignments/hash-function-text-names">IANA Hash Function Textual Names Registry </a></span>  [<a href="#nt-id2263378">22</a>].</p>
      <p class="" style="">In the future, the <span class="ref" style=""><a href="http://www.xmpp.org/council/">XMPP Council</a></span>  [<a href="#nt-id2263413">23</a>] may, at its discretion, modify the mandatory-to-implement hashing algorithm if it determines that SHA-1 has become practically vulnerable to <a href="#security-preimage">Preimage Attacks</a>.</p>
    </div>
    <div class="indent"><h3>9.2 <a name="security-preimage" id="security-preimage">Preimage Attacks</a></h3>
      <p class="" style="">As described in <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc4270">RFC 4270</a></span>  [<a href="#nt-id2263467">24</a>], protocols that use the output of hash functions such as MD5 or SHA-1 can be vulnerable to collision attacks or preimage attacks or both. Because of how the hash output is used in entity capabilities, the protocol will not be subject to collision attacks even if the hash function used is found to be vulnerable to collision attacks. However, it is <span class="em">possible</span> that the protocol might become subject to preimage attacks if the hash function used is found to be vulnerable to preimage attacks.</p>
      <p class="" style="">In theory, such a preimage attack would take one of the following forms:</p>
      <ul class="" style="">
        <li class="" style="">Given knowledge of a particular value V of the 'ver' attribute, an attacker can find an input message X such that hash(X) yields V (this is known as a "first preimage attack").</li>
        <li class="" style="">Given knowledge of a particular value S used as the input message to the hash function, an attacker can find a value S' that yields V (this is known as a "second preimage attack").</li>
      </ul>
      <p class="" style="">In practice, a preimage attack would need to meet all of the following criteria in order to be effective against the entity capabilities protocol:</p>
      <ol start="" class="" style="">
        <li class="" style="">The hashing algorithm used would need to be found not only theoretically but practically vulnerable to first or second preimage attacks (e.g., this is not yet true of the MD5 or SHA-1 algorithms, but may become true in the future).</li>
        <li class="" style="">An attacker would need to find an input message X or S' that matches the hash V for a particular value of V or S, which may not be practical given that (a) the values of S used as input to the hash function in entity capabilities are relatively short and (b) cryptanalysis to date indicates that existing hash functions may not be vulnerable to preimage attacks except in the case of relatively long input messages (on the order of 2<span class="super" style="">55</span> blocks).</li>
        <li class="" style="">The input message X or S' would need to conform to the structure of S as specified under <a href="#ver">Verification String</a>, including the order of service discovery identity or identities followed by service discovery features, delimited by the '&lt;' character and sorted using "i;octet" collation.</li>
        <li class="" style="">The input messsage X or S' would need to make it seem as if a desirable feature (e.g., end-to-end encryption) is not supported by other entities that advertise the same hash V even though the feature is indeed supported (i.e., the attacker would need to return a set of service discovery identities and features that match X or S', and have that set be plausible for an entity that communicates via XMPP), or make it seem as if an undesirable feature is supported even though the feature is not supported.</li>
        <li class="" style="">The attacker would need to propagate the hash V before some other entity with the true input message S could broadcast presence with the relevant entity capabilities data and provide the true service discovery response (thus the attacker might need to subvert the development process of a particular software project or subvert the namespace issuance process of the <span class="ref" style=""><a href="http://www.xmpp.org/registrar/">XMPP Registrar</a></span>  [<a href="#nt-id2263645">25</a>], or both).</li>
      </ol>
      <p class="" style="">It currently seems extremely unlikely that an attacker could meet all of the foregoing conditions in the foreseeable future. However, the XMPP Council shall continue to monitor the state of cryptanalysis regarding the mandatory-to-implement hash function as well as the possibility that any vulnerabilities in that function might lead to practical threats against the entity capabilities protocol. If and when it becomes practical (or even possible) to launch effective preimage attacks against the entity capabilities protocol, the XMPP Council shall consider updating this specification to change the mandatory-to-implement hashing algorithm to a safer technology.</p>
    </div>
    <div class="indent"><h3>9.3 <a name="security-poisoning" id="security-poisoning">Caps Poisoning</a></h3>
      <p class="" style="">Adherence to the method defined in the <a href="#ver">Verification String</a> section of this document for both generation and processing of the 'ver' attribute helps to guard against poisoning of entity capabilities information by malicious or improperly implemented entities.</p>
      <p class="" style="">If the value of the 'ver' attribute is a verification string as defined herein (i.e., if the 'ver' attribute is not generated according to the <a href="#legacy">Legacy Format</a>), inclusion of the 'hash' attribute is REQUIRED. Knowing explicitly that the value of the 'ver' attribute is a verification string enables the recipient to avoid spurious notification of invalid or poisoned hashes.</p>
    </div>
    <div class="indent"><h3>9.4 <a name="security-exposure" id="security-exposure">Information Exposure</a></h3>
      <p class="" style="">Use of entity capabilities might make it easier for an attacker to launch certain application-specific attacks, since the attacker could more easily determine the type of client being used as well as its capabilities. However, since most clients respond to Service Discovery and Software Version requests without performing access control checks, there is no new vulnerability. Entities that wish to restrict access to capabilities information SHOULD use <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0016.html">Server-Based Privacy Rules</a></span>  [<a href="#nt-id2263767">26</a>] to define appropriate communications blocking (e.g., an entity MAY choose to allow IQ requests only from "trusted" entities, such as those with whom it has a presence subscription of "both"); note, however, that such restrictions may be incompatible with the recommendation regarding <a href="#directed">Directed Presence</a>.</p>
    </div>
  <h2>10.
       <a name="iana" id="iana">IANA Considerations</a></h2>
    <p class="" style="">This document requires no interaction with the <span class="ref" style=""><a href="http://www.iana.org/">Internet Assigned Numbers Authority (IANA)</a></span>  [<a href="#nt-id2263830">27</a>]. </p>
  <h2>11.
       <a name="registrar" id="registrar">XMPP Registrar Considerations</a></h2>
    <div class="indent"><h3>11.1 <a name="ns" id="ns">Protocol Namespaces</a></h3>
    <p class="" style="">The <span class="ref" style=""><a href="http://www.xmpp.org/registrar/">XMPP Registrar</a></span>  [<a href="#nt-id2263868">28</a>] includes 'http://jabber.org/protocol/caps' in its registry of protocol namespaces  (see &lt;<a href="http://www.xmpp.org/registrar/namespaces.html">http://www.xmpp.org/registrar/namespaces.html</a>&gt;).</p>
    </div>
    <div class="indent"><h3>11.2 <a name="registrar-features" id="registrar-features">Service Discovery Features</a></h3>
      <p class="" style="">The XMPP Registrar shall include "http://jabber.org/protocol/caps#optimize" in its registry of service discovery features (see &lt;<a href="http://www.xmpp.org/registrar/disco-features.html">http://www.xmpp.org/registrar/disco-features.html</a>&gt;).</p>
    </div>
  <h2>12.
       <a name="schema" id="schema">XML Schema</a></h2>
    <p class="caption"></p><div class="indent"><pre>
&lt;?xml version='1.0' encoding='UTF-8'?&gt;

&lt;xs:schema
    xmlns:xs='http://www.w3.org/2001/XMLSchema'
    targetNamespace='http://jabber.org/protocol/caps'
    xmlns='http://jabber.org/protocol/caps'
    elementFormDefault='qualified'&gt;

  &lt;xs:annotation&gt;
    &lt;xs:documentation&gt;
      The protocol documented by this schema is defined in
      XEP-0115: http://www.xmpp.org/extensions/xep-0115.html
    &lt;/xs:documentation&gt;
  &lt;/xs:annotation&gt;

  &lt;xs:element name='c'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='empty'&gt;
          &lt;xs:attribute name='ext' type='xs:NMTOKENS' use='optional'/&gt;
          &lt;xs:attribute name='hash' type='xs:NMTOKEN' use='required'/&gt;
          &lt;xs:attribute name='node' type='xs:string' use='required'/&gt;
          &lt;xs:attribute name='ver' type='xs:string' use='required'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:simpleType name='empty'&gt;
    &lt;xs:restriction base='xs:string'&gt;
      &lt;xs:enumeration value=''/&gt;
    &lt;/xs:restriction&gt;
  &lt;/xs:simpleType&gt;

&lt;/xs:schema&gt;
    </pre></div>
  <h2>13.
       <a name="legacy" id="legacy">Legacy Format</a></h2>
    <p class="" style="">Before Version 1.4 of this specification, the 'ver' attribute was generated differently, the 'ext' attribute was used more extensively, and the 'hash' attribute was absent. For historical purposes, Version 1.3 of this specification is archived at &lt;<a href="http://www.xmpp.org/extensions/attic/xep-0115-1.3.html">http://www.xmpp.org/extensions/attic/xep-0115-1.3.html</a>&gt;. For backwards-compatibility with the legacy format, the 'node' attribute is REQUIRED and the 'ext' attribute MAY be included.</p>
    <p class="" style="">An application can determine if the legacy format is in use by checking for the presence of the 'hash' attribute, which is REQUIRED in the current format.</p>
    <p class="" style="">If a caps-processing application supports the legacy format, it SHOULD check the 'node', 'ver', and 'ext' combinations as specified in the archived version 1.3 of this specification, and MAY cache the results.</p>
    <p class="" style="">If a caps-processing application does not support the legacy format, it SHOULD ignore the 'ver' value entirely (since the value cannot be verified) and SHOULD NOT cache it, since the application cannot validate the identity and features by checking the hash.</p>
  <h2>14.
       <a name="ack" id="ack">Acknowledgements</a></h2>
    <p class="" style="">Thanks to Rachel Blackman, Dave Cridland, Richard Dobson, Olivier Goffart, Sergei Golovan, Justin Karneges, Ralph Meijer, Ian Paterson, Kevin Smith, Tomasz Sterna, Michal Vaner, and Matt Yacobucci for comments and suggestions.</p>
  <hr /><h2><a name="notes" id="notes"></a>Notes</h2><div class="indent"><p><a name="nt-id2251582" id="nt-id2251582">1</a>. XEP-0071: XHTML-IM &lt;<a href="http://www.xmpp.org/extensions/xep-0071.html">http://www.xmpp.org/extensions/xep-0071.html</a>&gt;.</p><p><a name="nt-id2261178" id="nt-id2261178">2</a>. XEP-0166: Jingle &lt;<a href="http://www.xmpp.org/extensions/xep-0166.html">http://www.xmpp.org/extensions/xep-0166.html</a>&gt;.</p><p><a name="nt-id2261203" id="nt-id2261203">3</a>. XEP-0167: Jingle Audio via RTP &lt;<a href="http://www.xmpp.org/extensions/xep-0167.html">http://www.xmpp.org/extensions/xep-0167.html</a>&gt;.</p><p><a name="nt-id2261230" id="nt-id2261230">4</a>. XEP-0096: SI File Transfer &lt;<a href="http://www.xmpp.org/extensions/xep-0096.html">http://www.xmpp.org/extensions/xep-0096.html</a>&gt;.</p><p><a name="nt-id2261258" id="nt-id2261258">5</a>. XEP-0060: Publish-Subscribe &lt;<a href="http://www.xmpp.org/extensions/xep-0060.html">http://www.xmpp.org/extensions/xep-0060.html</a>&gt;.</p><p><a name="nt-id2261295" id="nt-id2261295">6</a>. XEP-0030: Service Discovery &lt;<a href="http://www.xmpp.org/extensions/xep-0030.html">http://www.xmpp.org/extensions/xep-0030.html</a>&gt;.</p><p><a name="nt-id2261321" id="nt-id2261321">7</a>. XEP-0092: Software Version &lt;<a href="http://www.xmpp.org/extensions/xep-0092.html">http://www.xmpp.org/extensions/xep-0092.html</a>&gt;.</p><p><a name="nt-id2261274" id="nt-id2261274">8</a>. Entity capabilities is not limited to clients, and can be used by any entity that exchanges presence with another entity, e.g., a gateway. However, this specification mainly uses the example of clients.</p><p><a name="nt-id2261494" id="nt-id2261494">9</a>. XEP-0045: Multi-User Chat &lt;<a href="http://www.xmpp.org/extensions/xep-0045.html">http://www.xmpp.org/extensions/xep-0045.html</a>&gt;.</p><p><a name="nt-id2261696" id="nt-id2261696">10</a>. RFC 3920: Extensible Messaging and Presence Protocol (XMPP): Core &lt;<a href="http://tools.ietf.org/html/rfc3920">http://tools.ietf.org/html/rfc3920</a>&gt;.</p><p><a name="nt-id2261720" id="nt-id2261720">11</a>. RFC 3921: Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence &lt;<a href="http://tools.ietf.org/html/rfc3921">http://tools.ietf.org/html/rfc3921</a>&gt;.</p><p><a name="nt-id2261734" id="nt-id2261734">12</a>. These first two requirements effectively eliminated <span class="ref">XEP-0060</span> as a possible implementation of entity capabilities.</p><p><a name="nt-id2262060" id="nt-id2262060">13</a>. RFC 4790: Internet Application Protocol Collation Registry &lt;<a href="http://tools.ietf.org/html/rfc4790">http://tools.ietf.org/html/rfc4790</a>&gt;.</p><p><a name="nt-id2262085" id="nt-id2262085">14</a>. A registry of service discovery identities is located at &lt;<a href="http://www.xmpp.org/registrar/disco-categories.html">http://www.xmpp.org/registrar/disco-categories.html</a>&gt;.</p><p><a name="nt-id2262122" id="nt-id2262122">15</a>. A registry of service discovery features is located at &lt;<a href="http://www.xmpp.org/registrar/disco-features.html">http://www.xmpp.org/registrar/disco-features.html</a>&gt;.</p><p><a name="nt-id2262279" id="nt-id2262279">16</a>. RFC 3269: UTF-8, a transformation format of ISO 10646 &lt;<a href="http://tools.ietf.org/html/rfc3269">http://tools.ietf.org/html/rfc3269</a>&gt;.</p><p><a name="nt-id2262313" id="nt-id2262313">17</a>. RFC 3174: US Secure Hash Algorithm 1 (SHA1) &lt;<a href="http://tools.ietf.org/html/rfc3174">http://tools.ietf.org/html/rfc3174</a>&gt;.</p><p><a name="nt-id2262342" id="nt-id2262342">18</a>. RFC 4648: The Base16, Base32, and Base64 Data Encodings &lt;<a href="http://tools.ietf.org/html/rfc4648">http://tools.ietf.org/html/rfc4648</a>&gt;.</p><p><a name="nt-id2262293" id="nt-id2262293">19</a>. The OpenSSL command for producing such output with SHA-1 is "echo -n 'S' | openssl dgst -binary -sha1 | openssl enc -nopad -base64".</p><p><a name="nt-id2263078" id="nt-id2263078">20</a>. RFC 3920: Extensible Messaging and Presence Protocol (XMPP): Core &lt;<a href="http://tools.ietf.org/html/rfc3920">http://tools.ietf.org/html/rfc3920</a>&gt;.</p><p><a name="nt-id2263065" id="nt-id2263065">21</a>. rfc3920bis: proposed revisions to Extensible Messaging and Presence Protocol (XMPP): Core &lt;<a href="http://tools.ietf.org/html/draft-saintandre-rfc3920bis">http://tools.ietf.org/html/draft-saintandre-rfc3920bis</a>&gt;. (work in progress)</p><p><a name="nt-id2263378" id="nt-id2263378">22</a>. IANA registry of Hash Function Textual Names &lt;<a href="http://www.iana.org/assignments/hash-function-text-names">http://www.iana.org/assignments/hash-function-text-names</a>&gt;.</p><p><a name="nt-id2263413" id="nt-id2263413">23</a>. The XMPP Council is a technical steering committee, authorized by the XSF Board of Directors and elected by XSF members, that approves of new XMPP Extensions Protocols and oversees the XSF's standards process. For further information, see &lt;<a href="http://www.xmpp.org/council/">http://www.xmpp.org/council/</a>&gt;.</p><p><a name="nt-id2263467" id="nt-id2263467">24</a>. RFC 4270: Attacks on Cryptographic Hashes in Internet Protocols &lt;<a href="http://tools.ietf.org/html/rfc4270">http://tools.ietf.org/html/rfc4270</a>&gt;.</p><p><a name="nt-id2263645" id="nt-id2263645">25</a>. The XMPP Registrar maintains a list of reserved protocol namespaces as well as registries of parameters used in the context of XMPP extension protocols approved by the XMPP Standards Foundation. For further information, see &lt;<a href="http://www.xmpp.org/registrar/">http://www.xmpp.org/registrar/</a>&gt;.</p><p><a name="nt-id2263767" id="nt-id2263767">26</a>. XEP-0016: Server-Based Privacy Rules &lt;<a href="http://www.xmpp.org/extensions/xep-0016.html">http://www.xmpp.org/extensions/xep-0016.html</a>&gt;.</p><p><a name="nt-id2263830" id="nt-id2263830">27</a>. The Internet Assigned Numbers Authority (IANA) is the central coordinator for the assignment of unique parameter values for Internet protocols, such as port numbers and URI schemes. For further information, see &lt;<a href="http://www.iana.org/">http://www.iana.org/</a>&gt;.</p><p><a name="nt-id2263868" id="nt-id2263868">28</a>. The XMPP Registrar maintains a list of reserved protocol namespaces as well as registries of parameters used in the context of XMPP extension protocols approved by the XMPP Standards Foundation. For further information, see &lt;<a href="http://www.xmpp.org/registrar/">http://www.xmpp.org/registrar/</a>&gt;.</p></div><hr /><h2><a name="revs" id="revs"></a>Revision History</h2><div class="indent"><h4>Version 1.5 (2008-02-26)</h4><div class="indent">
        <ul class="" style="">
          <li class="" style="">Defined SHA-1 as mandatory to implement</li>
          <li class="" style="">Specified that inclusion of hash attribute is required</li>
          <li class="" style="">Defined the nature of possible preimage attacks</li>
          <li class="" style="">More clearly specified security considerations</li>
          <li class="" style="">More clearly specified implementation notes</li>
          <li class="" style="">Modified generation method to incorporate service discovery extensions</li>
          <li class="" style="">More clearly specified processing method</li>
          <li class="" style="">Clarified meaning and construction of caps node attribute and disco node attribute</li>
          <li class="" style="">Specified that node attribute shall be included in disco#info request for backwards-compatibility</li>
          <li class="" style="">Clarified handling of the legacy format to assist developers</li>
          <li class="" style="">Added service discovery feature for caps optimization to prevent confusion regarding server support of caps vs. caps optimization</li>
        </ul>
       (jjh/psa)
    </div><h4>Version 1.4 (2007-08-13)</h4><div class="indent"><p class="" style="">In response to persistent security concerns over caps poisoning, redefined ver attribute to be a hash of the service discovery identity and features in a way that is backwards-compatible with the legacy format.</p> (psa/jk/jjh)
    </div><h4>Version 1.3 (2007-04-10)</h4><div class="indent"><p class="" style="">Added developer-friendly introduction; specified that ext names must be stable across application versions; further clarified examples; added stream feature use case; removed message example (send directed presence instead).</p> (psa/rt/jjh)
    </div><h4>Version 1.2 (2007-02-15)</h4><div class="indent"><p class="" style="">Clarified motivation and handling of service discovery requests.</p> (psa)
    </div><h4>Version 1.1 (2004-10-29)</h4><div class="indent"><p class="" style="">Clarified meaning of service discovery results for client#ver and client#ext.</p> (psa)
    </div><h4>Version 1.0 (2004-08-01)</h4><div class="indent"><p class="" style="">Per a vote of the Jabber Council, advanced status to Draft.</p> (psa)
    </div><h4>Version 0.7 (2004-06-29)</h4><div class="indent"><p class="" style="">Added several items to the Security Considerations; clarified naming requirements regarding 'node', 'ver', and 'ext' attributes.</p> (jjh/psa)
    </div><h4>Version 0.6 (2004-04-25)</h4><div class="indent"><p class="" style="">Made a number of editorial adjustments.</p> (psa)
    </div><h4>Version 0.5 (2004-01-05)</h4><div class="indent"><p class="" style="">Specified that the protocol can be used whenever presence is used (e.g., by gateways); improved the XML schema; made several editorial adjustments.</p> (psa)
    </div><h4>Version 0.4 (2003-09-04)</h4><div class="indent"><p class="" style="">IQ eets must be to a resource, since they are intended to go to a particular session.</p> (jjh)
    </div><h4>Version 0.3 (2003-09-02)</h4><div class="indent"><p class="" style="">Servers MUST strip extras changed to MAY, due to implementer feedback.</p> (jjh)
    </div><h4>Version 0.2 (2003-08-28)</h4><div class="indent"><p class="" style="">Add more clarifying assumptions and requirements, make it clear that clients don't have to send capabilities every time if the server is optimizing.</p> (jjh)
    </div><h4>Version 0.1 (2003-08-27)</h4><div class="indent"><p class="" style="">Initial version.</p> (jjh)
    </div></div><hr /><p>END</p></body></html>
