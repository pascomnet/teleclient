<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>XEP-0200: Stanza Encryption</title><link rel="stylesheet" type="text/css" href="/xmpp.css" /><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" /><meta name="DC.Title" content="Stanza Encryption" /><meta name="DC.Creator" content="Ian Paterson" /><meta name="DC.Description" content="This document specifies an XMPP protocol extension for session-based stanza encryption." /><meta name="DC.Publisher" content="XMPP Standards Foundation" /><meta name="DC.Contributor" content="XMPP Extensions Editor" /><meta name="DC.Date" content="2007-05-30" /><meta name="DC.Type" content="XMPP Extension Protocol" /><meta name="DC.Format" content="XHTML" /><meta name="DC.Identifier" content="XEP-0200" /><meta name="DC.Language" content="en" /><meta name="DC.Rights" content="This XMPP Extension Protocol is copyright (c) 1999 - 2008 by the XMPP Standards Foundation (XSF)." /></head><body><h1>XEP-0200: Stanza Encryption</h1><p>This document specifies an XMPP protocol extension for session-based stanza encryption.</p><hr /><p style="color:red">WARNING: This Standards-Track document is Experimental. Publication as an XMPP Extension Protocol does not imply approval of this proposal by the XMPP Standards Foundation. Implementation of the protocol described herein is encouraged in exploratory implementations, but production systems should not deploy implementations of this protocol until it advances to a status of Draft.</p><hr /><h2>Document Information</h2><p class="indent">
            Series: <a href="http://www.xmpp.org/extensions/">XEP</a><br />
            Number: 0200<br />
            Publisher: <a href="/xsf/">XMPP Standards Foundation</a><br />
            Status: 
            <a href="http://www.xmpp.org/extensions/xep-0001.html#states-Experimental">Experimental</a><br />
            Type:
            <a href="http://www.xmpp.org/extensions/xep-0001.html#types-Standards Track">Standards Track</a><br />
            Version: 0.2<br />
            Last Updated: 2007-05-30<br />
                Approving Body: <a href="http://www.xmpp.org/council/">XMPP Council</a><br />Dependencies: XMPP Core, XMPP IM, RFC 2104, RFC 3548<br />
                Supersedes: None<br />
                Superseded By: None<br />
            Short Name: TO BE ASSIGNED<br />
              Wiki Page: &lt;<a href="http://wiki.jabber.org/index.php/Stanza Encryption (XEP-0200)">http://wiki.jabber.org/index.php/Stanza Encryption (XEP-0200)</a>&gt;
            </p><hr /><h2>Author Information</h2><div class="indent"><h3>Ian Paterson</h3><p class="indent">
        Email:
        <a href="mailto:ian.paterson@clientside.co.uk">ian.paterson@clientside.co.uk</a><br />
        JabberID: 
        <a href="xmpp:ian@zoofy.com">ian@zoofy.com</a><br /></p></div><hr /><h2>Legal Notices</h2><div class="indent"><h3>Copyright</h3>This XMPP Extension Protocol is copyright (c) 1999 - 2008 by the XMPP Standards Foundation (XSF).<h3>Permissions</h3>Permission is hereby granted, free of charge, to any person obtaining a copy of this specification (the "Specification"), to make use of the Specification without restriction, including without limitation the rights to implement the Specification in a software program, deploy the Specification in a network service, and copy, modify, merge, publish, translate, distribute, sublicense, or sell copies of the Specification, and to permit persons to whom the Specification is furnished to do so, subject to the condition that the foregoing copyright notice and this permission notice shall be included in all copies or substantial portions of the Specification. Unless separate permission is granted, modified works that are redistributed shall not contain misleading information regarding the authors, title, number, or publisher of the Specification, and shall not claim endorsement of the modified works by the authors, any organization or project to which the authors belong, or the XMPP Standards Foundation.<h3>Disclaimer of Warranty</h3><span style="font-weight: bold">## NOTE WELL: This Specification is provided on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or implied, including, without limitation, any warranties or conditions of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A PARTICULAR PURPOSE. In no event shall the XMPP Standards Foundation or the authors of this Specification be liable for any claim, damages, or other liability, whether in an action of contract, tort, or otherwise, arising from, out of, or in connection with the Specification or the implementation, deployment, or other use of the Specification. ##</span><h3>Limitation of Liability</h3>In no event and under no legal theory, whether in tort (including negligence), contract, or otherwise, unless required by applicable law (such as deliberate and grossly negligent acts) or agreed to in writing, shall the XMPP Standards Foundation or any author of this Specification be liable for damages, including any direct, indirect, special, incidental, or consequential damages of any character arising out of the use or inability to use the Specification (including but not limited to damages for loss of goodwill, work stoppage, computer failure or malfunction, or any and all other commercial damages or losses), even if the XMPP Standards Foundation or such author has been advised of the possibility of such damages.<h3>IPR Conformance</h3>This XMPP Extension Protocol has been contributed in full conformance with the XSF's Intellectual Property Rights Policy (a copy of which may be found at &lt;<a href="http://www.xmpp.org/extensions/ipr-policy.shtml">http://www.xmpp.org/extensions/ipr-policy.shtml</a>&gt; or obtained by writing to XSF, P.O. Box 1641, Denver, CO 80201 USA).</div><hr /><h2>Discussion Venue</h2><p class="indent">The preferred venue for discussion of this document is the Standards discussion list: &lt;<a href="http://mail.jabber.org/mailman/listinfo/standards">http://mail.jabber.org/mailman/listinfo/standards</a>&gt;.</p><p class="indent">Given that this XMPP Extension Protocol normatively references IETF technologies, discussion on the XSF-IETF list may also be appropriate (see &lt;<a href="http://mail.jabber.org/mailman/listinfo/jsf-ietf">http://mail.jabber.org/mailman/listinfo/jsf-ietf</a>&gt; for details).</p><p class="indent">Errata may be sent to &lt;<a href="mailto:editor@xmpp.org">editor@xmpp.org</a>&gt;.</p><h2>Relation to XMPP</h2><p class="indent">The Extensible Messaging and Presence Protocol (XMPP) is defined in the XMPP Core (RFC 3920) and XMPP IM (RFC 3921) specifications contributed by the XMPP Standards Foundation to the Internet Standards Process, which is managed by the Internet Engineering Task Force in accordance with RFC 2026. Any protocol defined in this document has been developed outside the Internet Standards Process and is to be understood as an extension to XMPP rather than as an evolution, development, or modification of XMPP itself.</p><h2>Conformance Terms</h2><p class="indent">The following keywords as used in this document are to be interpreted as described in <a href="http://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>: "MUST", "SHALL", "REQUIRED"; "MUST NOT", "SHALL NOT"; "SHOULD", "RECOMMENDED"; "SHOULD NOT", "NOT RECOMMENDED"; "MAY", "OPTIONAL".</p><hr /><h2>Table of Contents</h2><div class="indent"><p><br />1.  <a href="#intro">Introduction</a><br />2.  <a href="#require">Requirements</a><br />3.  <a href="#personae">Dramatis Personae</a><br />4.  <a href="#assume">Assumptions</a><br />5.  <a href="#content">Encryptable Content</a><br />6.  <a href="#encrypt">Encrypting a Stanza</a><br />7.  <a href="#send">Sending an Encrypted Stanza</a><br />8.  <a href="#decrypt">Decrypting a Stanza</a><br />9.  <a href="#rekey">Re-Key Exchange</a><br />   
      9.1.  <a href="#rekey-intro">Introduction</a><br />   
      9.2.  <a href="#rekey-init">Re-Key Initiation</a><br />   
      9.3.  <a href="#rekey-accept">Re-Key Acceptance</a><br />10.  <a href="#publish">Publishing Old MAC Values</a><br />11.  <a href="#sec">Security Considerations</a><br />   
      11.1.  <a href="#sec-prng">Random Numbers</a><br />   
      11.2.  <a href="#sec-storage">Storage</a><br />   
      11.3.  <a href="#sec-replay">Replay Attacks</a><br />   
      11.4.  <a href="#sec-life">Maximum Key Life</a><br />   
      11.5.  <a href="#sec-general">Extra Responsabilities of Implementors</a><br />12.  <a href="#iana">IANA Considerations</a><br />13.  <a href="#registrar">XMPP Registrar Considerations</a><br />   
      13.1.  <a href="#ns">Protocol Namespaces</a><br />14.  <a href="#schema">XML Schemas</a><br /><a href="#notes">Notes</a><br /><a href="#revs">Revision History</a></p></div><hr /><h2>1.
       <a name="intro" id="intro">Introduction</a></h2>
  <p class="" style="">End-to-end encryption is a desirable feature for any communication technology. Ideally, such a technology would design encryption in from the beginning and would forbid unencrypted communications. Realistically, most communication technologies have not been designed in that manner, and Jabber/XMPP technologies are no exception. In particular, the original Jabber technologies developed in 1999 did not include end-to-end encryption by default. PGP-based encryption of message bodies and signing of presence information was added as an extension to the core protocols in the year 2000; this extension is documented in <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0027.html">Current Jabber OpenPGP Usage</a></span>  [<a href="#nt-id2252617">1</a>]. When the core protocols were formalized within the Internet Standards Process by the IETF's XMPP Working Group in 2003 (see <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc3920">RFC 3920</a></span>  [<a href="#nt-id2252642">2</a>] and <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc3921">RFC 3921</a></span>  [<a href="#nt-id2252666">3</a>]), a different extension was defined using S/MIME-based signing and encryption of CPIM-formatted messages (see <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc3862">RFC 3862</a></span>  [<a href="#nt-id2252691">4</a>]) and PIDF-formatted presence information (see <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc3863">RFC 3863</a></span>  [<a href="#nt-id2252715">5</a>]); this extension is specified in <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc3923">RFC 3923</a></span>  [<a href="#nt-id2252739">6</a>].</p>
  <p class="" style="">For reasons described in <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0210.html">Requirements for Encrypted Sessions</a></span>  [<a href="#nt-id2251307">7</a>], the foregoing proposals (and others not mentioned) have not been widely implemented and deployed. This is unfortunate, since an open communication protocol needs to enable end-to-end encryption in order to be seriously considered for deployment by a broad range of users.</p>
  <p class="" style="">This document describes a different session-based approach to the end-to-end encryption of the full content of XMPP stanzas sent between two entities. The protocol assumes that the encrypted session parameters (initial keys, counters and algorithms etc.) have already been agreed, typically through a negotiation protocol such as <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0116.html">Encrypted Session Negotiation</a></span>  [<a href="#nt-id2251347">8</a>], <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0217.html">Simplified Encrypted Session Negotiation</a></span>  [<a href="#nt-id2251372">9</a>] or <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0187.html">Offline Encrypted Sessions</a></span>  [<a href="#nt-id2251398">10</a>]. The session approach when combined with short-lived keys offers many important advantages over the existing "Object Encryption" proposals, including Perfect Forward Secrecy and Identity Protection.</p>
<h2>2.
       <a name="require" id="require">Requirements</a></h2>
  <p class="" style="">The requirements and the consequent cryptographic design that underpin this protocol and its associated protocols are described in <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0210.html">Requirements for Encrypted Sessions</a></span>  [<a href="#nt-id2251425">11</a>] and <span class="ref">Cryptographic Design of Encrypted Sessions</span>. The specific objectives of this protocol include:</p>
  <ul class="" style="">
    <li class="" style=""><p class="" style="">Encryption of the full stanza content (except that which is required for stanza routing)</p></li>
    <li class="" style=""><p class="" style="">Minimise the Perfect Forward Secrecy window by enabling light-weight renegotiation of the short-term keys without requiring a full session renegotiation.</p></li>
    <li class="" style=""><p class="" style="">Minimise bandwidth overhead</p></li>
    <li class="" style=""><p class="" style="">No dependence on XML canonicalization</p></li>
  </ul>
<h2>3.
       <a name="personae" id="personae">Dramatis Personae</a></h2>
  <p class="" style="">This document introduces two characters to help the reader follow the necessary exchanges:</p>
  <ol start="1" class="" style="">
    <li class="" style="">"Alice" is the name of the entity sending the encrypted stanza or initiating a re-key. Within the scope of this document, we stipulate that her fully-qualified JID is: &lt;alice@example.org/pda&gt;.</li>
    <li class="" style="">"Bob" is the name of the entity receiving the encrypted stanza or accepting a re-key. Within the scope of this document, his fully-qualified JID is: &lt;bob@example.com/laptop&gt;.</li>
  </ol>
  <p class="" style="">While Alice and Bob are introduced as "end users", they are simply meant to be examples of XMPP entities. Any directly addressable XMPP entity may send or receive encrypted stanzas within an encrypted session or initiate a re-key.</p>
  <p class="" style="">Here we assume that Alice and Bob have already established an encrypted session. Either Alice or Bob MAY send encrypted stanzas within the encrypted session or initiate a re-key. The following sections describe the process where Alice sends Bob an encrypted stanza and initiates a re-key.</p>
<h2>4.
       <a name="assume" id="assume">Assumptions</a></h2>
  <p class="" style="">The following sections assume that the parameters in the tables below have already been agreed. For more details refer to an encrypted session negotiation protocol such as <span class="ref">Encrypted Session Negotiation</span>.</p>
  <p class="caption"><a name="table-1" id="table-1"></a>Table 1: Encryption Parameters</p><table border="1" cellpadding="3" cellspacing="0">
    <tr class="body">
      <th colspan="" rowspan="">Parameter</th>
      <th colspan="" rowspan="">Description</th>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">C<span class="sub" style="">A</span>, C<span class="sub" style="">B</span></td>
      <td colspan="" rowspan="">The initial block cipher counter value for blocks sent by Alice and Bob</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">KC<span class="sub" style="">A</span>, KC<span class="sub" style="">B</span></td>
      <td colspan="" rowspan="">The initial secret cipher keys that Alice and Bob use to encrypt</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">KM<span class="sub" style="">A</span>, KM<span class="sub" style="">B</span></td>
      <td colspan="" rowspan="">The initial secret MAC keys that Alice and Bob use to protect the integrity of encrypted data</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">HASH</td>
      <td colspan="" rowspan="">Agreed hash algorithm</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">CIPHER, DECIPHER</td>
      <td colspan="" rowspan="">Agreed CTR-mode block cipher algorithm</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">COMPRESS, DECOMPRESS</td>
      <td colspan="" rowspan="">Agreed compression algorithm</td>
    </tr>
  </table>
  <p class="caption"><a name="table-2" id="table-2"></a>Table 2: Re-Key Parameters</p><table border="1" cellpadding="3" cellspacing="0">
    <tr class="body">
      <th colspan="" rowspan="">Parameter</th>
      <th colspan="" rowspan="">Description</th>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">g</td>
      <td colspan="" rowspan="">Diffie-Hellman generator</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">p</td>
      <td colspan="" rowspan="">Diffie-Hellman prime</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">e, d</td>
      <td colspan="" rowspan="">Alice and Bob's initial public Diffie-Hellman keys</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">x, y</td>
      <td colspan="" rowspan="">*Alice and Bob's initial private Diffie-Hellman keys</td>
    </tr>
  </table>
  <p class="" style="">* x and y MUST be known only to Alice and Bob respectively, all other parameters MUST be known by both parties</p>
  <p class="" style="">All parameters except the algorithms are multi-precision integers, so implementations will need a Big Integer Math library to perform the necessary modular arithmetic. Note: A simple HMAC function and a cryptographic-strength pseudo-random number generator are also required, but no other cryptographic code is necessary.</p>
<h2>5.
       <a name="content" id="content">Encryptable Content</a></h2>
  <p class="" style="">Alice MAY use this protocol to encrypt only that part of the <span class="em">content</span> of one-to-one &lt;message/&gt;, &lt;presence/&gt; and &lt;iq/&gt; stanzas that would normally be ignored by the intermediate servers. She MUST NOT encrypt:</p>
  <ul class="" style="">
    <li class="" style=""><p class="" style="">Stanza wrapper element tags (only stanza content)</p></li>
    <li class="" style=""><p class="" style="">&lt;error/&gt; elements  [<a href="#nt-id2261406">12</a>]</p></li>
    <li class="" style=""><p class="" style="">&lt;defined-condition xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt; child elements of &lt;error/&gt; elements.  [<a href="#nt-id2261428">13</a>]</p></li>
    <li class="" style=""><p class="" style="">&lt;thread/&gt; elements  [<a href="#nt-id2261451">14</a>]</p></li>
    <li class="" style=""><p class="" style="">&lt;amp/&gt; elements (see <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0079.html">Advanced Message Processing</a></span>  [<a href="#nt-id2261495">15</a>])</p></li>
  </ul>
  <p class="" style="">A stanza MUST NOT contain more than one &lt;c xmlns='http://www.xmpp.org/extensions/xep-0200.html#ns'/&gt; element, and it MUST be an immediate child of the stanza wrapper element. There is only one exception to those two rules, if the stanza is type 'error' then its &lt;error/&gt; child element MAY also contain a &lt;c xmlns='http://www.xmpp.org/extensions/xep-0200.html#ns'/&gt; element.</p>
  <p class="caption"><a name="example-1" id="example-1"></a>Example 1. Plain Message Stanza</p><div class="indent"><pre>
&lt;message from='alice@example.org/pda'
         to='bob@example.com/laptop'
         type='chat'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;body&gt;Hello, Bob!&lt;/body&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'&gt;
    &lt;rule action='error' condition='match-resource' value='exact'/&gt;
  &lt;/amp&gt;
  &lt;active xmlns='http://jabber.org/protocol/chatstates'/&gt;
&lt;/message&gt;
  </pre></div>

  <p class="caption"><a name="example-2" id="example-2"></a>Example 2. Message Content to be Encrypted</p><div class="indent"><pre>
&lt;body&gt;Hello, Bob!&lt;/body&gt;
&lt;active xmlns='http://jabber.org/protocol/chatstates'/&gt;
  </pre></div>

  <p class="caption"><a name="example-3" id="example-3"></a>Example 3. Plain Presence Stanza</p><div class="indent"><pre>
&lt;presence from='alice@example.org/pda'
          to='bob@example.com/laptop'
          type='available'&gt;
  &lt;show&gt;dnd&lt;/show&gt;
  &lt;status&gt;Working&lt;/status&gt;
  &lt;c xmlns='http://jabber.org/protocol/caps'
     node='http://exodus.jabberstudio.org/caps'
     ver='0.9'
     ext='jingle ftrans xhtml'/&gt;
  &lt;geoloc xmlns='http://jabber.org/protocol/geoloc'&gt;
    &lt;alt&gt;1609&lt;/alt&gt;
    &lt;description&gt;Jabber, Inc.&lt;/description&gt;
    &lt;error&gt;10&lt;/error&gt;
    &lt;lat&gt;39.75477&lt;/lat&gt;
    &lt;lon&gt;-104.99768&lt;/lon&gt;
    &lt;timestamp&gt;2004-02-19T21:12Z&lt;/timestamp&gt;
  &lt;/geoloc&gt;
&lt;/presence&gt;
  </pre></div>

  <p class="caption"><a name="example-4" id="example-4"></a>Example 4. Presence with Encrypted Content</p><div class="indent"><pre>
&lt;presence from='alice@example.org/pda'
          to='bob@example.com/laptop'
          type='available'&gt;
  &lt;c xmlns='http://www.xmpp.org/extensions/xep-0200.html#ns'&gt;
    &lt;data&gt; ** Base64 encoded m_final ** &lt;/data&gt;
    &lt;mac&gt; ** Base64 encoded a_mac ** &lt;/mac&gt;
  &lt;/c&gt;
&lt;/presence&gt;
  </pre></div>

  <p class="caption"><a name="example-5" id="example-5"></a>Example 5. Plain IQ Error Stanza</p><div class="indent"><pre>
&lt;iq from='alice@example.org/pda'
    to='bob@example.com/laptop'
    id='publish1'
    type='error'&gt;
  &lt;pubsub xmlns='http://jabber.org/protocol/pubsub'&gt;
    &lt;publish node='princely_musings'&gt;
      &lt;item id='ae890ac52d0df67ed7cfdf51b644e901'&gt;
        ...
      &lt;/item&gt;
    &lt;/publish&gt;
  &lt;/pubsub&gt;
  &lt;error type='modify'&gt;
    &lt;not-acceptable xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
    &lt;payload-too-big xmlns='http://jabber.org/protocol/pubsub#errors'/&gt;
  &lt;/error&gt;
&lt;/iq&gt;
  </pre></div>

  <p class="caption"><a name="example-6" id="example-6"></a>Example 6. Encrypted IQ Error Stanza</p><div class="indent"><pre>
&lt;iq from='alice@example.org/pda'
    to='bob@example.com/laptop'
    id='publish1'
    type='error'&gt;
  &lt;c xmlns='http://www.xmpp.org/extensions/xep-0200.html#ns'&gt;
    &lt;data&gt; ** Base64 encoded m_final ** &lt;/data&gt;
    &lt;mac&gt; ** Base64 encoded a_mac ** &lt;/mac&gt;
  &lt;/c&gt;
  &lt;error type='modify'&gt;
    &lt;not-acceptable xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
    &lt;c xmlns='http://www.xmpp.org/extensions/xep-0200.html#ns'&gt;
      &lt;data&gt; ** Base64 encoded m_final ** &lt;/data&gt;
      &lt;mac&gt; ** Base64 encoded a_mac ** &lt;/mac&gt;
    &lt;/c&gt;
  &lt;/error&gt;
&lt;/iq&gt;
  </pre></div>
<h2>6.
       <a name="encrypt" id="encrypt">Encrypting a Stanza</a></h2>
  <p class="" style="">Alice MUST perform the following steps to encrypt the XML content. Note: if there is no XML content to be encrypted (e.g. if this is an empty <a href="#rekey">Re-Key Exchange</a> stanza), then C<span class="sub" style="">A</span> MUST be incremented by 1 (see below), and only the last two steps (normalization and MAC calculation) should be performed.</p>
  <ol start="1" class="" style="">
    <li class="" style=""><p class="" style="">Serialize the XML content she wishes to send into an array of UTF-8 bytes, m.  [<a href="#nt-id2261641">16</a>]</p></li>
    <li class="" style="">
      <p class="" style="">Compress m using the negotiated algorithm. If a compression algorithm other than 'none' was agreed, the compression context is typically initialized after key exchange and passed from one stanza to the next, with only a partial flush at the end of each stanza.  [<a href="#nt-id2261664">17</a>]</p>
      <p class="caption"></p><div class="indent"><pre>m_compressed = COMPRESS(m)</pre></div>
    </li>
    <li class="" style="">
      <p class="" style="">Encrypt the data with the agreed algorithm in counter mode, using the encryption key KC<span class="sub" style="">A</span>. Note: C<span class="sub" style="">A</span> MUST be incremented by 1 for each encrypted block or partial block (i.e. C<span class="sub" style="">A</span> = (C<span class="sub" style="">A</span> + 1) mod 2<span class="super" style="">n</span>, where n is the number of bits per cipher block for the agreed block cipher algorithm). Note: if the block cipher algorithm 'none' was agreed then encryption MUST NOT be performed and C<span class="sub" style="">A</span> MUST be incremented by 1 (for replay protection).</p>
      <p class="caption"></p><div class="indent"><pre>m_final = CIPHER(KC<span class="sub" style="">A</span>, C<span class="sub" style="">A</span>, m_compressed)</pre></div>
    </li>
    <li class="" style="">
      <p class="" style="">Generate the whole serialized <span class="em">content</span> of the &lt;c/&gt; element:</p>
      <p class="" style="">If there is encrypted XML content, the XML MUST include the Base64 encoded (even if the block cipher algorithm 'none' was agreed  [<a href="#nt-id2261793">18</a>], in accordance with Section 4 of <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc4648">RFC 4648</a></span>  [<a href="#nt-id2261822">19</a>]) value of m_final wrapped in a &lt;data/&gt; element.</p>
      <p class="" style="">Only if Alice has received stanzas containing a &lt;key/&gt; element (see <a href="#rekey">Re-Key Exchange</a>) from Bob since she sent her last stanza then the XML MUST include the (positive, non-zero) number of such stanzas she has received (since she sent her last stanza) wrapped in a &lt;new/&gt; element.</p>
      <p class="" style="">The content may also contain one &lt;key/&gt; element (see <a href="#rekey">Re-Key Exchange</a>) and one or more &lt;old/&gt; elements (see <a href="#publish">Publishing Old MAC Values</a>).</p>
      <p class="" style="">Alice MUST normalize the content by removing any whitespace from the serialized content (i.e. remove all character data from <span class="em">between</span> all elements). Note: &lt;c/&gt; elements are so simple that there should <span class="em">never</span> be a need to convert the XML to canonical form.</p>
      <p class="" style="">For example:</p>
      <p class="caption"></p><div class="indent"><pre>m_content = '&lt;data&gt; ** Base64 encoded m_final ** &lt;/data&gt;&lt;new&gt;1&lt;/new&gt;'</pre></div>
    </li>
    <li class="" style="">
      <p class="" style="">Process the XML content, concatenated with the value of Alice's block cipher counter C<span class="sub" style="">A</span> <span class="em">before</span> the data was encrypted, through the HMAC algorithm (as defined in Section 2 of <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc2104">RFC 2104</a></span>  [<a href="#nt-id2261955">20</a>]), along with the agreed hash algorithm ("HASH") and the integrity key KM<span class="sub" style="">A</span>.</p>
      <p class="caption"></p><div class="indent"><pre>a_mac = <span class="em">HMAC</span>(HASH, KM<span class="sub" style="">A</span>, m_content | C<span class="sub" style="">A</span>)</pre></div>
    </li>
  </ol>
<h2>7.
       <a name="send" id="send">Sending an Encrypted Stanza</a></h2>
  <p class="" style="">Before sending the stanza to Bob, Alice MUST wrap the (unnormalized) content and the Base64 encoded value of a_mac (wrapped in a &lt;mac/&gt; element) inside an &lt;c/&gt; element and insert it into the stanza in place of the original content.</p>
  <p class="caption"><a name="example-7" id="example-7"></a>Example 7. Message Stanza with Encrypted Content</p><div class="indent"><pre>
&lt;message from='alice@example.org/pda'
         to='bob@example.com/laptop'
         type='chat'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;c xmlns='http://www.xmpp.org/extensions/xep-0200.html#ns'&gt;
    &lt;data&gt; ** Base64 encoded m_final ** &lt;/data&gt;
    &lt;new&gt;1&lt;/new&gt;
    &lt;mac&gt; ** Base64 encoded a_mac ** &lt;/mac&gt;
  &lt;/c&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp' per-hop='true'&gt;
    &lt;rule action='error' condition='match-resource' value='exact'/&gt;
  &lt;/amp&gt;
&lt;/message&gt;
  </pre></div>
<h2>8.
       <a name="decrypt" id="decrypt">Decrypting a Stanza</a></h2>
  <p class="" style="">When Bob receives the stanza from Alice, he MUST extract and Base64 decode the values of m_final and a_mac from the content and perform the following steps.</p>
  <ol start="1" class="" style="">
    <li class="" style="">
      <p class="" style="">Use any &lt;new/&gt; element the stanza may (or may not) contain to determine which of his &lt;key/&gt; elements (see <a href="#rekey-init">Re-Key Initiation</a>) Alice had received before she sent him the stanza. He MUST use this information to determine which of his stored sets of values {KC<span class="sub" style="">A</span> KM<span class="sub" style="">A</span> y} he should use to decrypt and verify the stanza. Bob MUST then securely destroy any of his sets of values that are older than the selected set.</p>
    </li>
    <li class="" style="">
      <p class="" style="">Remove the &lt;mac/&gt; element from the serialized content of the &lt;c/&gt; element, and normalize the remaining content by removing all whitespace. Calculate the Message Authentication Code (MAC) for the <span class="em">content</span> concatenated with Alice's block cipher counter using the agreed hash algorithm ("HASH") and the integrity key KM<span class="sub" style="">A</span>.</p>
      <p class="caption"></p><div class="indent"><pre>b_mac = <span class="em">HMAC</span>(HASH, KM<span class="sub" style="">A</span>, m_content | C<span class="sub" style="">A</span>)</pre></div>
    </li>
    <li class="" style="">
      <p class="" style="">Verify that b_mac and a_mac match. If they are not identical, the content has been tampered with and Bob MUST terminate the encrypted session, he MAY send a &lt;not-acceptable/&gt; error to Alice.  [<a href="#nt-id2262340">21</a>]</p>
    </li>
    <li class="" style="">
      <p class="" style="">Decrypt m_final using the agreed algorithm, KC<span class="sub" style="">A</span> and C<span class="sub" style="">A</span>. Note: C<span class="sub" style="">A</span> MUST be incremented by 1 for each decrypted block (see <a href="#encrypt">Encrypting a Stanza</a>). Note: if the block cipher algorithm 'none' was agreed decryption MUST NOT be performed and C<span class="sub" style="">A</span> MUST be incremented by 1.</p>
      <p class="caption"></p><div class="indent"><pre>m_compressed = DECIPHER(KC<span class="sub" style="">A</span>, C<span class="sub" style="">A</span>, m_final)</pre></div>
    </li>
    <li class="" style="">
      <p class="" style="">Decompress m_compressed using the negotiated algorithm (usually 'none').</p>
      <p class="caption"></p><div class="indent"><pre>m = DECOMPRESS(m_compressed)</pre></div>
    </li>
    <li class="" style="">
      <p class="" style="">Replace the &lt;c/&gt; element in the serialized XML stanza with m and feed the stanza into an XML parser. If the parser returns an XML format error then Bob MUST terminate the encrypted session, he MAY send a &lt;not-acceptable/&gt; error to Alice.  [<a href="#nt-id2262514">22</a>]</p>
    </li>
  </ol>
<h2>9.
       <a name="rekey" id="rekey">Re-Key Exchange</a></h2>
  <div class="indent"><h3>9.1 <a name="rekey-intro" id="rekey-intro">Introduction</a></h3>
    <p class="" style="">Once an attacker has discovered an encryption key it could be used to decrypt all stanzas within a session, including stanzas that were intercepted <span class="em">before</span> the key was discovered. To reduce the window of vulnerability, both Alice and Bob SHOULD use the Diffie-Hellman key exchange described below to agree a new encryption key as regularly as possible. They MUST also destroy all copies of keys as soon as they are no longer needed.</p>
    <p class="" style="">Note: Although most entities are capable of exchanging new keys after every stanza, clients running in constrained runtime environments may require a few seconds of full-load CPU time in order to re-key. During encrypted session negotiation (when using <span class="ref">Encrypted Session Negotiation</span> for example) these clients MAY negotiate the minimum number of stanzas to be exchanged between re-keys at the cost of a larger window of vulnerability. Entities MUST NOT initiate key re-exchanges more frequently than the agreed limit.</p>
    <p class="" style="">Either Alice or Bob MAY initiate a key re-exchange. Here we describe the process initiated by Alice.</p>
  </div>
  <div class="indent"><h3>9.2 <a name="rekey-init" id="rekey-init">Re-Key Initiation</a></h3>
    <p class="" style="">First Alice MUST calculate new values for the encryption parameters:</p>
    <ol start="1" class="" style="">
      <li class="" style=""><p class="" style="">Generate: a secret random number x (where 2<span class="super" style="">2n-1</span> &lt; x &lt; p - 1, where n is the number of bits per cipher block for CIPHER)</p></li>
      <li class="" style=""><p class="" style="">Calculate: e = g<span class="super" style="">x</span> mod p</p></li>
      <li class="" style=""><p class="" style="">Calculate: K = d<span class="super" style="">x</span> mod p (the new shared secret)</p></li>
      <li class="" style=""><p class="" style="">Alice's Encryption key: KC<span class="sub" style="">A</span> = HMAC(HASH, K, "Rekey Initiator Crypt")</p></li>
      <li class="" style=""><p class="" style="">Bob's Encryption key: KC<span class="sub" style="">B</span> = HMAC(HASH, K, "Rekey Acceptor Crypt")</p></li>
      <li class="" style=""><p class="" style="">Alice's Integrity key: KM<span class="sub" style="">A</span> = HMAC(HASH, K, "Rekey Initiator MAC")</p></li>
      <li class="" style=""><p class="" style="">Bob's Integrity key: KM<span class="sub" style="">B</span> = HMAC(HASH, K, "Rekey Acceptor MAC")</p></li>
    </ol>
    <p class="" style="">Note: Once KC<span class="sub" style="">A</span>, KM<span class="sub" style="">A</span>, KC<span class="sub" style="">B</span> and KM<span class="sub" style="">B</span> have been calculated the value of K MUST be securely destroyed. When calculating those keys, as many bits of key data as are needed for each key MUST be taken from the <span class="em">least</span> significant bits of the output of HMAC. For algorithms with variable-length keys the maximum length (up to the output length of HMAC) SHOULD be used.</p>
    <p class="" style="">The new value of e SHOULD be wrapped in a &lt;key/&gt; element and sent to Bob. To avoid unnecessary network traffic, it SHOULD be sent together with encrypted content (see <a href="#encrypt">Encrypting a Stanza</a>). Alice MUST use her <span class="em">old</span> KC<span class="sub" style="">A</span> and KM<span class="sub" style="">A</span> to encrypt and calculate the MAC of this stanza, after which she MUST securely destroy all copies of the old value of KC<span class="sub" style="">A</span>. She MUST use her <span class="em">new</span> KC<span class="sub" style="">A</span> and KM<span class="sub" style="">A</span> when sending <span class="em">subsequent</span> stanzas.</p>
    <p class="" style="">Note: There is no need for Alice to provide a signature because the calculation of the MAC includes the new value of e (see <a href="#encrypt">Encrypting a Stanza</a>).</p>
    <p class="caption"><a name="example-8" id="example-8"></a>Example 8. Alice Sends Re-Key Stanza</p><div class="indent"><pre>
&lt;message from='alice@example.org/pda' to='bob@example.com/laptop'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;c xmlns='http://www.xmpp.org/extensions/xep-0200.html#ns'&gt;
    &lt;data&gt; ** Base64 encoded m_final ** &lt;/data&gt;
    &lt;key&gt; ** Base64 encoded value of new e ** &lt;/key&gt;
    &lt;mac&gt; ** Base64 encoded a_mac ** &lt;/mac&gt;
  &lt;/c&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">Note: Bob may send one of more stanzas before he receives Alice's &lt;key/&gt; element (i.e. the stanzas may be in transit at the same time). So, before destroying her old values of KC<span class="sub" style="">B</span> and KM<span class="sub" style="">B</span>, Alice MUST wait until either she receives a stanza encrypted with her new key, or a reasonable time has passed (60 seconds should cover a network round-trip and calculations by a constrained client). Similarly she MUST wait before destroying her old value of x, in case Bob sends one or more stanzas including a &lt;key/&gt; element before he receives Alice's new key. Consequently, if Alice sends several &lt;key/&gt; elements to Bob within a reasonable time without receiving a stanza from him, then she MUST remember several "sets" of the three values: {KC<span class="sub" style="">B</span> KM<span class="sub" style="">B</span> x}.</p>
    <p class="" style="">Note: Alice never remembers more than one copy of KC<span class="sub" style="">A</span> and KM<span class="sub" style="">A</span>.</p>
  </div>

  <div class="indent"><h3>9.3 <a name="rekey-accept" id="rekey-accept">Re-Key Acceptance</a></h3>
    <p class="" style="">After receiving and <a href="#decrypt">decrypting a stanza</a> that contains a &lt;key/&gt; element Bob MUST extract the new value of e and confirm that it is greater than one. Then he MUST calculate K using the new value of e and the value of y from his oldest stored set of values {KC<span class="sub" style="">A</span> KM<span class="sub" style="">A</span> y} (i.e. the set that also contains the value of KC<span class="sub" style="">A</span> used to decrypt the stanza):</p>
    <p class="caption"></p><div class="indent"><pre>K = e<span class="super" style="">y</span> mod p</pre></div>
    <p class="" style="">Bob MUST replace the values of KC<span class="sub" style="">A</span> and KM<span class="sub" style="">A</span> in <span class="em">all</span> his stored sets of values {KC<span class="sub" style="">A</span> KM<span class="sub" style="">A</span> y} with values that are derived from K in exactly the same way as Alice did (see <a href="#rekey-init">Re-Key Initiation</a>).</p>
    <p class="" style="">Only if Bob is storing exactly one set of values {KC<span class="sub" style="">A</span> KM<span class="sub" style="">A</span> y} then he MUST also replace his values of KC<span class="sub" style="">B</span> and KM<span class="sub" style="">B</span> with values that are derived from K in exactly the same way as Alice did.</p>
  </div>
<h2>10.
       <a name="publish" id="publish">Publishing Old MAC Values</a></h2>
  <p class="" style="">Once the expired MAC keys have been published, anyone could create valid arbitrary stanzas with them. This prevents anyone being able to prove the authenticity of a transcript of the encrypted session in the future.</p>
  <p class="" style="">Either entity MAY publish old values of KM<span class="sub" style="">A</span> and/or KM<span class="sub" style="">B</span> within any encrypted stanza as long as it knows that all the stanzas that MAY use the old values have been received and validated. Note: A 'man-in-the-middle' could delay the delivery of stanzas indefinitely. So, before Alice publishes KM<span class="sub" style="">A</span> (and KM<span class="sub" style="">B</span>), she MUST wait until she has <span class="em">both</span> sent a re-key to Bob <span class="em">and</span> received a stanza from Bob encrypted with her new key. (She MAY also publish KM<span class="sub" style="">B</span> after she has received a re-key from Bob.)</p>
  <p class="caption"><a name="example-9" id="example-9"></a>Example 9. Publishing Expired MAC Keys</p><div class="indent"><pre>
&lt;message from='alice@example.org/pda' to='bob@example.com/laptop'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;c xmlns='http://www.xmpp.org/extensions/xep-0200.html#ns'&gt;
    &lt;data&gt; ** Base64 encoded m_final ** &lt;/data&gt;
    &lt;old&gt; ** Base64 encoded old MAC key ** &lt;/old&gt;
    &lt;old&gt; ** Base64 encoded old MAC key ** &lt;/old&gt;
    &lt;mac&gt; ** Base64 encoded a_mac ** &lt;/mac&gt;
  &lt;/c&gt;
&lt;/message&gt;
  </pre></div>
  <p class="" style="">Entities SHOULD ignore any &lt;old/&gt; elements they receive.</p>
<h2>11.
       <a name="sec" id="sec">Security Considerations</a></h2>
  <div class="indent"><h3>11.1 <a name="sec-prng" id="sec-prng">Random Numbers</a></h3>
    <p class="" style="">Weak pseudo-random number generators (PRNG) enable successful attacks. Implementors MUST use a cryptographically strong PRNG to generate all random numbers (see <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc1750">RFC 1750</a></span>  [<a href="#nt-id2263347">23</a>]).</p>
  </div>
  <div class="indent"><h3>11.2 <a name="sec-storage" id="sec-storage">Storage</a></h3>
    <p class="" style="">If either entity stores a (re-encrypted) transcript of an encrypted session for future consultation then the Perfect Forward Secrecy offered by this protocol is lost. If the negotiated value of the 'otr' <span class="ref">Stanza Session Negotiation</span> field is 'true' the entities MUST NOT store any part of the encrypted session content (not even in encrypted form).</p>
  </div>
  <div class="indent"><h3>11.3 <a name="sec-replay" id="sec-replay">Replay Attacks</a></h3>
    <p class="" style="">The block cipher counters maintained implicitly by Alice and Bob (C<span class="sub" style="">A</span> and C<span class="sub" style="">B</span>) prevent stanzas being replayed within any encrypted session. They ensure that the MAC will be different for all stanzas, even if the HMAC key and the content of the stanza are identical.</p>
    <p class="" style="">Alice and Bob MUST ensure that every value of x and y (and therefore e and d) they generate is unique. This prevents complete online encrypted sessions being replayed.</p>
  </div>
  <div class="indent"><h3>11.4 <a name="sec-life" id="sec-life">Maximum Key Life</a></h3>
    <p class="" style="">After each key exchange an entity MUST NOT exchange a total of 2<span class="super" style="">32</span> encrypted <span class="em">blocks</span> (not stanzas) before it initiates a key re-exchange (see <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc4344">RFC 4344</a></span>  [<a href="#nt-id2263458">24</a>]). Note: This limitation also ensures the same key and counter values are never used to encrypt two different blocks using counter mode (thus preventing simple attacks).</p>
    <p class="" style="">In order to reduce the Perfect Forward Secrecy window of vulnerability, after an extended period of inactivity entities SHOULD re-key (or terminate the encrypted session).</p>
  </div>
  <div class="indent"><h3>11.5 <a name="sec-general" id="sec-general">Extra Responsabilities of Implementors</a></h3>
    <p class="" style="">Cryptography plays only a small part in an entity's security. Even if it implements this protocol perfectly it may still be vulnerable to other attacks. For examples, an implementation might store encrypted session keys on swap space or save private keys to a file in cleartext! Implementors MUST take very great care when developing applications with secure technologies.</p>
  </div>
<h2>12.
       <a name="iana" id="iana">IANA Considerations</a></h2>
  <p class="" style="">This document requires no interaction with the <span class="ref" style=""><a href="http://www.iana.org/">Internet Assigned Numbers Authority (IANA)</a></span>  [<a href="#nt-id2263555">25</a>]. </p>
<h2>13.
       <a name="registrar" id="registrar">XMPP Registrar Considerations</a></h2>
  <div class="indent"><h3>13.1 <a name="ns" id="ns">Protocol Namespaces</a></h3>
    <p class="" style="">Until this specification advances to a status of Draft, its associated namespace shall be "http://www.xmpp.org/extensions/xep-0200.html#ns"; upon advancement of this specification, the <span class="ref" style=""><a href="http://www.xmpp.org/registrar/">XMPP Registrar</a></span>  [<a href="#nt-id2263610">26</a>] shall issue a permanent namespace in accordance with the process defined in Section 4 of <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0053.html">XMPP Registrar Function</a></span>  [<a href="#nt-id2263642">27</a>].</p>
  </div>
<h2>14.
       <a name="schema" id="schema">XML Schemas</a></h2>
  <p class="caption"></p><div class="indent"><pre>
&lt;?xml version='1.0' encoding='UTF-8'?&gt;

&lt;xs:schema
    xmlns:xs='http://www.w3.org/2001/XMLSchema'
    targetNamespace='http://www.xmpp.org/extensions/xep-0200.html#ns'
    xmlns='http://www.xmpp.org/extensions/xep-0200.html#ns'
    elementFormDefault='qualified'&gt;

  &lt;xs:element name='data' type='xs:string'/&gt;

  &lt;xs:element name='c'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:sequence&gt;
        &lt;xs:element ref='data' minOccurs='0' maxOccurs='1'/&gt;
        &lt;xs:element ref='key' minOccurs='0' maxOccurs='1'/&gt;
        &lt;xs:element ref='mac' minOccurs='0' maxOccurs='1'/&gt;
        &lt;xs:element ref='new' minOccurs='0' maxOccurs='1'/&gt;
        &lt;xs:element ref='old' minOccurs='0' maxOccurs='unbounded'/&gt;
      &lt;/xs:sequence&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='key' type='xs:string'/&gt;

  &lt;xs:element name='mac' type='xs:string'/&gt;

  &lt;xs:element name='new' type='xs:positiveInteger'/&gt;

  &lt;xs:element name='old' type='xs:string'/&gt;

&lt;/xs:schema&gt;
  </pre></div>
<hr /><h2><a name="notes" id="notes"></a>Notes</h2><div class="indent"><p><a name="nt-id2252617" id="nt-id2252617">1</a>. XEP-0027: Current Jabber OpenPGP Usage &lt;<a href="http://www.xmpp.org/extensions/xep-0027.html">http://www.xmpp.org/extensions/xep-0027.html</a>&gt;.</p><p><a name="nt-id2252642" id="nt-id2252642">2</a>. RFC 3920: Extensible Messaging and Presence Protocol (XMPP): Core &lt;<a href="http://tools.ietf.org/html/rfc3920">http://tools.ietf.org/html/rfc3920</a>&gt;.</p><p><a name="nt-id2252666" id="nt-id2252666">3</a>. RFC 3921: Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence &lt;<a href="http://tools.ietf.org/html/rfc3921">http://tools.ietf.org/html/rfc3921</a>&gt;.</p><p><a name="nt-id2252691" id="nt-id2252691">4</a>. RFC 3862: Common Presence and Instant Messaging (CPIM): Message Format &lt;<a href="http://tools.ietf.org/html/rfc3862">http://tools.ietf.org/html/rfc3862</a>&gt;.</p><p><a name="nt-id2252715" id="nt-id2252715">5</a>. RFC 3863: Presence Information Data Format (PIDF) &lt;<a href="http://tools.ietf.org/html/rfc3863">http://tools.ietf.org/html/rfc3863</a>&gt;.</p><p><a name="nt-id2252739" id="nt-id2252739">6</a>. RFC 3923: End-to-End Signing and Object Encryption for the Extensible Messaging and Presence Protocol (XMPP) &lt;<a href="http://tools.ietf.org/html/rfc3923">http://tools.ietf.org/html/rfc3923</a>&gt;.</p><p><a name="nt-id2251307" id="nt-id2251307">7</a>. XEP-0210: Requirements for Encrypted Sessions &lt;<a href="http://www.xmpp.org/extensions/xep-0210.html">http://www.xmpp.org/extensions/xep-0210.html</a>&gt;.</p><p><a name="nt-id2251347" id="nt-id2251347">8</a>. XEP-0116: Encrypted Session Negotiation &lt;<a href="http://www.xmpp.org/extensions/xep-0116.html">http://www.xmpp.org/extensions/xep-0116.html</a>&gt;.</p><p><a name="nt-id2251372" id="nt-id2251372">9</a>. XEP-0217: Simplified Encrypted Session Negotiation &lt;<a href="http://www.xmpp.org/extensions/xep-0217.html">http://www.xmpp.org/extensions/xep-0217.html</a>&gt;.</p><p><a name="nt-id2251398" id="nt-id2251398">10</a>. XEP-0187: Offline Encrypted Sessions &lt;<a href="http://www.xmpp.org/extensions/xep-0187.html">http://www.xmpp.org/extensions/xep-0187.html</a>&gt;.</p><p><a name="nt-id2251425" id="nt-id2251425">11</a>. XEP-0210: Requirements for Encrypted Sessions &lt;<a href="http://www.xmpp.org/extensions/xep-0210.html">http://www.xmpp.org/extensions/xep-0210.html</a>&gt;.</p><p><a name="nt-id2261406" id="nt-id2261406">12</a>. RFC 3920 requires that stanzas of type 'error' contain an &lt;error/&gt; child element.</p><p><a name="nt-id2261428" id="nt-id2261428">13</a>. RFC 3920 requires that &lt;error/&gt; elements contain a &lt;defined-condition/&gt; child element.</p><p><a name="nt-id2261451" id="nt-id2261451">14</a>. Applications typically use &lt;thread/&gt; elements internally to route stanzas to the process handling a session. The content of thread elements MUST be opaque with no semantic meaning and only exact comparisons MAY be made against it.</p><p><a name="nt-id2261495" id="nt-id2261495">15</a>. XEP-0079: Advanced Message Processing &lt;<a href="http://www.xmpp.org/extensions/xep-0079.html">http://www.xmpp.org/extensions/xep-0079.html</a>&gt;.</p><p><a name="nt-id2261641" id="nt-id2261641">16</a>. Although counter mode encryption requires no padding, implementations MAY still disguise the length of m by appending a random number of white-space characters.</p><p><a name="nt-id2261664" id="nt-id2261664">17</a>. If Bob were to receive a stanza out-of-order, then he would fail to decrypt the stanza and be forced to terminate the encrypted session.</p><p><a name="nt-id2261793" id="nt-id2261793">18</a>. The content is encoded even if no encryption is used to avoid triggering namespace errors when entities parse the XML.</p><p><a name="nt-id2261822" id="nt-id2261822">19</a>. RFC 4648: The Base16, Base32, and Base64 Data Encodings &lt;<a href="http://tools.ietf.org/html/rfc4648">http://tools.ietf.org/html/rfc4648</a>&gt;.</p><p><a name="nt-id2261955" id="nt-id2261955">20</a>. RFC 2104: HMAC: Keyed-Hashing for Message Authentication &lt;<a href="http://tools.ietf.org/html/rfc2104">http://tools.ietf.org/html/rfc2104</a>&gt;.</p><p><a name="nt-id2262340" id="nt-id2262340">21</a>. If Bob were to receive a stanza out-of-order, then the MACs would not match because the values of C<span class="sub" style="">A</span> would not be synchronized.</p><p><a name="nt-id2262514" id="nt-id2262514">22</a>. Bob MUST NOT send a stream error to his server since intermediate entities are not responsible for encoded content.</p><p><a name="nt-id2263347" id="nt-id2263347">23</a>. RFC 1750: Randomness Recommendations for Security &lt;<a href="http://tools.ietf.org/html/rfc1750">http://tools.ietf.org/html/rfc1750</a>&gt;.</p><p><a name="nt-id2263458" id="nt-id2263458">24</a>. RFC 4344: SSH Transport Layer Encryption Modes &lt;<a href="http://tools.ietf.org/html/rfc4344">http://tools.ietf.org/html/rfc4344</a>&gt;.</p><p><a name="nt-id2263555" id="nt-id2263555">25</a>. The Internet Assigned Numbers Authority (IANA) is the central coordinator for the assignment of unique parameter values for Internet protocols, such as port numbers and URI schemes. For further information, see &lt;<a href="http://www.iana.org/">http://www.iana.org/</a>&gt;.</p><p><a name="nt-id2263610" id="nt-id2263610">26</a>. The XMPP Registrar maintains a list of reserved protocol namespaces as well as registries of parameters used in the context of XMPP extension protocols approved by the XMPP Standards Foundation. For further information, see &lt;<a href="http://www.xmpp.org/registrar/">http://www.xmpp.org/registrar/</a>&gt;.</p><p><a name="nt-id2263642" id="nt-id2263642">27</a>. XEP-0053: XMPP Registrar Function &lt;<a href="http://www.xmpp.org/extensions/xep-0053.html">http://www.xmpp.org/extensions/xep-0053.html</a>&gt;.</p></div><hr /><h2><a name="revs" id="revs"></a>Revision History</h2><div class="indent"><h4>Version 0.2 (2007-05-30)</h4><div class="indent"><p class="" style="">Added reference to Simplified Encrypted Session Negotiation; modified namespaces to reflect XMPP Registrar procedures regarding URN issuance.</p> (ip)
    </div><h4>Version 0.1 (2006-11-23)</h4><div class="indent"><p class="" style="">Initial version (extracted from XEP-0116 version 0.12); clarified Re-Key Exchange section; removed canonicalization requirement; employed HMAC instead of hash; added new sections; changed element name and namespace</p> (ip)
    </div></div><hr /><p>END</p></body></html>
