<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>XEP-0155: Stanza Session Negotiation</title><link rel="stylesheet" type="text/css" href="/xmpp.css" /><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" /><meta name="DC.Title" content="Stanza Session Negotiation" /><meta name="DC.Creator" content="Ian Paterson" /><meta name="DC.Creator" content="Peter Saint-Andre" /><meta name="DC.Description" content="This specification defines a method for formally negotiating the exchange of XML stanzas between two XMPP entities. The method uses feature negotiation forms sent via XMPP message stanzas to enable session initiation between entities that do not share presence information or have knowledge of full JabberIDs and therefore is also suitable for use across gateways to SIP-based systems. A wide range of session parameters can be negotiated, including the use of end-to-end encryption, chat state notifications, XHTML-IM formatting, and message archiving." /><meta name="DC.Publisher" content="XMPP Standards Foundation" /><meta name="DC.Contributor" content="XMPP Extensions Editor" /><meta name="DC.Date" content="2008-01-14" /><meta name="DC.Type" content="XMPP Extension Protocol" /><meta name="DC.Format" content="XHTML" /><meta name="DC.Identifier" content="XEP-0155" /><meta name="DC.Language" content="en" /><meta name="DC.Rights" content="This XMPP Extension Protocol is copyright (c) 1999 - 2008 by the XMPP Standards Foundation (XSF)." /></head><body><h1>XEP-0155: Stanza Session Negotiation</h1><p>This specification defines a method for formally negotiating the exchange of XML stanzas between two XMPP entities. The method uses feature negotiation forms sent via XMPP message stanzas to enable session initiation between entities that do not share presence information or have knowledge of full JabberIDs and therefore is also suitable for use across gateways to SIP-based systems. A wide range of session parameters can be negotiated, including the use of end-to-end encryption, chat state notifications, XHTML-IM formatting, and message archiving.</p><hr /><p style="color:green">NOTICE: The protocol defined herein is a Draft Standard of the XMPP Standards Foundation. Implementations are encouraged and the protocol is appropriate for deployment in production systems, but some changes to the protocol are possible before it becomes a Final Standard.</p><hr /><h2>Document Information</h2><p class="indent">
            Series: <a href="http://www.xmpp.org/extensions/">XEP</a><br />
            Number: 0155<br />
            Publisher: <a href="/xsf/">XMPP Standards Foundation</a><br />
            Status: 
            <a href="http://www.xmpp.org/extensions/xep-0001.html#states-Draft">Draft</a><br />
            Type:
            <a href="http://www.xmpp.org/extensions/xep-0001.html#types-Standards Track">Standards Track</a><br />
            Version: 1.2<br />
            Last Updated: 2008-01-14<br />
                Approving Body: <a href="http://www.xmpp.org/council/">XMPP Council</a><br />Dependencies: XMPP Core, XMPP IM, XEP-0020, XEP-0068<br />
                Supersedes: None<br />
                Superseded By: None<br />
            Short Name: ssn<br />
              Wiki Page: &lt;<a href="http://wiki.jabber.org/index.php/Stanza Session Negotiation (XEP-0155)">http://wiki.jabber.org/index.php/Stanza Session Negotiation (XEP-0155)</a>&gt;
            </p><hr /><h2>Author Information</h2><div class="indent"><h3>Ian Paterson</h3><p class="indent">
        Email:
        <a href="mailto:ian.paterson@clientside.co.uk">ian.paterson@clientside.co.uk</a><br />
        JabberID: 
        <a href="xmpp:ian@zoofy.com">ian@zoofy.com</a><br /></p><h3>Peter Saint-Andre</h3><p class="indent">
        JabberID: 
        <a href="xmpp:stpeter@jabber.org">stpeter@jabber.org</a><br />
        URI: 
        <a href="https://stpeter.im/">https://stpeter.im/</a><br /></p></div><hr /><h2>Legal Notices</h2><div class="indent"><h3>Copyright</h3>This XMPP Extension Protocol is copyright (c) 1999 - 2008 by the XMPP Standards Foundation (XSF).<h3>Permissions</h3>Permission is hereby granted, free of charge, to any person obtaining a copy of this specification (the "Specification"), to make use of the Specification without restriction, including without limitation the rights to implement the Specification in a software program, deploy the Specification in a network service, and copy, modify, merge, publish, translate, distribute, sublicense, or sell copies of the Specification, and to permit persons to whom the Specification is furnished to do so, subject to the condition that the foregoing copyright notice and this permission notice shall be included in all copies or substantial portions of the Specification. Unless separate permission is granted, modified works that are redistributed shall not contain misleading information regarding the authors, title, number, or publisher of the Specification, and shall not claim endorsement of the modified works by the authors, any organization or project to which the authors belong, or the XMPP Standards Foundation.<h3>Disclaimer of Warranty</h3><span style="font-weight: bold">## NOTE WELL: This Specification is provided on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or implied, including, without limitation, any warranties or conditions of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A PARTICULAR PURPOSE. In no event shall the XMPP Standards Foundation or the authors of this Specification be liable for any claim, damages, or other liability, whether in an action of contract, tort, or otherwise, arising from, out of, or in connection with the Specification or the implementation, deployment, or other use of the Specification. ##</span><h3>Limitation of Liability</h3>In no event and under no legal theory, whether in tort (including negligence), contract, or otherwise, unless required by applicable law (such as deliberate and grossly negligent acts) or agreed to in writing, shall the XMPP Standards Foundation or any author of this Specification be liable for damages, including any direct, indirect, special, incidental, or consequential damages of any character arising out of the use or inability to use the Specification (including but not limited to damages for loss of goodwill, work stoppage, computer failure or malfunction, or any and all other commercial damages or losses), even if the XMPP Standards Foundation or such author has been advised of the possibility of such damages.<h3>IPR Conformance</h3>This XMPP Extension Protocol has been contributed in full conformance with the XSF's Intellectual Property Rights Policy (a copy of which may be found at &lt;<a href="http://www.xmpp.org/extensions/ipr-policy.shtml">http://www.xmpp.org/extensions/ipr-policy.shtml</a>&gt; or obtained by writing to XSF, P.O. Box 1641, Denver, CO 80201 USA).</div><hr /><h2>Discussion Venue</h2><p class="indent">The preferred venue for discussion of this document is the Standards discussion list: &lt;<a href="http://mail.jabber.org/mailman/listinfo/standards">http://mail.jabber.org/mailman/listinfo/standards</a>&gt;.</p><p class="indent">Errata may be sent to &lt;<a href="mailto:editor@xmpp.org">editor@xmpp.org</a>&gt;.</p><h2>Relation to XMPP</h2><p class="indent">The Extensible Messaging and Presence Protocol (XMPP) is defined in the XMPP Core (RFC 3920) and XMPP IM (RFC 3921) specifications contributed by the XMPP Standards Foundation to the Internet Standards Process, which is managed by the Internet Engineering Task Force in accordance with RFC 2026. Any protocol defined in this document has been developed outside the Internet Standards Process and is to be understood as an extension to XMPP rather than as an evolution, development, or modification of XMPP itself.</p><h2>Conformance Terms</h2><p class="indent">The following keywords as used in this document are to be interpreted as described in <a href="http://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>: "MUST", "SHALL", "REQUIRED"; "MUST NOT", "SHALL NOT"; "SHOULD", "RECOMMENDED"; "SHOULD NOT", "NOT RECOMMENDED"; "MAY", "OPTIONAL".</p><hr /><h2>Table of Contents</h2><div class="indent"><p><br />1.  <a href="#intro">Introduction</a><br />2.  <a href="#req">Requirements</a><br />3.  <a href="#statechart">State Chart</a><br />4.  <a href="#new">Negotiating a New Session</a><br />   
      4.1.  <a href="#new-initiate">Initiating a Session</a><br />   
      4.2.  <a href="#new-accept">Accepting a Session</a><br />   
      4.3.  <a href="#new-reject">Rejecting a Session</a><br />   
      4.4.  <a href="#new-complete">Completing or Canceling the Negotiation</a><br />5.  <a href="#move">Moving A Session to a Different Resource</a><br />6.  <a href="#renegotiate">Renegotiating a Session</a><br />7.  <a href="#terminate">Terminating a Session</a><br />8.  <a href="#parameters">Defined Parameters</a><br />9.  <a href="#impl">Implementation Notes</a><br />   
      9.1.  <a href="#impl-auto">Auto Accept or Reject</a><br />   
      9.2.  <a href="#impl-close">Persisting Sessions</a><br />   
      9.3.  <a href="#impl-presence">Sharing Presence</a><br />   
      9.4.  <a href="#impl-unavail">Unavailable Presence</a><br />   
      9.5.  <a href="#impl-sip">Mapping to SIP</a><br />10.  <a href="#security">Security Considerations</a><br />   
      10.1.  <a href="#secure-leak">Presence Leaks</a><br />   
      10.2.  <a href="#secure-local">Localization</a><br />11.  <a href="#iana">IANA Considerations</a><br />12.  <a href="#registrar">XMPP Registrar Considerations</a><br />   
      12.1.  <a href="#ns">Protocol Namespaces</a><br />   
      12.2.  <a href="#registrar-features">Service Discovery Features</a><br />   
      12.3.  <a href="#registrar-formtype">Field Standardization</a><br />13.  <a href="#schema">XML Schema</a><br />14.  <a href="#ack">Acknowledgements</a><br /><a href="#notes">Notes</a><br /><a href="#revs">Revision History</a></p></div><hr /><h2>1.
       <a name="intro" id="intro">Introduction</a></h2>
  <p class="" style="">The traditional model for one-to-one chat "sessions" in Jabber/XMPP is for a user to simply send a message to a contact with a thread ID but without any formal negotiation of session parameters (see <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0201.html">Best Practices for Message Threads</a></span>  [<a href="#nt-id2251532">1</a>]). This informal approach to initiation of a session is perfectly acceptable in many contexts, environments, and cultures. However, it may be desirable to formally request a chat session (or any other type of XMPP stanza session) and negotiate its parameters before beginning the session in some circumstances, such as:</p>
  <ul class="" style="">
    <li class="" style="">Whenever parameters specific to a stanza session must be agreed. e.g., security and privacy parameters (see <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0116.html">Encrypted Session Negotiation</a></span>  [<a href="#nt-id2251584">2</a>] and <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0136.html">Message Archiving</a></span>  [<a href="#nt-id2261062">3</a>]).</li>
    <li class="" style="">The parties are unknown to each other, have not exchanged presence, or have not discovered their respective capabilities via <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0030.html">Service Discovery</a></span>  [<a href="#nt-id2261096">4</a>] or <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0115.html">Entity Capabilities</a></span>  [<a href="#nt-id2261121">5</a>].</li>
    <li class="" style="">When an XMPP-based system interfaces with a SIP-based system built on top of <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc3261">RFC 3261</a></span>  [<a href="#nt-id2261151">6</a>].  [<a href="#nt-id2261075">7</a>]</li>
    <li class="" style="">Within an organization or culture in which one would not simply begin interacting with another person (e.g., a superior) without first receiving permission to do so.</li>
  </ul>
  <p class="" style="">This proposal defines best practices for such a negotiation, re-using the protocol defined in <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0020.html">Feature Negotiation</a></span>  [<a href="#nt-id2261200">8</a>].</p>
<h2>2.
       <a name="req" id="req">Requirements</a></h2>
  <p class="" style="">The specification addresses the following use cases:</p>
  <ul class="" style="">
    <li class="" style="">Negotiating a new stanza session</li>
    <li class="" style="">Moving an existing stanza session from one resource to another</li>
    <li class="" style="">Renegotiating an existing stanza session</li>
    <li class="" style="">Terminating an existing stanza session</li>
  </ul>
<h2>3.
       <a name="statechart" id="statechart">State Chart</a></h2>
  <p class="" style="">The following figure attempts to capture the state transitions in visual form.</p>
  <p class="caption"></p><div class="indent"><pre>
         o
         |
        [1]
         |
PENDING  o---------------+
         |               |
         |              [3]
         |               |
        [2]-----[5]------|
         |               |
        [4]              |
         |               |
         |               |
 ACTIVE  o               |
         |               |
         +------+        |
         |      |        |
         |     [6]       |
         |      |        |
         | [7] or [8]    |
         |      |        |
         +------+        |
         |               |
         +-----[9]-------+
                         |
                         o ENDED
  </pre></div>
  <p class="" style="">[1] A stanza session negotiation is initiated when the user sends a message containing a data form of type "form" with an "accept" field.</p>
  <p class="" style="">[2] A stanza session negotiation is accepted when the contact sends a message containing a data form of type "submit" with an "accept" field whose value is "1" or "true".</p>
  <p class="" style="">[3] A stanza session negotiation is rejected when the contact sends a message containing a data form of type "submit" with an "accept" field whose value is "0" or "false".</p>
  <p class="" style="">[4] A stanza session negotiation is completed when the user sends a message containing a data form of type "result" with an "accept" field whose value is "1" or "true".</p>
  <p class="" style="">[5] A stanza session negotiation is canceled when the user sends a message containing a data form of type "result" with an "accept" field whose value is "0" or "false".</p>
  <p class="" style="">[6] An existing session is re-negotiated when either party sends a message containing a data form of type "form" with a "renegotiate" field whose value is "1" or "true".</p>
  <p class="" style="">[7] A session re-negotiation is accepted when the other party sends a message containing a data form of type "submit" with a "renegotiate" field whose value is "1" or "true".</p>
  <p class="" style="">[8] A session re-negotiation is rejected when the other party sends a message containing a data form of type "submit" with a "renegotiate" field whose value is "0" or "false"; however, the session remains in the active state with the previously-negotiated parameters in force.</p>
  <p class="" style="">[9] A session is terminated when either party sends a message containing a data form of type "submit" with a "terminate" field whose value is "1" or "true".</p>
<h2>4.
       <a name="new" id="new">Negotiating a New Session</a></h2>
  <div class="indent"><h3>4.1 <a name="new-initiate" id="new-initiate">Initiating a Session</a></h3>
    <p class="" style="">In order to initiate a negotiated session, the initiating party ("user") sends a &lt;message/&gt;  [<a href="#nt-id2261406">9</a>] stanza to the receiving party ("contact") containing a &lt;feature/&gt; child qualified by the 'http://jabber.org/protocol/feature-neg' namespace. The &lt;message/&gt; stanza MUST NOT contain a &lt;body/&gt; child element (as specified in <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc3921">RFC 3921</a></span>  [<a href="#nt-id2261439">10</a>]). The &lt;message/&gt; stanza type SHOULD be "normal" (either explicitly or by non-inclusion of the 'type' attribute). The stanza MUST contain a &lt;thread/&gt; element for tracking purposes (where the newly-generated ThreadID is unique to the proposed session). The data form MUST contain a hidden FORM_TYPE field whose value is "urn:xmpp:ssn" and MUST contain a boolean field named "accept".  [<a href="#nt-id2261417">11</a>] The inclusion of "logging", "disclosure" and "security" fields is also RECOMMENDED. Note: The options within any 'list-single' fields SHOULD appear in order of preference.</p>
    <p class="" style="">Note: Sessions may be conducted between entities who are never online at the same time. However, if the user is interested only in an <span class="em">immediate</span> session then the user SHOULD instruct the contact's server not to store the message for later delivery (see <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0160.html">Best Practices for Handling Offline Messages</a></span>  [<a href="#nt-id2261505">12</a>]) using the <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0079.html">Advanced Message Processing</a></span>  [<a href="#nt-id2261532">13</a>] protocol.</p>
    <p class="" style="">In the following example of a negotiation request, Romeo requests a chat with Juliet and also queries her regarding whether she is able to disallow all message logging (see <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0136.html">Message Archiving</a></span>  [<a href="#nt-id2261550">14</a>])  [<a href="#nt-id2261561">15</a>], whether she wants to temporarily share presence for this session (see the <a href="#impl-presence">Sharing Presence</a> section of this document), and whether she wants to support the <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0071.html">XHTML-IM</a></span>  [<a href="#nt-id2261605">16</a>] and <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0085.html">Chat State Notifications</a></span>  [<a href="#nt-id2261630">17</a>] extensions during this session. He asks Juliet's client if it is prepared to make a (legally binding) guarantee that it does not intentionally implement any feature (not even a disabled feature) that might disclose the content of the session, any associated (decryption) keys, or his identity to any third-party (see <span class="ref">Encrypted Session Negotiation</span>). He also requires that they are both connected securely to their servers, and asks which language she prefers amongst those he can write.</p>
    <p class="" style="">Note: These fields are examples only. For definitions of these fields, refer to the <a href="#parameters">Defined Parameters</a> section of this document.</p>
    <p class="caption"><a name="example-1" id="example-1"></a>Example 1. User requests session</p><div class="indent"><pre>
&lt;message type='normal'
         from='romeo@montague.net/orchard'
         to='juliet@capulet.com'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='form'&gt;
      &lt;title&gt;Open chat with Romeo?&lt;/title&gt;
      &lt;field var='FORM_TYPE' type='hidden'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field label='Accept this session?' type='boolean' var='accept'&gt;
        &lt;value&gt;true&lt;/value&gt;
        &lt;required/&gt;
      &lt;/field&gt;
      &lt;field label='Message logging' type='list-single' var='logging'&gt;
        &lt;value&gt;mustnot&lt;/value&gt;
        &lt;option label='Allow message logging'&gt;
          &lt;value&gt;may&lt;/value&gt;
        &lt;/option&gt;
        &lt;option label='Disallow all message logging'&gt;
          &lt;value&gt;mustnot&lt;/value&gt;
        &lt;/option&gt;
        &lt;required/&gt;
      &lt;/field&gt;
      &lt;field label="Disclosure" type="list-single" var="disclosure"&gt;
        &lt;value&gt;never&lt;/value&gt;
        &lt;option label="Guarantee disclosure not implemented"&gt;
          &lt;value&gt;never&lt;/value&gt;
        &lt;/option&gt;
        &lt;option label="Disable all disclosures"&gt;
          &lt;value&gt;disabled&lt;/value&gt;
        &lt;/option&gt;
        &lt;option label="Allow disclosures"&gt;
          &lt;value&gt;enabled&lt;/value&gt;
        &lt;/option&gt;
        &lt;required/&gt;
      &lt;/field&gt;
      &lt;field label='Allow multiple sessions?' type='boolean' var='multisession'&gt;
        &lt;value&gt;false&lt;/value&gt;
      &lt;/field&gt;
      &lt;field label='XHTML formatting'
             type='list-single'
             var='http://jabber.org/protocol/xhtml-im'&gt;
        &lt;value&gt;may&lt;/value&gt;
        &lt;option label='Allow XHTML formatting'&gt;&lt;value&gt;may&lt;/value&gt;&lt;/option&gt;
        &lt;option label='Disallow XHTML formatting'&gt;&lt;value&gt;mustnot&lt;/value&gt;&lt;/option&gt;
      &lt;/field&gt;
      &lt;field label='Temporarily share presence?'
             type='list-single'
             var='presence'
        &lt;value&gt;may&lt;/value&gt;
        &lt;option label='Allow temporary presence sharing'&gt;&lt;value&gt;may&lt;/value&gt;&lt;/option&gt;
        &lt;option label='Disallow temporary presence sharing'&gt;&lt;value&gt;mustnot&lt;/value&gt;&lt;/option&gt;
      &lt;/field&gt;
      &lt;field label='Chat State Notifications'
             type='list-single'
             var='http://jabber.org/protocol/chatstates'&gt;
        &lt;value&gt;may&lt;/value&gt;
        &lt;option label='Allow Chat State Notifications'&gt;&lt;value&gt;may&lt;/value&gt;&lt;/option&gt;
        &lt;option label='Disallow Chat State Notifications'&gt;&lt;value&gt;mustnot&lt;/value&gt;&lt;/option&gt;
      &lt;/field&gt;
      &lt;field label='Minimum security level'
             type='list-single'
             var='security'&gt;
        &lt;value&gt;c2s&lt;/value&gt;
        &lt;option label='Both parties must be securely connected to their servers'&gt;
          &lt;value&gt;c2s&lt;/value&gt;
        &lt;/option&gt;
        &lt;required/&gt;
      &lt;/field&gt;
      &lt;field label='Primary written language of the chat'
             type='list-single'
             var='language'&gt;
        &lt;value&gt;en&lt;/value&gt;
        &lt;option label='English'&gt;&lt;value&gt;en&lt;/value&gt;&lt;/option&gt;
        &lt;option label='Italiano'&gt;&lt;value&gt;it&lt;/value&gt;&lt;/option&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'&gt;
    &lt;rule action='drop' condition='deliver' value='stored'/&gt;
  &lt;/amp&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">The user MAY request a session with a specific resource of the contact. However, if the user specifies no resource (or if the specified resource is not available), then the contact's server delivers the request to the contact's most available resource (which in the examples below happens to be "balcony"). If no resource is available (and no <span class="ref">Advanced Message Processing</span> rule included in the request specifies otherwise) then the server MAY store the request for later delivery.</p>
  </div>
  <div class="indent"><h3>4.2 <a name="new-accept" id="new-accept">Accepting a Session</a></h3>
    <p class="" style="">If, upon reception of a user's session request, a contact finds that the request had been stored for later delivery, and if the contact is interested only in an <span class="em">immediate</span> session, then it SHOULD initiate a new stanza session negotiation (including a newly-generated ThreadID) instead of responding to the user's request. Note: Sending any response to the user's original request would leak presence information since it would divulge the fact that the contact had been offline rather than just ignoring the user.</p>
    <p class="" style="">In any response to the user's request, the contact's client MUST mirror the &lt;thread/&gt; value so that the user's client can correctly track the response. The &lt;message/&gt; stanza MUST NOT contain a &lt;body/&gt; child element.</p>
    <p class="" style="">If the request is accepted then the contact's client MUST include in its response values for all the fields that the request indicated are required. If the contact's client does not support one of the default values or if the contact has disabled its support (as for Chat State Notifications and XHTML formatting in the example below), and the client can still accept the request, then it MUST set that field to a value that it can support.</p>
    <p class="" style="">In the example below we assume that Juliet accepts the session and specifies that she prefers to speak Italian with Romeo:</p>
    <p class="caption"><a name="example-2" id="example-2"></a>Example 2. Contact accepts session and specifies parameters</p><div class="indent"><pre>
&lt;message type='normal'
         from='juliet@capulet.com/balcony'
         to='romeo@montague.net/orchard'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='submit'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='accept'&gt;&lt;value&gt;true&lt;/value&gt;&lt;/field&gt;
      &lt;field var='logging'&gt;&lt;value&gt;mustnot&lt;/value&gt;&lt;/field&gt;
      &lt;field var='disclosure'&gt;&lt;value&gt;never&lt;/value&gt;&lt;/field&gt;
      &lt;field var='http://jabber.org/protocol/xhtml-im'&gt;
        &lt;value&gt;may&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='http://jabber.org/protocol/chatstates'&gt;
        &lt;value&gt;may&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='security'&gt;&lt;value&gt;c2s&lt;/value&gt;&lt;/field&gt;
      &lt;field var='language'&gt;&lt;value&gt;it&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">Note: Both entities MUST assume the session is being established with the resource of the contact that sends the reply, even if the user sent its request to a different resource of the contact.</p>
  </div>
  <div class="indent"><h3>4.3 <a name="new-reject" id="new-reject">Rejecting a Session</a></h3>
    <p class="" style="">If the contact does not want to reveal presence to the user for whatever reason then the contact's client SHOULD return no response or error (see <a href="#secure-leak">Presence Leaks</a>). Also, if the contact is using a legacy client then it MAY not support returning any response or error. In both these cases the user MAY proceed to send stanzas to the contact outside the context of a negotiated session.</p>
    <p class="" style="">However, if the contact simply prefers not to start a session then the client SHOULD decline the invitation. The data form MUST contain the FORM_TYPE field and the "accept" field set to "0" or "false". It is RECOMMENDED that the form does not contain any other fields even if the request indicated they are required. The client MAY include a reason via the "reason" field (which is of type "text-single"). The &lt;message/&gt; stanza MUST NOT contain a &lt;body/&gt; child element.</p>
    <p class="caption"><a name="example-3" id="example-3"></a>Example 3. Contact declines offer and specifies reason</p><div class="indent"><pre>
&lt;message type='normal'
         from='juliet@capulet.com/balcony'
         to='romeo@montague.net/orchard'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='submit'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='accept'&gt;&lt;value&gt;0&lt;/value&gt;&lt;/field&gt;
      &lt;field var='reason'&gt;
        &lt;value&gt;Sorry, can't chat now! How about tonight?&lt;/value&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">If the contact's client does not support feature negotiation or does not support the "urn:xmpp:ssn" FORM_TYPE, it SHOULD return a &lt;service-unavailable/&gt; error:</p>
    <p class="caption"><a name="example-4" id="example-4"></a>Example 4. Contact returns service unavailable error</p><div class="indent"><pre>
&lt;message type='error'
         from='juliet@capulet.com/balcony'
         to='romeo@montague.net/orchard'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='form'&gt;
      &lt;field var='FORM_TYPE' type='hidden'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      ...
    &lt;/x&gt;
  &lt;/feature&gt;
  &lt;error code='503' type='cancel'&gt;
    &lt;service-unavailable xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
  &lt;/error&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">If the contact's client does not support one or more of the <span class="em">required</span> features, it SHOULD return a &lt;feature-not-implemented/&gt; error, specifying the field(s) not implemented using the 'var' attribute of one or more &lt;field/&gt; child elements of a &lt;feature/&gt; child element of the &lt;error/&gt; scoped by the 'http://jabber.org/protocol/feature-neg' namespace:</p>
    <p class="caption"><a name="example-5" id="example-5"></a>Example 5. Contact returns feature not implemented error</p><div class="indent"><pre>
&lt;message type='error'
         from='juliet@capulet.com/balcony'
         to='romeo@montague.net/orchard'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='form'&gt;
      &lt;field var='FORM_TYPE' type='hidden'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      ...
    &lt;/x&gt;
  &lt;/feature&gt;
  &lt;error code='501' type='cancel'&gt;
    &lt;feature-not-implemented xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
    &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
      &lt;field var='logging'/&gt;
    &lt;/feature&gt;
  &lt;/error&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">If the contact's client supports <span class="em">none</span> of the options for one or more <span class="em">required</span> fields, it SHOULD return a &lt;not-acceptable/&gt; error, specifying the field(s) with unsupported options using the 'var' attribute of one or more &lt;field/&gt; child elements of a &lt;feature/&gt; child element of the &lt;error/&gt; scoped by the 'http://jabber.org/protocol/feature-neg' namespace:</p>
    <p class="caption"><a name="example-6" id="example-6"></a>Example 6. Contact returns options not acceptable error</p><div class="indent"><pre>
&lt;message type='error'
         from='juliet@capulet.com/balcony'
         to='romeo@montague.net/orchard'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='form'&gt;
      &lt;field var='FORM_TYPE' type='hidden'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      ...
    &lt;/x&gt;
  &lt;/feature&gt;
  &lt;error code='406' type='modify'&gt;
    &lt;not-acceptable xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
    &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
      &lt;field var='security'/&gt;
    &lt;/feature&gt;
  &lt;/error&gt;
&lt;/message&gt;
    </pre></div>
  </div>
  <div class="indent"><h3>4.4 <a name="new-complete" id="new-complete">Completing or Canceling the Negotiation</a></h3>
    <p class="" style="">If the contact accepted the session (see <a href="#new-accept">Accepting a Session</a>) then the user MUST either complete or cancel the stanza session negotiation. If the contact chose an option other than the default (prefered) value for one or more of the fields, then instead of having the client accept the session automatically the user may prefer to review the values that the contact selected before confirming that the session is open.  [<a href="#nt-id2262145">18</a>] In any case the user's client SHOULD verify that the selected values are acceptable before completing the stanza session negotiation -- and confirming that the session is open -- by replying with a form with the form 'type' attribute set to 'result'. The form MUST contain the FORM_TYPE field and the "accept" field set to "1" or "true". The user MAY include an explanation or reason via the "reason" field (which is of type "text-single"). The &lt;message/&gt; stanza MUST NOT contain a &lt;body/&gt; child element.</p>
    <p class="caption"><a name="example-7" id="example-7"></a>Example 7. User completes negotiation and confirms session is open</p><div class="indent"><pre>
&lt;message type='normal'
         from='romeo@montague.net/orchard'
         to='juliet@capulet.com/balcony'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='result'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='accept'&gt;&lt;value&gt;true&lt;/value&gt;&lt;/field&gt;
      &lt;field var='reason'&gt;
        &lt;value&gt;I forgot what I wanted to say!&lt;/value&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">Alternatively, if the user decides to cancel the stanza session negotiation then the client MUST reply with a data form containing the FORM_TYPE field and the "accept" field set to "0" or "false":</p>
    <p class="caption"><a name="example-8" id="example-8"></a>Example 8. User cancels stanza session negotiation</p><div class="indent"><pre>
&lt;message type='normal'
         from='romeo@montague.net/orchard'
         to='juliet@capulet.com/balcony'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='result'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='accept'&gt;&lt;value&gt;0&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
    </pre></div>
  </div>
<h2>5.
       <a name="move" id="move">Moving A Session to a Different Resource</a></h2>
  <p class="" style="">Either party MAY ask to continue the session using another of its resources. The requesting party does this by submitting a form with a "continue" field containing the value of the new resource:</p>
  <p class="caption"><a name="example-9" id="example-9"></a>Example 9. One party asks to switch session to another of its resources</p><div class="indent"><pre>
&lt;message type='normal'
         from='juliet@capulet.com/balcony'
         to='romeo@montague.net/orchard'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='submit'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='continue'&gt;&lt;value&gt;PDA&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
  </pre></div>
  <p class="" style="">The requesting party SHOULD NOT send stanzas within the session from either resource until the other party has accepted the switch to the new resource.</p>
  <p class="" style="">The other client SHOULD accept the switch automatically since the requesting party might otherwise be unable to continue the session:</p>
  <p class="caption"><a name="example-10" id="example-10"></a>Example 10. Other client accepts switch</p><div class="indent"><pre>
&lt;message type='normal'
         from='romeo@montague.net/orchard'
         to='juliet@capulet.com/balcony'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='result'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='continue'&gt;&lt;value&gt;PDA&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
  </pre></div>
  <p class="" style="">Once the other party has accepted the switch then all stanzas sent within the session MUST be to or from the new resource. Note: Both parties MUST ensure that they comply with all the other stanza session negotiation parameters that were previously agreed for this session.</p>
<h2>6.
       <a name="renegotiate" id="renegotiate">Renegotiating a Session</a></h2>
  <p class="" style="">At any time during an existing session, either party MAY attempt to renegotiate the parameters of the session using the protocol described in <a href="#new">Negotiating a New Session</a>. The requesting party does this by sending a new &lt;message/&gt; stanza containing a feature negotiation form and a &lt;thread/&gt; element with the <span class="em">same</span> value as that of the existing session. Note: The "accept" field MUST NOT be included in a renegotiation form and the &lt;message/&gt; stanza MUST NOT contain a &lt;body/&gt; child element. The other fields MAY be different from the set of fields included in the initial stanza session negotiation form.</p>
  <p class="caption"><a name="example-11" id="example-11"></a>Example 11. One party requests renegotiation</p><div class="indent"><pre>
&lt;message type='normal'
         from='juliet@capulet.com/balcony'
         to='romeo@montague.net/orchard'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='form'&gt;
      &lt;field var='FORM_TYPE' type='hidden'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field label='Renegotiate?' type='boolean' var='renegotiate'&gt;
        &lt;value&gt;1&lt;/value&gt;
        &lt;required/&gt;
      &lt;/field&gt;
      &lt;field label='Message logging' type='list-single' var='logging'&gt;
        &lt;value&gt;mustnot&lt;/value&gt;
        &lt;option label='Disallow all message logging'&gt;
          &lt;value&gt;may&lt;/value&gt;
        &lt;/option&gt;
        &lt;required/&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
  </pre></div>
  <p class="" style="">The requesting party MAY continue to send stanzas within the session while it is waiting for the other party to either accept the parameters or report an error.</p>
  <p class="" style="">In order to accept the renegotiation, the other party shall send a message containing a data form of type "submit" with the 'renegotiate' field set to a value of "1" or "true".</p>
  <p class="caption"><a name="example-12" id="example-12"></a>Example 12. Other party accepts renegotiation and specifies parameters</p><div class="indent"><pre>
&lt;message type='normal'
         from='romeo@montague.net/orchard'
         to='juliet@capulet.com/balcony'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='submit'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='renegotiate'&gt;&lt;value&gt;1&lt;/value&gt;&lt;/field&gt;
      &lt;field var='logging'&gt;&lt;value&gt;may&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
  </pre></div>
  <p class="" style="">Note: Both parties MUST consider the renegotiation to be complete as soon as the parameter acceptance message has been sent (or received).</p>
  <p class="" style="">Note: The requesting party SHOULD NOT send a renegotiation completion or cancelation message (see <a href="#new-complete">Completing or Canceling the Negotiation</a>).</p>
  <p class="" style="">Note: Both parties MUST ensure that they continue to comply with all the stanza session negotiation parameters that were not renegotiated but had previously been agreed for this session.</p>
  <p class="" style="">In order to reject the renegotiation, the other party shall send a message containing a data form of type "submit" with the 'renegotiate' field set to a value of "0" or "false".</p>
  <p class="caption"><a name="example-13" id="example-13"></a>Example 13. Other party rejects renegotiation</p><div class="indent"><pre>
&lt;message type='normal'
         from='romeo@montague.net/orchard'
         to='juliet@capulet.com/balcony'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='submit'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='renegotiate'&gt;&lt;value&gt;0&lt;/value&gt;&lt;/field&gt;
      &lt;field var='logging'&gt;&lt;value&gt;may&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
  </pre></div>
  <p class="" style="">If the other party's client does not support one or more of the <span class="em">required</span> features, it SHOULD return a &lt;feature-not-implemented/&gt; error. If the other party's client supports <span class="em">none</span> of the options for one or more <span class="em">required</span> fields, it SHOULD return a &lt;not-acceptable/&gt; error (see <a href="#new-reject">Rejecting a Session</a>). Note: In any of these cases the existing negotiated session parameters are maintained. Either party MAY choose to terminate the session only as specified in the section <a href="#terminate">Terminating a Session</a>.</p>
<h2>7.
       <a name="terminate" id="terminate">Terminating a Session</a></h2>
  <p class="" style="">In order to explicitly terminate a negotiated session, the party that wishes to end the session MUST do so by sending a &lt;message/&gt; containing a data form of type "submit". The &lt;message/&gt; stanza MUST contain a &lt;thread/&gt; element with the same XML character data as the original initiation request. The &lt;message/&gt; stanza MUST NOT contain a &lt;body/&gt; child element. The data form containing a boolean field named "terminate" set to a value of "1" or "true".</p>
  <p class="caption"><a name="example-14" id="example-14"></a>Example 14. One party terminates session</p><div class="indent"><pre>
&lt;message type='normal'
         from='juliet@capulet.com/balcony'
         to='romeo@montague.net/orchard'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='submit'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='terminate'&gt;&lt;value&gt;1&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
  </pre></div>
  <p class="" style="">Both parties MUST then consider the session to be ended.</p>
  <p class="" style="">The other party's client MAY explicitly acknowledge the termination of the session by sending a &lt;message/&gt; containing a data form of type "result", and the value of the "terminate" field set to "1" or "true" (see <span class="ref">Encrypted Session Negotiation</span> for a practical example). The client MUST mirror the &lt;thread/&gt; value it received.</p>
  <p class="caption"><a name="example-15" id="example-15"></a>Example 15. Other party acknowledges session termination</p><div class="indent"><pre>
&lt;message type='normal'
         from='romeo@montague.net/orchard'
         to='juliet@capulet.com/balcony'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='result'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='terminate'&gt;&lt;value&gt;1&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
  </pre></div>
<h2>8.
       <a name="parameters" id="parameters">Defined Parameters</a></h2>
  <p class="" style="">This section defines the parameters for stanza session negotiation parameters and whether they must, should, or may be included in the initial negotiation form. Additional parameters may be registered as described in the <a href="#registrar">XMPP Registrar Considerations</a> section of this document.</p>
  <p class="caption"><a name="table-1" id="table-1"></a>Table 1: Form Fields</p><table border="1" cellpadding="3" cellspacing="0">
    <tr class="body">
      <th colspan="" rowspan="">Name</th>
      <th colspan="" rowspan="">Definition</th>
      <th colspan="" rowspan="">Inclusion</th>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">accept</td>
      <td colspan="" rowspan="">Whether the receiving party wishes to accept the invitation</td>
      <td colspan="" rowspan="">MUST</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">continue</td>
      <td colspan="" rowspan="">Another resource with which to continue the session</td>
      <td colspan="" rowspan="">N/A (used to move a session)</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">disclosure</td>
      <td colspan="" rowspan="">Whether and to what extent the content, keys, and identities can be disclosed to third parties; the options are "never" (disclosure must never occur), "disabled" (only disclosure required by law shall occur), and "enabled" (disclosure may occur)</td>
      <td colspan="" rowspan="">SHOULD</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">http://jabber.org/protocol/chatstates</td>
      <td colspan="" rowspan="">Whether the parties may exchange Chat State Notifications per XEP-0085; the options are "may" and "mustnot"</td>
      <td colspan="" rowspan="">OPTIONAL</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">http://jabber.org/protocol/xhtml-im</td>
      <td colspan="" rowspan="">Whether the parties may exchange XHTML formatting per XEP-0071; the options are "may" and "must not"</td>
      <td colspan="" rowspan="">OPTIONAL</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">language</td>
      <td colspan="" rowspan="">The preferred natural language(s) for information exchange, using language codes defined in accordance with <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc4646">RFC 4646</a></span>  [<a href="#nt-id2262777">19</a>]</td>
      <td colspan="" rowspan="">SHOULD</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">logging</td>
      <td colspan="" rowspan="">Whether the parties may log messages; the options are "may" and "mustnot"</td>
      <td colspan="" rowspan="">SHOULD</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">multisession</td>
      <td colspan="" rowspan="">Whether to allow multiple concurrent sessions between the full JIDs of the parties; this is a boolean variable that defaults to false</td>
      <td colspan="" rowspan="">SHOULD</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">renegotiate</td>
      <td colspan="" rowspan="">Whether the receiving party wishes to renegotiate the session</td>
      <td colspan="" rowspan="">N/A (used to renegotiate a session)</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">security</td>
      <td colspan="" rowspan="">The minimum security level for secure connections between the parties; the options are "none" (a secure connection is not required), "c2s" (both parties must be securely connected to their servers), and "e2e" (both parties must be securely connected to each other, for example via Encrypted Sessions)</td>
      <td colspan="" rowspan="">SHOULD</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">terminate</td>
      <td colspan="" rowspan="">Whether the receiving party wishes to terminate the session</td>
      <td colspan="" rowspan="">N/A (used to terminate a session)</td>
    </tr>
  </table>
<h2>9.
       <a name="impl" id="impl">Implementation Notes</a></h2>
  <div class="indent"><h3>9.1 <a name="impl-auto" id="impl-auto">Auto Accept or Reject</a></h3>
    <p class="" style="">A client MAY require a human user to approve each stanza session negotiation request, however it is RECOMMENDED that it accepts or rejects automatically as many requests as possible, based on a set of user-configurable policies (see <a href="#secure-leak">Presence Leaks</a>).</p>
  </div>
  <div class="indent"><h3>9.2 <a name="impl-close" id="impl-close">Persisting Sessions</a></h3>
    <p class="" style="">Stanza session negotiation sometimes requires the involvement of either or both human users, and if human input is required but the user is away then session establishment may be delayed indefinitely. So, in order to minimise the number of user interruptions and delays, clients SHOULD reuse existing sessions whenever possible. For example, a client SHOULD NOT terminate sessions unless the user is going offline, even if its user closes a window associated with the session.</p>
  </div>
  <div class="indent"><h3>9.3 <a name="impl-presence" id="impl-presence">Sharing Presence</a></h3>
    <p class="" style="">If so negotiated via the 'presence' field, two parties who do not have subscriptions to each other's presence (as specified in <span class="ref">XMPP-IM</span>) may share presence by sending directed presence after the session is negotiated.</p>
    <p class="caption"><a name="example-16" id="example-16"></a>Example 16. User sends directed presence to contact</p><div class="indent"><pre>
&lt;presence from='romeo@montague.net/orchard' to='juliet@capulet.com/balcony'/&gt;
    </pre></div>
    <p class="caption"><a name="example-17" id="example-17"></a>Example 17. Contact sends directed presence to user</p><div class="indent"><pre>
&lt;presence from='juliet@capulet.com/balcony' to='romeo@montague.net/orchard'/&gt;
    </pre></div>
    <p class="" style="">In accordance with the rules specified in <span class="ref">XMPP-IM</span>, sharing presence enables one party's server to send unavailable presence to the other party if the sending party goes offline for any reason.</p>
  </div>
  <div class="indent"><h3>9.4 <a name="impl-unavail" id="impl-unavail">Unavailable Presence</a></h3>
    <p class="" style="">If a party receives an XMPP presence stanza of type "unavailable" from the full JID (&lt;node@domain.tld/resource&gt;) of the other party (i.e., the resource with which it has had an active session) during a session, the receiving party SHOULD assume that the other client will still be able to continue the session (perhaps it simply became "invisible", or it is persisting the state of the negotiated session until it reconnects and receives "offline" messages).</p>
    <p class="" style="">However, the receiving party MAY assume that the other client will <span class="em">not</span> be able to continue the session.  [<a href="#nt-id2263085">20</a>] In that case it MUST explicitly terminate the session (see <a href="#terminate">Terminating a Session</a>) -- since its assumption could be incorrect. If after terminating the session the receiving party later receives presence of type "available" from that same resource or another resource associated with the other party and the receiving party desires to restart the session, then it MUST initiate a new session (including a newly-generated ThreadID) with the other party. It MUST NOT renegotiate parameters for the terminated session. (Note: This is consistent with the handling of chat states as specified in <span class="ref">XEP-0085</span>.)</p>
  </div>
  <div class="indent"><h3>9.5 <a name="impl-sip" id="impl-sip">Mapping to SIP</a></h3>
    <p class="" style="">When mapping instant messaging flows to SIP, implementations SHOULD adhere to <span class="ref" style=""><a href="http://tools.ietf.org/html/draft-saintandre-xmpp-simple">draft-saintandre-xmpp-simple</a></span>  [<a href="#nt-id2263153">21</a>].</p>
    <p class="" style="">In addition, the following mappings apply to chat session negotiation:</p>
    <ul class="" style="">
      <li class="" style="">Initiation of a negotiated chat session maps to the semantics of the SIP INVITE method.</li>
      <li class="" style="">Renegotiation of a negotiated chat session also maps to the semantics of the SIP INVITE method.</li>
      <li class="" style="">Termination of a negotiated chat session maps to the semantics of the SIP BYE method.</li>
      <li class="" style="">The XMPP &lt;thread/&gt; value maps to the semantics of the SIP Call-ID attribute.</li>
    </ul>
  </div>
<h2>10.
       <a name="security" id="security">Security Considerations</a></h2>
  <div class="indent"><h3>10.1 <a name="secure-leak" id="secure-leak">Presence Leaks</a></h3>
    <p class="" style="">If a contact does not share its presence information with a user through a presence subscription (see <span class="ref">RFC 3921</span>) or if it blocks outbound presence notifications to the user (see <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0016.html">Server-Based Privacy Rules</a></span>  [<a href="#nt-id2263272">22</a>]), then it will effectively expose its presence if it accepts the user's stanza session negotiation request or returns an error to the user. Therefore, due care must be exercised in determining whether to accept the request or return an error. The contact's client SHOULD NOT automatically (i.e. without first asking the contact) either accept the user's request or return an error to the user unless the user is subscribed to the contact's presence and the contact is not blocking outbound presence notifications to the user. Note: There should be no need for the contact's client to consult the contact's block list (see <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0191.html">Simple Communications Blocking</a></span>  [<a href="#nt-id2263307">23</a>]), since if the user is on the block list then the contact would not receive the request from the user in the first place.</p>
  </div>
  <div class="indent"><h3>10.2 <a name="secure-local" id="secure-local">Localization</a></h3>
    <p class="" style="">If a client is configured to show a request &lt;form/&gt; to a human user instead of responding automatically, it SHOULD replace the content of the &lt;title/&gt; element and of all label attributes of the known and registered &lt;field/&gt; and &lt;option/&gt; elements with its own localised versions before showing the form to the user -- even if the form already appears to be in the correct language.</p>
    <p class="" style="">Note: If a client fails to localize the form, a malicious contact might, for example, either switch the labels on the 'security' and 'logging' fields, or use the &lt;title/&gt; to mislead the user regarding the identity of the contact.</p>
  </div>
<h2>11.
       <a name="iana" id="iana">IANA Considerations</a></h2>
  <p class="" style="">This document requires no interaction with the <span class="ref" style=""><a href="http://www.iana.org/">Internet Assigned Numbers Authority (IANA)</a></span>  [<a href="#nt-id2263384">24</a>].</p>
<h2>12.
       <a name="registrar" id="registrar">XMPP Registrar Considerations</a></h2>
  <div class="indent"><h3>12.1 <a name="ns" id="ns">Protocol Namespaces</a></h3>
    <p class="" style="">The <span class="ref" style=""><a href="http://www.xmpp.org/registrar/">XMPP Registrar</a></span>  [<a href="#nt-id2263454">25</a>] includes 'urn:xmpp:ssn' in its registry of protocol namespaces (see &lt;<a href="http://www.xmpp.org/registrar/namespaces.html">http://www.xmpp.org/registrar/namespaces.html</a>&gt;).</p>
  </div>
  <div class="indent"><h3>12.2 <a name="registrar-features" id="registrar-features">Service Discovery Features</a></h3>
    <p class="" style="">The XMPP Registrar includes 'urn:xmpp:ssn' in its registry of Service Discovery features (see &lt;<a href="http://www.xmpp.org/registrar/disco-features.html">http://www.xmpp.org/registrar/disco-features.html</a>&gt;).</p>
    <p class="caption">Registry Submission</p><div class="indent"><pre>
&lt;var&gt;
  &lt;name&gt;urn:xmpp:ssn&lt;/name&gt;
  &lt;desc&gt;Support for Stanza Session Negotiation and its FORM_TYPE&lt;/desc&gt;
  &lt;doc&gt;XEP-0155&lt;/doc&gt;
&lt;/var&gt;
    </pre></div>
  </div>
  <div class="indent"><h3>12.3 <a name="registrar-formtype" id="registrar-formtype">Field Standardization</a></h3>
    <p class="" style=""><span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0068.html">Field Standardization for Data Forms</a></span>  [<a href="#nt-id2263540">26</a>] defines a process for standardizing the fields used within Data Forms qualified by a particular namespace. The following fields are registered for use in Stanza Session Negotiation (see &lt;<a href="http://www.xmpp.org/registrar/formtypes.html">http://www.xmpp.org/registrar/formtypes.html</a>&gt;):</p>
    <p class="caption">Registry Submission</p><div class="indent"><pre>
&lt;form_type&gt;
  &lt;name&gt;urn:xmpp:ssn&lt;/name&gt;
  &lt;doc&gt;XEP-0155&lt;/doc&gt;
  &lt;desc&gt;
    Forms enabling negotation of a one-to-one
    session between two entities.
  &lt;/desc&gt;
  &lt;field
      var='accept'
      type='boolean'
      label='Whether to accept the invitation'/&gt;
  &lt;field
      var='continue'
      type='text-single'
      label='Another resource with which to continue the session'/&gt;
  &lt;field
      var="disclosure"
      type="list-single"
      label="Disclosure of content, decryption keys or identities"&gt;
    &lt;option label="Entities guarantee no disclosure features
                   exist (not even disabled features)"&gt;
      &lt;value&gt;never&lt;/value&gt;
    &lt;/option&gt;
    &lt;option label="Entities MUST NOT disclose (except for those
                   disclosures that are required by law)"&gt;
      &lt;value&gt;disabled&lt;/value&gt;
    &lt;/option&gt;
    &lt;option label="Entities MAY disclose"&gt;
      &lt;value&gt;enabled&lt;/value&gt;
    &lt;/option&gt;
  &lt;/field&gt;
  &lt;field
      var='http://jabber.org/protocol/chatstates'
      type='list-single'
      label='Whether may send Chat State Notifications per XEP-0085'&gt;
    &lt;option label='May Send'&gt;
      &lt;value&gt;may&lt;/value&gt;
    &lt;/option&gt;
    &lt;option label='Must Not Send'&gt;
      &lt;value&gt;mustnot&lt;/value&gt;
    &lt;/option&gt;
  &lt;/field&gt;
  &lt;field
      var='http://jabber.org/protocol/xhtml-im'
      type='list-single'
      label='Whether allowed to use XHTML-IM formatting per XEP-0071'&gt;
    &lt;option label='May Send'&gt;
      &lt;value&gt;may&lt;/value&gt;
    &lt;/option&gt;
    &lt;option label='Must Not Send'&gt;
      &lt;value&gt;mustnot&lt;/value&gt;
    &lt;/option&gt;
  &lt;/field&gt;
  &lt;field
      var='language'
      type='list-single'
      label='Primary written language of the chat (each
             value appears in order of preference and
             conforms to RFC 4646 and the IANA registry)'/&gt;
  &lt;field
      var='logging'
      type='list-single'
      label='Whether allowed to log messages (i.e.,
             whether Off-The-Record mode is required)'&gt;
    &lt;option label='Allow Message Logging'&gt;
      &lt;value&gt;may&lt;/value&gt;
    &lt;/option&gt;
    &lt;option label='Disallow All Message Logging (i.e., must
                   disable absolutely all message
                   logging including automatic archiving
                   -- see XEP-0136'&gt;
      &lt;value&gt;mustnot&lt;/value&gt;
    &lt;/option&gt;
  &lt;/field&gt;
  &lt;field
      var='multisession'
      type='boolean'
      label='Whether to allow multiple concurrent sessions between the parties'/&gt;
  &lt;field
      var='renegotiate'
      type='boolean'
      label='Whether to renegotiate the session'/&gt;
  &lt;field
      var='security'
      type='list-single'
      label='Minimum security level'&gt;
    &lt;option label='Secure connections not required'&gt;
      &lt;value&gt;none&lt;/value&gt;
    &lt;/option&gt;
    &lt;option label='Both parties must be securely connected to their servers'&gt;
      &lt;value&gt;c2s&lt;/value&gt;
    &lt;/option&gt;
    &lt;option label='Both parties must be securely connected to each other'&gt;
      &lt;value&gt;e2e&lt;/value&gt;
    &lt;/option&gt;
  &lt;/field&gt;
  &lt;field
      var='terminate'
      type='boolean'
      label='Whether to terminate the session'/&gt;
&lt;/form_type&gt;
      </pre></div>
  </div>
<h2>13.
       <a name="schema" id="schema">XML Schema</a></h2>
  <p class="" style="">This proposal re-uses the format defined in XEP-0020 and therefore does not require a dedicated schema.</p>
<h2>14.
       <a name="ack" id="ack">Acknowledgements</a></h2>
  <p class="" style="">Thanks to Thomas Charron and Jean-Louis Seguineau for their feedback.</p>
<hr /><h2><a name="notes" id="notes"></a>Notes</h2><div class="indent"><p><a name="nt-id2251532" id="nt-id2251532">1</a>. XEP-0201: Best Practices for Message Threads &lt;<a href="http://www.xmpp.org/extensions/xep-0201.html">http://www.xmpp.org/extensions/xep-0201.html</a>&gt;.</p><p><a name="nt-id2251584" id="nt-id2251584">2</a>. XEP-0116: Encrypted Session Negotiation &lt;<a href="http://www.xmpp.org/extensions/xep-0116.html">http://www.xmpp.org/extensions/xep-0116.html</a>&gt;.</p><p><a name="nt-id2261062" id="nt-id2261062">3</a>. XEP-0136: Message Archiving &lt;<a href="http://www.xmpp.org/extensions/xep-0136.html">http://www.xmpp.org/extensions/xep-0136.html</a>&gt;.</p><p><a name="nt-id2261096" id="nt-id2261096">4</a>. XEP-0030: Service Discovery &lt;<a href="http://www.xmpp.org/extensions/xep-0030.html">http://www.xmpp.org/extensions/xep-0030.html</a>&gt;.</p><p><a name="nt-id2261121" id="nt-id2261121">5</a>. XEP-0115: Entity Capabilities &lt;<a href="http://www.xmpp.org/extensions/xep-0115.html">http://www.xmpp.org/extensions/xep-0115.html</a>&gt;.</p><p><a name="nt-id2261151" id="nt-id2261151">6</a>. RFC 3261: Session Initiation Protocol (SIP) &lt;<a href="http://tools.ietf.org/html/rfc3261">http://tools.ietf.org/html/rfc3261</a>&gt;.</p><p><a name="nt-id2261075" id="nt-id2261075">7</a>. In essence, a stanza session negotiation request as specified herein is functionally equivalent to a SIP INVITE request, and acceptance of such a request is functionally equivalent to sending a SIP 200 OK response; see Section 17 of <span class="ref">RFC 3261</span>.</p><p><a name="nt-id2261200" id="nt-id2261200">8</a>. XEP-0020: Feature Negotiation &lt;<a href="http://www.xmpp.org/extensions/xep-0020.html">http://www.xmpp.org/extensions/xep-0020.html</a>&gt;.</p><p><a name="nt-id2261406" id="nt-id2261406">9</a>. The &lt;message/&gt; stanza is used because the user does not necessarily know which of the contact's resources is most available (or indeed if the contact is online).</p><p><a name="nt-id2261439" id="nt-id2261439">10</a>. RFC 3921: Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence &lt;<a href="http://tools.ietf.org/html/rfc3921">http://tools.ietf.org/html/rfc3921</a>&gt;.</p><p><a name="nt-id2261417" id="nt-id2261417">11</a>. In accordance with Section 3.2.2.1 of <span class="ref">XML Schema Part 2: Datatypes</span>, the allowable lexical representations for the xs:boolean datatype are the strings "0" and "false" for the concept 'false' and the strings "1" and "true" for the concept 'true'; implementations MUST support both styles of lexical representation.</p><p><a name="nt-id2261505" id="nt-id2261505">12</a>. XEP-0160: Best Practices for Handling Offline Messages &lt;<a href="http://www.xmpp.org/extensions/xep-0160.html">http://www.xmpp.org/extensions/xep-0160.html</a>&gt;.</p><p><a name="nt-id2261532" id="nt-id2261532">13</a>. XEP-0079: Advanced Message Processing &lt;<a href="http://www.xmpp.org/extensions/xep-0079.html">http://www.xmpp.org/extensions/xep-0079.html</a>&gt;.</p><p><a name="nt-id2261550" id="nt-id2261550">14</a>. XEP-0136: Message Archiving &lt;<a href="http://www.xmpp.org/extensions/xep-0136.html">http://www.xmpp.org/extensions/xep-0136.html</a>&gt;.</p><p><a name="nt-id2261561" id="nt-id2261561">15</a>. A client MUST NOT set the 'logging' field to 'mustnot' unless it has confirmed that its server will allow it to switch off Automated Archiving (see <span class="ref">Message Archiving</span>).</p><p><a name="nt-id2261605" id="nt-id2261605">16</a>. XEP-0071: XHTML-IM &lt;<a href="http://www.xmpp.org/extensions/xep-0071.html">http://www.xmpp.org/extensions/xep-0071.html</a>&gt;.</p><p><a name="nt-id2261630" id="nt-id2261630">17</a>. XEP-0085: Chat State Notifications &lt;<a href="http://www.xmpp.org/extensions/xep-0085.html">http://www.xmpp.org/extensions/xep-0085.html</a>&gt;.</p><p><a name="nt-id2262145" id="nt-id2262145">18</a>. See <span class="ref">Encrypted Session Negotiation</span> for example of other instances where the user might find the values submitted by the contact unacceptable.</p><p><a name="nt-id2262777" id="nt-id2262777">19</a>. RFC 4646: Tags for Identifying Languages &lt;<a href="http://tools.ietf.org/html/rfc4646">http://tools.ietf.org/html/rfc4646</a>&gt;.</p><p><a name="nt-id2263085" id="nt-id2263085">20</a>. In general, if a party is not subscribing to the other party's presence then it will never assume the other party is is unable to continue a session.</p><p><a name="nt-id2263153" id="nt-id2263153">21</a>. Basic Messaging and Presence Interoperability between the Extensible Messaging and Presence Protocol (XMPP) and Session Initiation Protocol (SIP) for Instant Messaging and Presence Leveraging Extensions (SIMPLE) &lt;<a href="http://tools.ietf.org/html/draft-saintandre-xmpp-simple">http://tools.ietf.org/html/draft-saintandre-xmpp-simple</a>&gt; (work in progress).</p><p><a name="nt-id2263272" id="nt-id2263272">22</a>. XEP-0016: Server-Based Privacy Rules &lt;<a href="http://www.xmpp.org/extensions/xep-0016.html">http://www.xmpp.org/extensions/xep-0016.html</a>&gt;.</p><p><a name="nt-id2263307" id="nt-id2263307">23</a>. XEP-0191: Simple Communications Blocking &lt;<a href="http://www.xmpp.org/extensions/xep-0191.html">http://www.xmpp.org/extensions/xep-0191.html</a>&gt;.</p><p><a name="nt-id2263384" id="nt-id2263384">24</a>. The Internet Assigned Numbers Authority (IANA) is the central coordinator for the assignment of unique parameter values for Internet protocols, such as port numbers and URI schemes. For further information, see &lt;<a href="http://www.iana.org/">http://www.iana.org/</a>&gt;.</p><p><a name="nt-id2263454" id="nt-id2263454">25</a>. The XMPP Registrar maintains a list of reserved protocol namespaces as well as registries of parameters used in the context of XMPP extension protocols approved by the XMPP Standards Foundation. For further information, see &lt;<a href="http://www.xmpp.org/registrar/">http://www.xmpp.org/registrar/</a>&gt;.</p><p><a name="nt-id2263540" id="nt-id2263540">26</a>. XEP-0068: Field Data Standardization for Data Forms &lt;<a href="http://www.xmpp.org/extensions/xep-0068.html">http://www.xmpp.org/extensions/xep-0068.html</a>&gt;.</p></div><hr /><h2><a name="revs" id="revs"></a>Revision History</h2><div class="indent"><h4>Version 1.2 (2008-01-14)</h4><div class="indent"><p class="" style="">Specified that IM message bodies must not be included; added boolean multisession field to explicitly determine whether multiple concurrent sessions are allowed between the full JIDs of the parties.</p> (psa)
    </div><h4>Version 1.1 (2007-03-15)</h4><div class="indent"><p class="" style="">With XMPP Council approval, changed name from Chat Session Negotiation to Stanza Session Negotiation; also changed URN to urn:xmpp:ssn.</p> (ip/psa)
    </div><h4>Version 1.0 (2007-01-17)</h4><div class="indent"><p class="" style="">Per a vote of the XMPP Council, advanced specification to Draft; XMPP Registrar assigned urn:xmpp:chatneg as associated namespace.</p> (psa)
    </div><h4>Version 0.14 (2006-12-21)</h4><div class="indent"><p class="" style="">Specified state chart; added optional presence sharing; renamed otr field to logging; harmonized treatment of renegotiation; per XEP-0053, specified use of provisional namespace until spec advances to Draft.</p> (psa/ip)
    </div><h4>Version 0.13 (2006-11-27)</h4><div class="indent"><p class="" style="">Added disclosure field; changed namespace</p> (ip)
    </div><h4>Version 0.12 (2006-11-10)</h4><div class="indent"><p class="" style="">Removed accept field from renegotiation forms</p> (ip)
    </div><h4>Version 0.11 (2006-11-03)</h4><div class="indent"><p class="" style="">Removed reason field; added new implementation notes; many clarifications including the handling of required fields</p> (ip)
    </div><h4>Version 0.10 (2006-10-31)</h4><div class="indent"><p class="" style="">Defined handling of offline requests; specified localization of the title element and all labels; changed syntax of list of unacceptable fields; removed reason field from some examples; added confirmation message to initial negotiation; clarified the initial participating resources; removed id attributes.</p> (ip)
    </div><h4>Version 0.9 (2006-10-08)</h4><div class="indent"><p class="" style="">Added language field; replaced secure field with security field; changed type of otr, XHTML and Chat State fields from boolean to list-single; added not-acceptable error; several clarifications.</p> (ip)
    </div><h4>Version 0.8 (2006-10-02)</h4><div class="indent"><p class="" style="">Added continue field and optional terminate acknowledgement; specified renegotiation failure proceedure; added context to Introduction; changed unavailable presence handling; renamed logging field to otr.</p> (ip)
    </div><h4>Version 0.7 (2006-07-14)</h4><div class="indent"><p class="" style="">Added secure field from XEP-0116.</p> (psa)
    </div><h4>Version 0.6 (2006-07-13)</h4><div class="indent"><p class="" style="">Specified that a client must re-initiate if it receives presence unavailable; changed document type to Standards Track.</p> (psa)
    </div><h4>Version 0.5 (2006-01-24)</h4><div class="indent"><p class="" style="">Added renegotiate use case.</p> (psa)
    </div><h4>Version 0.4 (2006-01-03)</h4><div class="indent"><p class="" style="">Added terminate use case; further specified mapping to SIP.</p> (psa)
    </div><h4>Version 0.3 (2005-12-30)</h4><div class="indent"><p class="" style="">Further specified use of id attribute and thread element.</p> (psa)
    </div><h4>Version 0.2 (2005-07-15)</h4><div class="indent"><p class="" style="">Further described contexts in which stanza session negotiation could be useful; added more examples; added reference to SIP RFC and explained basic mapping to SIP INVITE method; added XMPP Registrar considerations.</p> (psa)
    </div><h4>Version 0.1 (2005-07-14)</h4><div class="indent"><p class="" style="">Initial version.</p> (psa)
    </div><h4>Version 0.0.1 (2005-07-12)</h4><div class="indent"><p class="" style="">First draft.</p> (psa)
    </div></div><hr /><p>END</p></body></html>
