<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>XEP-0176: Jingle ICE-UDP Transport Method</title><link rel="stylesheet" type="text/css" href="/xmpp.css" /><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" /><meta name="DC.Title" content="Jingle ICE-UDP Transport Method" /><meta name="DC.Creator" content="Joe Beda" /><meta name="DC.Creator" content="Scott Ludwig" /><meta name="DC.Creator" content="Peter Saint-Andre" /><meta name="DC.Creator" content="Joe Hildebrand" /><meta name="DC.Creator" content="Sean Egan" /><meta name="DC.Description" content="This specification defines a Jingle transport method that results in sending media data using raw datagram sockets via the User Datagram Protocol (UDP). This transport method is negotiated via the Interactive Connectivity Establishment (ICE) methodology defined by the IETF and thus provides robust NAT traversal for media traffic." /><meta name="DC.Publisher" content="XMPP Standards Foundation" /><meta name="DC.Contributor" content="XMPP Extensions Editor" /><meta name="DC.Date" content="2008-02-29" /><meta name="DC.Type" content="XMPP Extension Protocol" /><meta name="DC.Format" content="XHTML" /><meta name="DC.Identifier" content="XEP-0176" /><meta name="DC.Language" content="en" /><meta name="DC.Rights" content="This XMPP Extension Protocol is copyright (c) 1999 - 2008 by the XMPP Standards Foundation (XSF)." /></head><body><h1>XEP-0176: Jingle ICE-UDP Transport Method</h1><p>This specification defines a Jingle transport method that results in sending media data using raw datagram sockets via the User Datagram Protocol (UDP). This transport method is negotiated via the Interactive Connectivity Establishment (ICE) methodology defined by the IETF and thus provides robust NAT traversal for media traffic.</p><hr /><p style="color:red">NOTICE: This document is currently within Last Call or under consideration by the XMPP Council for advancement to the next stage in the XSF standards process.</p><hr /><h2>Document Information</h2><p class="indent">
            Series: <a href="http://www.xmpp.org/extensions/">XEP</a><br />
            Number: 0176<br />
            Publisher: <a href="/xsf/">XMPP Standards Foundation</a><br />
            Status: 
            <a href="http://www.xmpp.org/extensions/xep-0001.html#states-Proposed">Proposed</a><br />
            Type:
            <a href="http://www.xmpp.org/extensions/xep-0001.html#types-Standards Track">Standards Track</a><br />
            Version: 0.16<br />
            Last Updated: 2008-02-29<br />
                Approving Body: <a href="http://www.xmpp.org/council/">XMPP Council</a><br />Dependencies: XMPP Core, XEP-0166<br />
                Supersedes: None<br />
                Superseded By: None<br />
            Short Name: TO BE ASSIGNED<br />
              Wiki Page: &lt;<a href="http://wiki.jabber.org/index.php/Jingle ICE-UDP Transport Method (XEP-0176)">http://wiki.jabber.org/index.php/Jingle ICE-UDP Transport Method (XEP-0176)</a>&gt;
            </p><hr /><h2>Author Information</h2><div class="indent"><h3>Joe Beda</h3><p class="indent">
        Email:
        <a href="mailto:jbeda@google.com">jbeda@google.com</a><br />
        JabberID: 
        <a href="xmpp:jbeda@google.com">jbeda@google.com</a><br /></p><h3>Scott Ludwig</h3><p class="indent">
        Email:
        <a href="mailto:scottlu@google.com">scottlu@google.com</a><br />
        JabberID: 
        <a href="xmpp:scottlu@google.com">scottlu@google.com</a><br /></p><h3>Peter Saint-Andre</h3><p class="indent">
        JabberID: 
        <a href="xmpp:stpeter@jabber.org">stpeter@jabber.org</a><br />
        URI: 
        <a href="https://stpeter.im/">https://stpeter.im/</a><br /></p><h3>Joe Hildebrand</h3><p class="indent">
        Email:
        <a href="mailto:jhildebrand@jabber.com">jhildebrand@jabber.com</a><br />
        JabberID: 
        <a href="xmpp:hildjj@jabber.org">hildjj@jabber.org</a><br /></p><h3>Sean Egan</h3><p class="indent">
        Email:
        <a href="mailto:seanegan@google.com">seanegan@google.com</a><br />
        JabberID: 
        <a href="xmpp:seanegan@google.com">seanegan@google.com</a><br /></p></div><hr /><h2>Legal Notices</h2><div class="indent"><h3>Copyright</h3>This XMPP Extension Protocol is copyright (c) 1999 - 2008 by the XMPP Standards Foundation (XSF).<h3>Permissions</h3>Permission is hereby granted, free of charge, to any person obtaining a copy of this specification (the "Specification"), to make use of the Specification without restriction, including without limitation the rights to implement the Specification in a software program, deploy the Specification in a network service, and copy, modify, merge, publish, translate, distribute, sublicense, or sell copies of the Specification, and to permit persons to whom the Specification is furnished to do so, subject to the condition that the foregoing copyright notice and this permission notice shall be included in all copies or substantial portions of the Specification. Unless separate permission is granted, modified works that are redistributed shall not contain misleading information regarding the authors, title, number, or publisher of the Specification, and shall not claim endorsement of the modified works by the authors, any organization or project to which the authors belong, or the XMPP Standards Foundation.<h3>Disclaimer of Warranty</h3><span style="font-weight: bold">## NOTE WELL: This Specification is provided on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or implied, including, without limitation, any warranties or conditions of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A PARTICULAR PURPOSE. In no event shall the XMPP Standards Foundation or the authors of this Specification be liable for any claim, damages, or other liability, whether in an action of contract, tort, or otherwise, arising from, out of, or in connection with the Specification or the implementation, deployment, or other use of the Specification. ##</span><h3>Limitation of Liability</h3>In no event and under no legal theory, whether in tort (including negligence), contract, or otherwise, unless required by applicable law (such as deliberate and grossly negligent acts) or agreed to in writing, shall the XMPP Standards Foundation or any author of this Specification be liable for damages, including any direct, indirect, special, incidental, or consequential damages of any character arising out of the use or inability to use the Specification (including but not limited to damages for loss of goodwill, work stoppage, computer failure or malfunction, or any and all other commercial damages or losses), even if the XMPP Standards Foundation or such author has been advised of the possibility of such damages.<h3>IPR Conformance</h3>This XMPP Extension Protocol has been contributed in full conformance with the XSF's Intellectual Property Rights Policy (a copy of which may be found at &lt;<a href="http://www.xmpp.org/extensions/ipr-policy.shtml">http://www.xmpp.org/extensions/ipr-policy.shtml</a>&gt; or obtained by writing to XSF, P.O. Box 1641, Denver, CO 80201 USA).</div><hr /><h2>Discussion Venue</h2><p class="indent">The preferred venue for discussion of this document is the Standards discussion list: &lt;<a href="http://mail.jabber.org/mailman/listinfo/standards">http://mail.jabber.org/mailman/listinfo/standards</a>&gt;.</p><p class="indent">Errata may be sent to &lt;<a href="mailto:editor@xmpp.org">editor@xmpp.org</a>&gt;.</p><h2>Relation to XMPP</h2><p class="indent">The Extensible Messaging and Presence Protocol (XMPP) is defined in the XMPP Core (RFC 3920) and XMPP IM (RFC 3921) specifications contributed by the XMPP Standards Foundation to the Internet Standards Process, which is managed by the Internet Engineering Task Force in accordance with RFC 2026. Any protocol defined in this document has been developed outside the Internet Standards Process and is to be understood as an extension to XMPP rather than as an evolution, development, or modification of XMPP itself.</p><h2>Conformance Terms</h2><p class="indent">The following keywords as used in this document are to be interpreted as described in <a href="http://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>: "MUST", "SHALL", "REQUIRED"; "MUST NOT", "SHALL NOT"; "SHOULD", "RECOMMENDED"; "SHOULD NOT", "NOT RECOMMENDED"; "MAY", "OPTIONAL".</p><hr /><h2>Table of Contents</h2><div class="indent"><p><br />1.  <a href="#intro">Introduction</a><br />2.  <a href="#terms">Glossary</a><br />3.  <a href="#reqs">Requirements</a><br />4.  <a href="#conformance">Jingle Conformance</a><br />5.  <a href="#protocol">Protocol Description</a><br />   
      5.1.  <a href="#protocol-flow">Flow</a><br />   
      5.2.  <a href="#protocol-initiate">Transport Initiation</a><br />   
      5.3.  <a href="#protocol-response">Response</a><br />   
      5.4.  <a href="#protocol-candidates">Candidate Negotiation</a><br />      
      5.4.1.  <a href="#protocol-candidates-syntax">Syntax of Candidate Element</a><br />      
      5.4.2.  <a href="#protocol-candidates-exchange">Exchange of Candidates</a><br />   
      5.5.  <a href="#protocol-checks">Connectivity Checks</a><br />   
      5.6.  <a href="#protocol-acceptance">Acceptance of Successful Candidate</a><br />   
      5.7.  <a href="#protocol-modify">Modifying an Existing Candidate</a><br />   
      5.8.  <a href="#protocol-renegotiate">Negotiating a New Candidate</a><br />6.  <a href="#support">Determining Support</a><br />7.  <a href="#impl">Implementation Notes</a><br />8.  <a href="#deploy">Deployment Notes</a><br />9.  <a href="#security">Security Considerations</a><br />10.  <a href="#iana">IANA Considerations</a><br />11.  <a href="#registrar">XMPP Registrar Considerations</a><br />   
      11.1.  <a href="#ns">Protocol Namespaces</a><br />   
      11.2.  <a href="#registrar-transports">Jingle Transport Methods</a><br />12.  <a href="#schema">XML Schema</a><br />13.  <a href="#ack">Acknowledgements</a><br /><a href="#notes">Notes</a><br /><a href="#revs">Revision History</a></p></div><hr /><h2>1.
       <a name="intro" id="intro">Introduction</a></h2>
  <p class="" style=""><span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0166.html">Jingle</a></span>  [<a href="#nt-id2251551">1</a>] defines a framework for negotiating and managing out-of-band data sessions over XMPP. In order to provide a flexible framework, the base Jingle specification defines neither data transport methods nor application formats, leaving that up to separate specifications.</p>
  <p class="" style="">The current document defines a transport method for establishing and managing data exchanges between XMPP entities over the User Datagram Protocol (see <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc0768">RFC 768</a></span>  [<a href="#nt-id2251574">2</a>]), using the ICE methodology developed within the IETF and specified in <span class="ref" style=""><a href="http://tools.ietf.org/html/draft-ietf-mmusic-ice">Interactive Connectivity Establishment (ICE)</a></span>  [<a href="#nt-id2251602">3</a>] (hereafter referred to as <span class="ref">ICE-CORE</span>). Use of the <span class="strong">ice-udp</span> method results in a lossy transport suitable for media applications where some packet loss is tolerable (e.g., audio and video).</p>
  <p class="" style="">Note: <span class="ref">ICE-CORE</span> has been approved for publication as an RFC but has not yet been published as an RFC. While every effort has been made to keep this document synchronized with <span class="ref">ICE-CORE</span>, the interested reader is referred to <span class="ref">ICE-CORE</span> for a detailed description of the ICE methodology.</p>
  <p class="" style="">The process for ICE negotiation is largely the same in Jingle as it is in ICE. There are several differences:</p>
  <ul class="" style="">
    <li class="" style="">Instead of using SIP as the signalling channel, Jingle uses XMPP as the signalling channel.</li>
    <li class="" style="">In Jingle, each candidate transport is sent in a separate IQ exchange (rather than sending all candidates at once as in <span class="ref">ICE-CORE</span>).  [<a href="#nt-id2261229">4</a>]</li>
    <li class="" style="">Syntax from the Session Description Protocol (see <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc4566">RFC 4566</a></span>  [<a href="#nt-id2261270">5</a>]) is mapped to an XML syntax suitable for sending over the XMPP signalling channel.</li>
    <li class="" style="">ICE candidates can be upgraded during a session (e.g., to change an IP address).</li>
    <li class="" style="">Either party can continue to send ICE candidates throughout a session and renegotiate which candidate will be used.</li>
  </ul>
<h2>2.
       <a name="terms" id="terms">Glossary</a></h2>
  <p class="" style="">The reader is referred to <span class="ref">ICE-CORE</span> for a description of various terms used in the context of ICE. Those terms are not reproduced here.</p>
<h2>3.
       <a name="reqs" id="reqs">Requirements</a></h2>
  <p class="" style="">The Jingle transport method defined herein are designed to meet the following requirements:</p>
  <ol start="" class="" style="">
    <li class="" style="">Make it possible to establish and manage out-of-band connections between two XMPP entities, even if they are behind Network Address Translators (NATs) or firewalls.</li>
    <li class="" style="">Enable use of UDP as the transport protocol itself.</li>
    <li class="" style="">Make it relatively easy to implement support in standard Jabber/XMPP clients.</li>
    <li class="" style="">Where communication with non-XMPP entities is needed, push as much complexity as possible onto server-side gateways between the XMPP network and the non-XMPP network.</li>
  </ol>
<h2>4.
       <a name="conformance" id="conformance">Jingle Conformance</a></h2>
   <p class="" style="">In accordance with Section 8 of <span class="ref">XEP-0166</span>, this document specifies the following information related to the Jingle ice-udp transport method:</p>
   <ol start="" class="" style="">
     <li class="" style=""><p class="" style="">The transport negotiation process is defined in the <a href="#protocol">Protocol Description</a> section of this document.</p></li>
     <li class="" style=""><p class="" style="">The semantics of the &lt;transport/&gt; element are defined in the <a href="#protocol-negotiate">ICE Negotiation</a> section of this document.</p></li>
     <li class="" style=""><p class="" style="">Successful negotiation of the ice-udp method results in use of a lossy transport that is suitable for applications where some packet loss is tolerable, such as audio and video.</p></li>
     <li class="" style=""><p class="" style="">If multiple components are to be communicated over the transport in the context of the Real-time Transport Protocol (RTP; see <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc3550">RFC 3550</a></span>  [<a href="#nt-id2261492">6</a>]), the component numbered "1" shall be associated with RTP and the component numbered "2" shall be associated with the Real Time Control Protocol (RTCP).</p></li>
   </ol>
<h2>5.
       <a name="protocol" id="protocol">Protocol Description</a></h2>
  <div class="indent"><h3>5.1 <a name="protocol-flow" id="protocol-flow">Flow</a></h3>
    <p class="" style="">The overall protocol flow for negotiation of the Jingle ICE-UDP Transport Method is as follows (note: many of these events happen simultaneously, not in sequence). The examples follow the scenario described in Section 17 of <span class="ref">ICE-CORE</span>, except that we substitute the Shakespearean characters "Romeo" and "Juliet" for the generic entities "L" and "R".</p>
    <p class="caption"></p><div class="indent"><pre>
INITIATOR                     RESPONDER
    |                                    |
    |  Jingle session-initiate           |
    |-----------------------------------&gt;|
    |  Jingle ack (XMPP IQ-result)       |
    |&lt;-----------------------------------|
    |  Jingle transport-info (candidate) |
    |-----------------------------------&gt;|
    |  Jingle ack (XMPP IQ-result)       |
    |&lt;-----------------------------------|
    |  Jingle transport-info (candidate) |
    |-----------------------------------&gt;|
    |  Jingle ack (XMPP IQ-result)       |
    |&lt;-----------------------------------|
    |  Jingle transport-info (candidate) |
    |&lt;-----------------------------------|
    |  Jingle ack (XMPP IQ-result)       |
    |-----------------------------------&gt;|
    |  STUN Binding Request              |
    |    (dropped)                       |
    |  x---------------------------------|
    |  STUN Binding Request              |
    |-----------------------------------&gt;|
    |  STUN Binding Result               |
    |&lt;-----------------------------------|
    |  STUN Binding Request              |
    |&lt;-----------------------------------|
    |  STUN Binding Result               |
    |-----------------------------------&gt;|
    |  Jingle content-replace            |
    |-----------------------------------&gt;|
    |  Jingle ack (XMPP IQ-result)       |
    |&lt;-----------------------------------|
    |  Jingle session-accept             |
    |&lt;-----------------------------------|
    |  Jingle ack (XMPP IQ-result)       |
    |-----------------------------------&gt;|
    |                                    |
    </pre></div>
  </div>
  <div class="indent"><h3>5.2 <a name="protocol-initiate" id="protocol-initiate">Transport Initiation</a></h3>
    <p class="" style="">In order for the initiator in a Jingle exchange to start the negotiation, it MUST send a Jingle "session-initiate" stanza as described in <span class="ref">XEP-0166</span>. A content type MUST include one transport method. If the initiator wishes to negotiate the ice-udp transport method for an application format, it MUST include an empty &lt;transport/&gt; child element qualified by the 'urn:xmpp:tmp:jingle:transports:ice-tcp' namespace (see <a href="#ns">Protocol Namespaces</a> regarding issuance of one or more permanent namespaces).</p>
    <p class="caption"><a name="example-1" id="example-1"></a>Example 1. Initiation</p><div class="indent"><pre>
&lt;iq from='romeo@montague.net/orchard'
    id='jingle1'
    to='juliet@capulet.com/balcony'
    type='set'&gt;
  &lt;jingle xmlns='urn:xmpp:tmp:jingle'
          action='session-initiate'
          initiator='romeo@montague.net/orchard'
          sid='a73sjjvkla37jfea'&gt;
    &lt;content name='this-is-the-audio-content' profile='RTP/AVP'&gt;
      &lt;description xmlns='urn:xmpp:tmp:jingle:apps:audio-rtp'&gt;
        [ ... ]
      &lt;/description&gt;
      &lt;transport xmlns='urn:xmpp:tmp:jingle:transports:ice-tcp'/&gt;
    &lt;/content&gt;
  &lt;/jingle&gt;
&lt;/iq&gt;
    </pre></div>
  </div>
  <div class="indent"><h3>5.3 <a name="protocol-response" id="protocol-response">Response</a></h3>
    <p class="" style="">As described in <span class="ref">XEP-0166</span>, to acknowledge receipt of the session initiation request, the responder returns an IQ-result:</p>
    <p class="caption"><a name="example-2" id="example-2"></a>Example 2. Responder acknowledges receipt of session-initiate request</p><div class="indent"><pre>
&lt;iq from='juliet@capulet.com/balcony'
    id='jingle1'
    to='romeo@montague.net/orchard'
    type='result'/&gt;
    </pre></div>
  </div>
  <div class="indent"><h3>5.4 <a name="protocol-candidates" id="protocol-candidates">Candidate Negotiation</a></h3>
    <p class="" style="">Once the responder acknowledges receipt of the session initiation request as shown above, both initiator and responder MUST immediately negotiate connectivity over the ICE transport by exchanging XML-formatted candidate transports for the channel. This negotiation proceeds immediately in order to maximize the possibility that media can be exchanged as quickly as possible.  [<a href="#nt-id2261660">7</a>]</p>
    <p class="" style="">Note: In order to expedite session establishment, the initiator MAY send transport candidates immediately after sending the "session-initiate" message and before receiving acknowledgement from the responder (i.e., the initiator MUST consider the session to be live even before receiving acknowledgement). Given in-order delivery, the responder should receive such "transport-info" messages after receiving the "session-initiate" message; if not, it is appropriate for the responder to return &lt;unknown-session/&gt; errors since it according to its state machine the session does not exist. If either party receives an &lt;unknown-session/&gt; from the other party, it MUST terminate the negotiation and the session.</p>
    <p class="" style="">The candidate syntax and negotiation flow are described below.</p>
    <div class="indent"><h3>5.4.1 <a name="protocol-candidates-syntax" id="protocol-candidates-syntax">Syntax of Candidate Element</a></h3>
      <p class="" style="">The following is an example of the candidate format:</p>
      <p class="caption"><a name="example-3" id="example-3"></a>Example 3. A candidate transport</p><div class="indent"><pre>
&lt;candidate component='1'
           foundation='1'
           generation='0'
           ip='10.0.1.1'
           network='0'
           port='8998'
           priority='2130706431'
           protocol='udp'
           pwd='asd88fgpdd777uzjYhagZg'
           type='host'
           ufrag='8hhy'/&gt;
      </pre></div>
      <p class="" style="">The attributes of the &lt;candidate/&gt; element are described in the following table:</p>
      <p class="caption"><a name="table-1" id="table-1"></a>Table 1: Candidate Attributes</p><table border="1" cellpadding="3" cellspacing="0">
        <tr class="body">
          <th colspan="" rowspan="">Name</th>
          <th colspan="" rowspan="">Description</th>
          <th colspan="" rowspan="">SDP Syntax</th>
          <th colspan="" rowspan="">Example</th>
        </tr>
        <tr class="body">
          <td colspan="" rowspan="">component</td>
          <td colspan="" rowspan="">A Component ID as defined in <span class="ref">ICE-CORE</span>.</td>
          <td colspan="" rowspan="">Component ID value in a=candidate line</td>
          <td colspan="" rowspan="">1</td>
        </tr>
        <tr class="body">
          <td colspan="" rowspan="">foundation</td>
          <td colspan="" rowspan="">A Foundation as defined in <span class="ref">ICE-CORE</span>.</td>
          <td colspan="" rowspan="">Foundation value in a=candidate line</td>
          <td colspan="" rowspan="">1</td>
        </tr>
        <tr class="body">
          <td colspan="" rowspan="">generation</td>
          <td colspan="" rowspan="">An index, starting at 0, that enables the parties to keep track of updates to the candidate throughout the life of the session.</td>
          <td colspan="" rowspan="">N/A</td>
          <td colspan="" rowspan="">0</td>
        </tr>
        <tr class="body">
          <td colspan="" rowspan="">ip</td>
          <td colspan="" rowspan="">The Internet Protocol (IP) address for the candidate transport mechanism; this may be either an IPv4 address or an IPv6 address.</td>
          <td colspan="" rowspan="">IP Address value in a=candidate line</td>
          <td colspan="" rowspan="">192.0.2.3</td>
        </tr>
        <tr class="body">
          <td colspan="" rowspan="">network</td>
          <td colspan="" rowspan="">An index, starting at 0, referencing which network this candidate is on for a given peer (used for diagnostic purposes if the calling hardware has more than one Network Interface Card).</td>
          <td colspan="" rowspan="">N/A</td>
          <td colspan="" rowspan="">0</td>
        </tr>
        <tr class="body">
          <td colspan="" rowspan="">port</td>
          <td colspan="" rowspan="">The port at the candidate IP address.</td>
          <td colspan="" rowspan="">Port value in a=candidate line</td>
          <td colspan="" rowspan="">45664</td>
        </tr>
        <tr class="body">
          <td colspan="" rowspan="">priority</td>
          <td colspan="" rowspan="">A Priority as defined in <span class="ref">ICE-CORE</span>
             [<a href="#nt-id2262005">8</a>]
          </td>
          <td colspan="" rowspan="">Priority value in a=candidate line</td>
          <td colspan="" rowspan="">2130706431</td>
        </tr>
        <tr class="body">
          <td colspan="" rowspan="">protocol</td>
          <td colspan="" rowspan="">The protocol to be used. The only allowable value is "udp".</td>
          <td colspan="" rowspan="">Transport protocol field in a=candidate line</td>
          <td colspan="" rowspan="">udp</td>
        </tr>
        <tr class="body">
          <td colspan="" rowspan="">pwd</td>
          <td colspan="" rowspan="">A Password as defined in <span class="ref">ICE-CORE</span>.</td>
          <td colspan="" rowspan="">a=ice-pwd line</td>
          <td colspan="" rowspan="">asd88fgpdd777uzjYhagZg</td>
        </tr>
        <tr class="body">
          <td colspan="" rowspan="">rel-addr</td>
          <td colspan="" rowspan="">A related address as defined in <span class="ref">ICE-CORE</span>.</td>
          <td colspan="" rowspan="">raddr value in a=candidate line</td>
          <td colspan="" rowspan="">10.0.1.1</td>
        </tr>
        <tr class="body">
          <td colspan="" rowspan="">rel-port</td>
          <td colspan="" rowspan="">A related port as defined in <span class="ref">ICE-CORE</span>.</td>
          <td colspan="" rowspan="">rport value in a=candidate line</td>
          <td colspan="" rowspan="">8998</td>
        </tr>
        <tr class="body">
          <td colspan="" rowspan="">rem-addr</td>
          <td colspan="" rowspan="">A IP address for a remote address as defined in <span class="ref">ICE-CORE</span>.</td>
          <td colspan="" rowspan="">connection-address value in a=remote-candidates line</td>
          <td colspan="" rowspan="">192.0.2.1</td>
        </tr>
        <tr class="body">
          <td colspan="" rowspan="">rem-port</td>
          <td colspan="" rowspan="">The port for a remote address as defined in <span class="ref">ICE-CORE</span>.</td>
          <td colspan="" rowspan="">port value in a=remote-candidates line</td>
          <td colspan="" rowspan="">3478</td>
        </tr>
        <tr class="body">
          <td colspan="" rowspan="">type</td>
          <td colspan="" rowspan="">A Candidate Type as defined in <span class="ref">ICE-CORE</span>. The allowable values are "host" for host candidates, "prflx" for peer reflexive candidates, "relay" for relayed candidates, and "srflx" for server reflexive candidates.</td>
          <td colspan="" rowspan="">Typ field in a=candidate line</td>
          <td colspan="" rowspan="">srflx</td>
        </tr>
        <tr class="body">
          <td colspan="" rowspan="">ufrag</td>
          <td colspan="" rowspan="">A User Fragment as defined in <span class="ref">ICE-CORE</span>.</td>
          <td colspan="" rowspan="">a=ice-ufrag line</td>
          <td colspan="" rowspan="">8hhy</td>
        </tr>
      </table>
    </div>
    <div class="indent"><h3>5.4.2 <a name="protocol-candidates-exchange" id="protocol-candidates-exchange">Exchange of Candidates</a></h3>
      <p class="" style="">The first step in negotiating connectivity is for each party to immediately begin sending transport candidates to the other party.  [<a href="#nt-id2262370">9</a>] These candidates SHOULD be gathered by following the procedure specified in Section 4.1.1 of <span class="ref">ICE-CORE</span> (typically by communicating with a stanadlone STUN server in order to discover the client's public IP address and port) and prioritized by following the procedure specified in Section 4.1.2 of <span class="ref">ICE-CORE</span>. Each candidate MUST be sent in a &lt;jingle/&gt; element with an action of "transport-info".</p>
      <p class="" style="">If the responder receives and can successfully process a given candidate, it returns an IQ-result (if not, for example because the candidate data is improperly formatted, it returns an error). Note: The responder is only indicating receipt of the candidate, not telling the initiator that the candidate will be used.</p>
      <p class="" style="">The initiator keeps sending candidates, one after the other (without stopping to receive an acknowledgement of receipt from the responder for each candidate) until it has exhausted its supply of possible or desirable candidate transports. (Because certain candidates may be more "expensive" in terms of bandwidth or processing power, the initiator may not want to advertise their existence unless necessary.) For each candidate, the responder acknowledges receipt.</p>
      <p class="" style="">At the same time (i.e., immediately after acknowledging receipt of the session-initiate request, not waiting for the initiator to begin or finish sending candidates), the responder also begins sending potential candidates, in order of desirability according to the responder. As above, the initiator acknowledges receipt of the candidates.</p>
      <p class="caption"><a name="example-4" id="example-4"></a>Example 4. Initiator sends some candidates</p><div class="indent"><pre>
&lt;iq from='romeo@montague.net/orchard'
    id='info1'
    to='juliet@capulet.com/balcony'
    type='set'&gt;
  &lt;jingle xmlns='urn:xmpp:tmp:jingle'
          action='transport-info'
          initiator='romeo@montague.net/orchard'
          sid='a73sjjvkla37jfea'&gt;
    &lt;content creator='initiator' name='this-is-the-audio-content' profile='RTP/AVP'&gt;
      &lt;transport xmlns='urn:xmpp:tmp:jingle:transports:ice-tcp'&gt;
        &lt;candidate component='1'
                   foundation='1'
                   generation='0'
                   ip='10.0.1.1'
                   network='1'
                   port='8998'
                   priority='2130706431'
                   protocol='udp'
                   pwd='asd88fgpdd777uzjYhagZg'
                   type='host'
                   ufrag='8hhy'/&gt;
      &lt;/transport&gt;
    &lt;/content&gt;
  &lt;/jingle&gt;
&lt;/iq&gt;

&lt;iq from='romeo@montague.net/orchard'
    id='info2'
    to='juliet@capulet.com/balcony'
    type='set'&gt;
  &lt;jingle xmlns='urn:xmpp:tmp:jingle'
          action='transport-info'
          initiator='romeo@montague.net/orchard'
          sid='a73sjjvkla37jfea'&gt;
    &lt;content creator='initiator' name='this-is-the-audio-content' profile='RTP/AVP'&gt;
      &lt;transport xmlns='urn:xmpp:tmp:jingle:transports:ice-tcp'&gt;
        &lt;candidate component='1'
                   foundation='2'
                   generation='0'
                   ip='192.0.2.3'
                   network='1'
                   port='45664'
                   priority='1694498815'
                   protocol='udp'
                   pwd='asd88fgpdd777uzjYhagZg'
                   rel-addr='10.0.1.1'
                   rel-port='8998'
                   type='srflx'
                   ufrag='8hhy'/&gt;
      &lt;/transport&gt;
    &lt;/content&gt;
  &lt;/jingle&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">For each candidate received, the other party (in this case the responder) MUST acknowledge receipt or return an error.</p>
      <p class="caption"><a name="example-5" id="example-5"></a>Example 5. Responder acknowledges receipt</p><div class="indent"><pre>
&lt;iq from='juliet@capulet.com/balcony'
    id='info1'
    to='romeo@montague.net/orchard'
    type='result'/&gt;

&lt;iq from='juliet@capulet.com/balcony'
    id='info2'
    to='romeo@montague.net/orchard'
    type='result'/&gt;
      </pre></div>
      <p class="" style="">At the same time (i.e., immediately after acknowledging the session-initation request, not waiting for the initiator to begin or finish sending candidates), the responder also sends candidates that may work for it.</p>
      <p class="caption"><a name="example-6" id="example-6"></a>Example 6. Responder sends candidates</p><div class="indent"><pre>
&lt;iq from='juliet@capulet.lit/balcony'
    to='romeo@montague.lit/orchard'
    id='info3'
    type='set'&gt;
  &lt;jingle xmlns='urn:xmpp:tmp:jingle'
          action='transport-info'
          initiator='romeo@montague.lit/orchard'
          sid='a73sjjvkla37jfea'&gt;
    &lt;content creator='initiator' name='this-is-the-audio-content' profile='RTP/AVP'&gt;
      &lt;transport xmlns='urn:xmpp:tmp:jingle:transports:ice-tcp-udp'&gt;
        &lt;candidate component='1'
                   foundation='1'
                   generation='0'
                   ip='192.0.2.1'
                   network='0'
                   port='3478'
                   priority='2130706431'
                   protocol='udp'
                   pwd='YH75Fviy6338Vbrhrlp8Yh'
                   type='host'
                   ufrag='9uB6'/&gt;
      &lt;/transport&gt;
    &lt;/content&gt;
  &lt;/jingle&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">As above for the candidates sent by the responder, here the initiator acknowledges receipt of the candidates sent by the responder.</p>
      <p class="caption"><a name="example-7" id="example-7"></a>Example 7. Initiator acknowledges receipt</p><div class="indent"><pre>
&lt;iq from='romeo@montague.lit/orchard'
    id='info3'
    to='juliet@capulet.lit/balcony'
    type='result'/&gt;
      </pre></div>
    </div>
  </div>
  <div class="indent"><h3>5.5 <a name="protocol-checks" id="protocol-checks">Connectivity Checks</a></h3>
    <p class="" style="">As the initiator and responder receive candidates, they probe the various candidate transports for connectivity. In performing these connectivity checks, each party SHOULD follow the procedure specified in Section 7 of <span class="ref">ICE-CORE</span>. The following business rules apply:</p>
    <ol start="" class="" style="">
      <li class="" style="">Each party sends a STUN Binding Request (see <span class="ref" style=""><a href="http://tools.ietf.org/html/draft-ietf-behave-rfc3489bis">draft-ietf-behave-rfc3489bis</a></span>  [<a href="#nt-id2251103">10</a>]) from each local candidate it generated to each remote candidate it received.</li>
      <li class="" style="">In accordance with <span class="ref">ICE-CORE</span>, the STUN Binding Request MUST include the PRIORITY attribute (computed according to Section 7.1.1.1. of <span class="ref">ICE-CORE</span>).</li>
      <li class="" style="">For the purposes of the Jingle ICE-UDP Transport Method, both parties are full ICE implementations and therefore the controlling role MUST be assumed by the initiator and the controlled role MUST be assumed by the responder.</li>
      <li class="" style="">The STUN Binding Requests generated by the initiator MAY include the USE-CANDIDATE attribute to indicate that the initiator wishes to cease checks for this component.</li>
      <li class="" style="">The STUN Binding Requests generated by the initiator MUST include the ICE-CONTROLLING attribute.</li>
      <li class="" style="">The STUN Binding Requests generated by the responder MUST include the ICE-CONTROLLED attribute.</li>
      <li class="" style="">The parties MUST use STUN short term credentials to authenticate requests and perform message integrity checks. As in <span class="ref">ICE-CORE</span>, the username in the STUN Binding Request is of the form "ufrag-of-sender:ufrag-of-peer" and the password is the value of the 'pwd' attribute provided by the peer.  [<a href="#nt-id2251184">11</a>]</li>
    </ol>
    <p class="" style="">When it receives a STUN Binding Request, each party MUST return a STUN Binding Response, which may indicate either an error case or the success case. As described in Section 7.1.2.2 of <span class="ref">ICE-CORE</span>, a connectivity check succeeds if the STUN transaction generated a success response, the source IP address and port of the response equals the destination IP address and port that the Binding Request was sent to, and the destination IP address and port of the response match the source IP address and port that the Binding Request was sent from.</p>
    <p class="" style="">For the candidates exchanged in the previous section, the connectivity checks would be as follows. In particular, the parties send one STUN Binding Request from each of their local candidates to each of the remote candidates.</p>
    <p class="caption"></p><div class="indent"><pre>
INITIATOR                  NAT                  RESPONDER
    |                       |                       |
    |                       | STUN Binding Request  |
    |                       | from 192.0.2.1:3478   |
    |                       | to   10.0.1.1:8998    |
    |                       |   (dropped)           |
    |                       |  x--------------------|
    | STUN Binding Request  |                       |
    | from 10.0.1.1:8998    |                       |
    | to   192.0.2.1:3478   |                       |
    | USE-CANDIDATE         |                       |
    |----------------------&gt;|                       |
    |                       | STUN Binding Request  |
    |                       | from 192.0.2.3:45664  |
    |                       | to   192.0.2.1:3478   |
    |                       | USE-CANDIDATE         |
    |                       |----------------------&gt;|
    |                       | STUN Binding Response |
    |                       | from 192.0.2.1:3478   |
    |                       | to   192.0.2.3:45664  |
    |                       |&lt;----------------------|
    | STUN Binding Response |                       |
    | from 192.0.2.1:3478   |                       |
    | to   10.0.1.1:8998    |                       |
    | map  192.0.2.3:45664  |                       |
    |&lt;----------------------|                       |
    |================RTP now can flow==============&gt;|
    |                       | STUN Binding Request  |
    |                       | from 192.0.2.1:3478   |
    |                       | to   192.0.2.3:45664  |
    |                       |&lt;----------------------|
    | STUN Binding Request  |                       |
    | from 192.0.2.1:3478   |                       |
    | to   10.0.1.1:8998    |                       |
    |&lt;----------------------|                       |
    | STUN Binding Response |                       |
    | from 10.0.1.1:8998    |                       |
    | to   192.0.2.1:3478   |                       |
    | map  192.0.2.1:3478   |                       |
    |----------------------&gt;|                       |
    |                       | STUN Binding Response |
    |                       | from 192.0.2.3:45664  |
    |                       | to   192.0.2.1:3478   |
    |                       | map  192.0.2.1:3478   |
    |                       |----------------------&gt;|
    |&lt;===============RTP now can flow===============|
    |                       |                       |
    </pre></div>
    <p class="" style="">Note: The initiator (controlling agent) is using "aggressive nomination" as described in Section 8.1.1.2 of <span class="ref">ICE-CORE</span> and therefore includes the USE-CANDIDATE attribute in the STUN Binding Requests it sends.</p>
  </div>
  <div class="indent"><h3>5.6 <a name="protocol-acceptance" id="protocol-acceptance">Acceptance of Successful Candidate</a></h3>
    <p class="" style="">If, based on STUN connectivity checks, the parties determine that they will be able to exchange media between a given pair of local candidates and remote candidates (i.e., the pair is "nominated" and ICE processing is "completed"), the parties shall proceed as follows:</p>
    <ol start="" class="" style="">
      <li class="" style="">The initiator sends a Jingle content-replace action to the responder.</li>
      <li class="" style="">The responder acknowledges receipt of the content-replace.</li>
      <li class="" style="">The responder sends a Jingle session-accept action to the initiator.</li>
      <li class="" style="">The initiator acknowledges receipt of the session-accept.</li>
    </ol>
    <p class="" style="">First the initiator sends a Jingle content-replace action to the responder. The content-replace MUST contain information about the nominated pair, including the "rem-addr" and "rem-port" attributes (which specify the IP address and port for the responder's end of the pair, which is a "remote address" according to the initiator). This enables both parties to explicitly agree to both ends of the connection pair (i.e., the local address+port and the remote address+port).</p>
    <p class="caption"><a name="example-8" id="example-8"></a>Example 8. Initiator requests content-replace</p><div class="indent"><pre>
&lt;iq from='romeo@montague.lit/orchard'
    id='rep1'
    to='juliet@capulet.lit/balcony'
    type='set'&gt;
  &lt;jingle xmlns='urn:xmpp:tmp:jingle'
          action='content-replace'
          initiator='romeo@montague.lit/orchard'
          sid='a73sjjvkla37jfea'&gt;
    &lt;content creator='initiator' name='this-is-the-audio-content' profile='RTP/AVP'&gt;
      &lt;description xmlns='urn:xmpp:tmp:jingle:apps:audio-rtp'&gt;
        [ ... ]
      &lt;/description&gt;
      &lt;transport xmlns='urn:xmpp:tmp:jingle:transports:ice-tcp'&gt;
        &lt;candidate component='1'
                   foundation='1'
                   generation='0'
                   ip='192.0.2.3'
                   network='1'
                   port='45664'
                   priority='1694498815'
                   protocol='udp'
                   pwd='asd88fgpdd777uzjYhagZg'
                   rel-addr='10.0.1.1'
                   rel-port='8998'
                   rem-addr='192.0.2.1'
                   rem-port='3478'
                   type='srflx'
                   ufrag='8hhy'/&gt;
      &lt;/transport&gt;
    &lt;/content&gt;
  &lt;/jingle&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The responder then acknowledges the content-replace action.</p>
    <p class="caption"><a name="example-9" id="example-9"></a>Example 9. Responder acknowledges content-replace</p><div class="indent"><pre>
&lt;iq from='juliet@capulet.lit/balcony'
    id='rep1'
    to='romeo@montague.lit/orchard'
    type='result'/&gt;
    </pre></div>
    <p class="" style="">The responder then sends a session-accept action to the initiator, specifying the candidate that succeeded.</p>
    <p class="caption"><a name="example-10" id="example-10"></a>Example 10. Responder definitively accepts the successful candidate</p><div class="indent"><pre>
&lt;iq from='juliet@capulet.com/balcony'
    id='accept1'
    to='romeo@montague.net/orchard'
    type='set'&gt;
  &lt;jingle xmlns='urn:xmpp:tmp:jingle'
          action='session-accept'
          initiator='romeo@montague.net/orchard'
          responder='juliet@capulet.com/balcony'
          sid='a73sjjvkla37jfea'&gt;
    &lt;content creator='initiator' name='this-is-the-audio-content' profile='RTP/AVP'&gt;
      &lt;description xmlns='urn:xmpp:tmp:jingle:apps:audio-rtp'&gt;
        [ ... ]
      &lt;/description&gt;
      &lt;transport xmlns='urn:xmpp:tmp:jingle:transports:ice-tcp'&gt;
        &lt;candidate component='1'
                   foundation='1'
                   generation='0'
                   ip='192.0.2.3'
                   network='1'
                   port='45664'
                   priority='1694498815'
                   protocol='udp'
                   pwd='asd88fgpdd777uzjYhagZg'
                   rel-addr='10.0.1.1'
                   rel-port='8998'
                   rem-addr='192.0.2.1'
                   rem-port='3478'
                   type='srflx'
                   ufrag='8hhy'/&gt;
      &lt;/transport&gt;
    &lt;/content&gt;
  &lt;/jingle&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The &lt;jingle/&gt; element in the session-accept stanza SHOULD possess a 'responder' attribute that explicitly specifies the full JID of the responding entity. If the 'responder' attribute is provided, all future commmunications SHOULD be sent to the JID provided in the 'responder' attribute.</p>
    <p class="" style="">Since according to the connectivity checks the initiator can also send data over that candidate, it acknowledges the responder's acceptance:</p>
    <p class="caption"><a name="example-11" id="example-11"></a>Example 11. Initiator acknowledges acceptance of successful candidate</p><div class="indent"><pre>
&lt;iq from='romeo@montague.net/orchard'
    id='accept1'
    to='juliet@capulet.com/balcony'
    type='result'/&gt;
    </pre></div>
    <p class="" style="">Now the initiator and responder can begin sending data over the negotiated connection (in fact, they could have sent data as soon as the connectivity checks succeeded, as shown in the preceding examples).</p>
    <p class="" style="">If a candidate succeeded for the responder but the initiator cannot send data over that candidate, it MUST return a &lt;not-acceptable/&gt; error in response to the responder's acceptance of the successful candidate:</p>
    <p class="caption"><a name="example-12" id="example-12"></a>Example 12. Initiator returns error in response to acceptance of successful candidate</p><div class="indent"><pre>
&lt;iq from='romeo@montague.net/orchard'
    id='accept1'
    to='juliet@capulet.com/balcony'
    type='error'&gt;
  &lt;error type='cancel'&gt;
    &lt;not-acceptable xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
  &lt;/error&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the responder cannot find a suitable candidate transport or it receives a &lt;not-acceptable/&gt; error from the initiator in response to its acceptance of a suitable transport, it SHOULD terminate the session as described in Section 6.8 of <span class="ref">XEP-0166</span>.</p>
  </div>
  <div class="indent"><h3>5.7 <a name="protocol-modify" id="protocol-modify">Modifying an Existing Candidate</a></h3>
    <p class="" style="">The creator of a content type MAY modify an existing, in-use candidate at any time during the session, for example to change the IP address or port. This is done by sending a content-replace action with the changed candidate information, where the value of the 'generation' is incremented to specify that the candidate information is a modification to an existing candidate.</p>
    <p class="" style="">An example follows (change to IP address and port).</p>
    <p class="caption"><a name="example-13" id="example-13"></a>Example 13. Initiator modifies the in-use candidate</p><div class="indent"><pre>
&lt;iq from='romeo@montague.net/orchard'
    id='rep2'
    to='juliet@capulet.com/balcony'
    type='set'&gt;
  &lt;jingle xmlns='urn:xmpp:tmp:jingle'
          action='content-replace'
          initiator='romeo@montague.net/orchard'
          sid='a73sjjvkla37jfea'&gt;
    &lt;content creator='initiator' name='this-is-the-audio-content' profile='RTP/AVP'&gt;
      &lt;transport xmlns='urn:xmpp:tmp:jingle:transports:ice-tcp'&gt;
        &lt;candidate component='1'
                   foundation='1'
                   generation='1'
                   ip='192.0.2.3'
                   network='1'
                   port='45665'
                   priority='1694498815'
                   protocol='udp'
                   pwd='asd88fgpdd777uzjYhagZg'
                   type='srflx'
                   ufrag='8hhy'/&gt;
      &lt;/transport&gt;
    &lt;/content&gt;
  &lt;/jingle&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The recipient then acknowledges receipt.</p>
    <p class="caption"><a name="example-14" id="example-14"></a>Example 14. Recipient acknowledges content-replace</p><div class="indent"><pre>
&lt;iq from='juliet@capulet.com/balcony'
    id='rep2'
    to='romeo@montague.net/orchard'
    type='result'/&gt;
    </pre></div>
    <p class="" style="">If the content-replace is acceptable, the recipient then sends a content-accept action.</p>
    <p class="caption"><a name="example-15" id="example-15"></a>Example 15. Responder definitively accepts the replaced candidate</p><div class="indent"><pre>
&lt;iq from='juliet@capulet.com/balcony'
    id='accept2'
    to='romeo@montague.net/orchard'
    type='set'&gt;
  &lt;jingle xmlns='urn:xmpp:tmp:jingle'
          action='content-accept'
          initiator='romeo@montague.net/orchard'
          responder='juliet@capulet.com/balcony'
          sid='a73sjjvkla37jfea'&gt;
    &lt;content creator='initiator' name='this-is-the-audio-content' profile='RTP/AVP'&gt;
      &lt;description xmlns='urn:xmpp:tmp:jingle:apps:audio-rtp'&gt;
        [ ... ]
      &lt;/description&gt;
      &lt;transport xmlns='urn:xmpp:tmp:jingle:transports:ice-tcp'&gt;
        &lt;candidate component='1'
                   foundation='1'
                   generation='1'
                   ip='192.0.2.3'
                   network='1'
                   port='45665'
                   priority='1694498815'
                   protocol='udp'
                   pwd='asd88fgpdd777uzjYhagZg'
                   type='srflx'
                   ufrag='8hhy'/&gt;
      &lt;/transport&gt;
    &lt;/content&gt;
  &lt;/jingle&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The initiator then acknowledges the responder's acceptance:</p>
    <p class="caption"><a name="example-16" id="example-16"></a>Example 16. Initiator acknowledges content acceptance</p><div class="indent"><pre>
&lt;iq from='romeo@montague.net/orchard'
    id='accept2'
    to='juliet@capulet.com/balcony'
    type='result'/&gt;
    </pre></div>
    <p class="" style="">The parties then use the modified candidate in subsequent communications.</p>
  </div>
  <div class="indent"><h3>5.8 <a name="protocol-renegotiate" id="protocol-renegotiate">Negotiating a New Candidate</a></h3>
    <p class="" style="">Even after content acceptance or session acceptance, either party MAY continue to send additional candidates to the other party (e.g., because the user agent has become aware of a new media proxy or NIC). As above, such candidates are shared by sending a transport-info action.</p>
    <p class="caption"><a name="example-17" id="example-17"></a>Example 17. Initiator sends a fourth candidate</p><div class="indent"><pre>
&lt;iq from='romeo@montague.net/orchard'
    id='info4'
    to='juliet@capulet.com/balcony'
    type='set'&gt;
  &lt;jingle xmlns='urn:xmpp:tmp:jingle'
          action='transport-info'
          initiator='romeo@montague.net/orchard'
          sid='a73sjjvkla37jfea'&gt;
    &lt;content creator='initiator' name='this-is-the-audio-content' profile='RTP/AVP'&gt;
      &lt;transport xmlns='urn:xmpp:tmp:jingle:transports:ice-tcp'&gt;
        &lt;candidate component='1'
                   foundation='1'
                   generation='0'
                   ip='10.0.1.2'
                   network='0'
                   port='9001'
                   priority='21149780477'
                   protocol='udp'
                   pwd='asd88fgpdd777uzjYhagZg'
                   type='host'
                   ufrag='8hhy'/&gt;
      &lt;/transport&gt;
    &lt;/content&gt;
  &lt;/jingle&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The receiving party MUST acknowledge receipt of the candidate.</p>
    <p class="caption"><a name="example-18" id="example-18"></a>Example 18. Recipient acknowledges receipt</p><div class="indent"><pre>
&lt;iq from='juliet@capulet.com/balcony'
    id='info4'
    to='romeo@montague.net/orchard'
    type='result'/&gt;
    </pre></div>
    <p class="" style="">The parties SHOULD check the newly-offered candidate for connectivity, as described previously. If the parties determine that media can flow over the candidate, the initiating party shall send a content-replace action to the responder.</p>
    <p class="caption"><a name="example-19" id="example-19"></a>Example 19. Initiator sends content-replace</p><div class="indent"><pre>
&lt;iq from='romeo@montague.net/orchard'
    id='rep3'
    to='juliet@capulet.com/balcony'
    type='set'&gt;
  &lt;jingle xmlns='urn:xmpp:tmp:jingle'
          action='content-replace'
          initiator='romeo@montague.net/orchard'
          responder='juliet@capulet.com/balcony'
          sid='a73sjjvkla37jfea'&gt;
    &lt;content creator='initiator' name='this-is-the-audio-content'&gt;
      &lt;description xmlns='urn:xmpp:tmp:jingle:apps:audio-rtp' profile='RTP/AVP'&gt;
        [ ... ]
      &lt;/description&gt;
      &lt;transport xmlns='urn:xmpp:tmp:jingle:transports:ice-tcp'&gt;
        &lt;candidate component='1'
                   foundation='1'
                   generation='0'
                   ip='10.0.1.2'
                   network='0'
                   port='9001'
                   priority='21149780477'
                   protocol='udp'
                   pwd='asd88fgpdd777uzjYhagZg'
                   type='host'
                   ufrag='8hhy'/&gt;
      &lt;/transport&gt;
    &lt;/content&gt;
  &lt;/jingle&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The responder then acknowledges the replaced content definition.</p>
    <p class="caption"><a name="example-20" id="example-20"></a>Example 20. Responder acknowledges content-replace</p><div class="indent"><pre>
&lt;iq from='juliet@capulet.com/balcony'
    id='rep3'
    to='romeo@montague.net/orchard'
    type='result'/&gt;
    </pre></div>
    <p class="" style="">The responder then accepts the replaced content definition.</p>
    <p class="caption"><a name="example-21" id="example-21"></a>Example 21. Responder definitively accepts the replaced content definition</p><div class="indent"><pre>
&lt;iq from='juliet@capulet.com/balcony'
    id='accept3'
    to='romeo@montague.net/orchard'
    type='set'&gt;
  &lt;jingle xmlns='urn:xmpp:tmp:jingle'
          action='content-accept'
          initiator='romeo@montague.net/orchard'
          responder='juliet@capulet.com/balcony'
          sid='a73sjjvkla37jfea'&gt;
    &lt;content creator='initiator' name='this-is-the-audio-content' profile='RTP/AVP'&gt;
      &lt;description xmlns='urn:xmpp:tmp:jingle:apps:audio-rtp'&gt;
        [ ... ]
      &lt;/description&gt;
      &lt;transport xmlns='urn:xmpp:tmp:jingle:transports:ice-tcp'&gt;
        &lt;candidate component='1'
                   foundation='1'
                   generation='0'
                   ip='10.0.1.2'
                   network='0'
                   port='9001'
                   priority='21149780477'
                   protocol='udp'
                   pwd='asd88fgpdd777uzjYhagZg'
                   type='host'
                   ufrag='8hhy'/&gt;
      &lt;/transport&gt;
    &lt;/content&gt;
  &lt;/jingle&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The initiator then acknowledges content acceptance.</p>
    <p class="caption"><a name="example-22" id="example-22"></a>Example 22. Initiator acknowledges content acceptance</p><div class="indent"><pre>
&lt;iq from='romeo@montague.net/orchard'
    id='accept3'
    to='juliet@capulet.com/balcony'
    type='result'/&gt;
    </pre></div>
    <p class="" style="">The parties then use the new candidate in subsequent communications.</p>
  </div>
<h2>6.
       <a name="support" id="support">Determining Support</a></h2>
  <p class="" style="">If an entity supports the Jingle ice-udp transport, it MUST return a feature of "urn:xmpp:tmp:jingle:transports:ice-tcp" (see <a href="#ns">Protocol Namespaces</a> regarding issuance of one or more permanent namespaces) in response to <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0030.html">Service Discovery</a></span>  [<a href="#nt-id2263786">12</a>] information requests.</p>
  <p class="caption"><a name="example-23" id="example-23"></a>Example 23. Service discovery information request</p><div class="indent"><pre>
&lt;iq from='romeo@montague.net/orchard'
    id='disco1'
    to='juliet@capulet.com/balcony'
    type='get'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'/&gt;
&lt;/iq&gt;
  </pre></div>
  <p class="caption"><a name="example-24" id="example-24"></a>Example 24. Service discovery information response</p><div class="indent"><pre>
&lt;iq from='juliet@capulet.com/balcony'
    id='disco1'
    to='romeo@montague.net/orchard'
    type='result'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'&gt;
    ...
    &lt;feature var='urn:xmpp:tmp:jingle:transports:ice-tcp'/&gt;
    ...
  &lt;/query&gt;
&lt;/iq&gt;
  </pre></div>
  <p class="" style="">Naturally, support MAY also be determined via the dynamic, presence-based profile of Service Discovery defined in <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0115.html">Entity Capabilities</a></span>  [<a href="#nt-id2263842">13</a>].</p>
<h2>7.
       <a name="impl" id="impl">Implementation Notes</a></h2>
  <p class="" style="">In order to speed the negotiation process so that media can flow as quickly as possible, the initiatior should gather and prioritize candidates in advance or as soon as the principal begins the process of initiating a session.</p>
<h2>8.
       <a name="deploy" id="deploy">Deployment Notes</a></h2>
  <p class="" style="">This specification applies exclusively to Jabber/XMPP clients and places no additional requirements on Jabber/XMPP servers. However, service administrators may wish to deploy a STUN server in order to ease the client-to-client negotiation process. See <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0215.html">External Service Discovery</a></span>  [<a href="#nt-id2263945">14</a>] for related information.</p>
<h2>9.
       <a name="security" id="security">Security Considerations</a></h2>
  <p class="" style="">In order to secure the data stream that is negotiated via the Jingle ICE transport, implementations SHOULD use encryption methods appropriate to the transport method and media being exchanged (for details regarding audio and video exchanges via RTP, refer to <span class="ref">XEP-0167</span> and <span class="ref">XEP-0180</span>).</p>
<h2>10.
       <a name="iana" id="iana">IANA Considerations</a></h2>
  <p class="" style="">This document requires no interaction with the <span class="ref" style=""><a href="http://www.iana.org/">Internet Assigned Numbers Authority (IANA)</a></span>  [<a href="#nt-id2263976">15</a>].</p>
<h2>11.
       <a name="registrar" id="registrar">XMPP Registrar Considerations</a></h2>
  <div class="indent"><h3>11.1 <a name="ns" id="ns">Protocol Namespaces</a></h3>
    <p class="" style="">Until this specification advances to a status of Draft, its associated namespaces shall be:</p>
    <ul class="" style="">
      <li class="" style="">urn:xmpp:tmp:jingle:transports:ice-tcp</li>
    </ul>
    <p class="" style="">Upon advancement of this specification, the <span class="ref" style=""><a href="http://www.xmpp.org/registrar/">XMPP Registrar</a></span>  [<a href="#nt-id2264052">16</a>] shall issue permanent namespaces in accordance with the process defined in Section 4 of <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0053.html">XMPP Registrar Function</a></span>  [<a href="#nt-id2264123">17</a>].</p>
    <p class="" style="">The following namespaces are requested, and are thought to be unique per the XMPP Registrar's requirements:</p>
    <ul class="" style="">
      <li class="" style="">urn:xmpp:jingle:transport:ice-udp</li>
    </ul>
  </div>
  <div class="indent"><h3>11.2 <a name="registrar-transports" id="registrar-transports">Jingle Transport Methods</a></h3>
    <p class="" style="">The XMPP Registrar shall include "ice-udp" in its registry of Jingle transport methods. The registry submission is as follows:</p>
    <p class="caption"></p><div class="indent"><pre>
&lt;transport&gt;
  &lt;name&gt;ice-udp&lt;/name&gt;
  &lt;desc&gt;
    A method for negotiation of out-of-band UDP connections with built-in NAT
    and firewall traversal, equivalent to the IETF's Interactive Connectivity
    Establishment (ICE) methodology when resulting in the use of UDP as the
    transport protocol.
  &lt;/desc&gt;
  &lt;type&gt;lossy&lt;/type&gt;
  &lt;doc&gt;XEP-0176&lt;/doc&gt;
&lt;/transport&gt;
    </pre></div>
  </div>
<h2>12.
       <a name="schema" id="schema">XML Schema</a></h2>
  <p class="caption"></p><div class="indent"><pre>
&lt;?xml version='1.0' encoding='UTF-8'?&gt;

&lt;xs:schema
    xmlns:xs='http://www.w3.org/2001/XMLSchema'
    targetNamespace='urn:xmpp:tmp:jingle:transports:ice-tcp'
    xmlns='urn:xmpp:tmp:jingle:transports:ice-tcp'
    elementFormDefault='qualified'&gt;

  &lt;xs:element name='transport'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:choice&gt;
        &lt;xs:sequence&gt;
          &lt;xs:element ref='candidate' minOccurs='0' maxOccurs='1'/&gt;
        &lt;/xs:sequence&gt;
      &lt;/xs:choice&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='candidate'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='empty'&gt;
          &lt;xs:attribute name='component' type='xs:unsignedByte' use='required'/&gt;
          &lt;xs:attribute name='foundation' type='xs:unsignedByte' use='required'/&gt;
          &lt;xs:attribute name='generation' type='xs:unsignedByte' use='required'/&gt;
          &lt;xs:attribute name='ip' type='xs:string' use='required'/&gt;
          &lt;xs:attribute name='network' type='xs:unsignedByte' use='required'/&gt;
          &lt;xs:attribute name='port' type='xs:unsignedShort' use='required'/&gt;
          &lt;xs:attribute name='priority' type='xs:positiveInteger' use='required'/&gt;
          &lt;xs:attribute name='protocol' type='xs:NCName' use='required'/&gt;
          &lt;xs:attribute name='pwd' type='xs:string' use='required'/&gt;
          &lt;xs:attribute name='rel-addr' type='xs:string' use='optional'/&gt;
          &lt;xs:attribute name='rel-port' type='xs:unsignedShort' use='optional'/&gt;
          &lt;xs:attribute name='rem-addr' type='xs:string' use='optional'/&gt;
          &lt;xs:attribute name='rem-port' type='xs:unsignedShort' use='optional'/&gt;
          &lt;xs:attribute name='type' use='required'&gt;
            &lt;xs:simpleType&gt;
              &lt;xs:restriction base='xs:NCName'&gt;
                &lt;xs:enumeration value='host'/&gt;
                &lt;xs:enumeration value='prflx'/&gt;
                &lt;xs:enumeration value='relay'/&gt;
                &lt;xs:enumeration value='srflx'/&gt;
              &lt;/xs:restriction&gt;
            &lt;/xs:simpleType&gt;
          &lt;/xs:attribute&gt;
          &lt;xs:attribute name='ufrag' type='xs:string' use='required'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:simpleType name='empty'&gt;
    &lt;xs:restriction base='xs:string'&gt;
      &lt;xs:enumeration value=''/&gt;
    &lt;/xs:restriction&gt;
  &lt;/xs:simpleType&gt;

&lt;/xs:schema&gt;
  </pre></div>
<h2>13.
       <a name="ack" id="ack">Acknowledgements</a></h2>
  <p class="" style="">Thanks to Steffen Larsen for his helpful feedback.</p>
<hr /><h2><a name="notes" id="notes"></a>Notes</h2><div class="indent"><p><a name="nt-id2251551" id="nt-id2251551">1</a>. XEP-0166: Jingle &lt;<a href="http://www.xmpp.org/extensions/xep-0166.html">http://www.xmpp.org/extensions/xep-0166.html</a>&gt;.</p><p><a name="nt-id2251574" id="nt-id2251574">2</a>. RFC 768: User Datagram Protocol &lt;<a href="http://tools.ietf.org/html/rfc0768">http://tools.ietf.org/html/rfc0768</a>&gt;.</p><p><a name="nt-id2251602" id="nt-id2251602">3</a>. Interactive Connectivity Establishment (ICE): A Methodology for Network Address Translator (NAT) Traversal for Offer/Answer Protocols &lt;<a href="http://tools.ietf.org/html/draft-ietf-mmusic-ice">http://tools.ietf.org/html/draft-ietf-mmusic-ice</a>&gt;. Work in progress.</p><p><a name="nt-id2261229" id="nt-id2261229">4</a>. This approach takes advantage of the request-response semantics of the XMPP &lt;iq/&gt; stanza type and enables the parties to send higher-priority candidates earlier in the negotiation, but implies that Jingle is not exactly an offer-answer protocol as specified in RFC 3264.</p><p><a name="nt-id2261270" id="nt-id2261270">5</a>. RFC 4566: SDP: Session Description Protocol &lt;<a href="http://tools.ietf.org/html/rfc4566">http://tools.ietf.org/html/rfc4566</a>&gt;.</p><p><a name="nt-id2261492" id="nt-id2261492">6</a>. RFC 3550: RTP: A Transport Protocol for Real-Time Applications &lt;<a href="http://tools.ietf.org/html/rfc3550">http://tools.ietf.org/html/rfc3550</a>&gt;.</p><p><a name="nt-id2261660" id="nt-id2261660">7</a>. Concurrent with negotiation of the ICE candidates, it is possible for the initiator and responder to negotiate which content types the session will include, which transport methods will be tried for each content type, etc. Those negotiation flows are shown in other specifications, such as <span class="ref">XEP-0166</span>. This document specifies only negotiation of the ICE transport method.</p><p><a name="nt-id2262005" id="nt-id2262005">8</a>. In accordance with the rules specified in Section 4.1.1 of <span class="ref">ICE-CORE</span>, the priority values shown in the examples within this document have been calculated as follows. The "type preference" for host candidates is stipulated to be "126" and for server reflexive candidates "100". The "local preference" for network 0 is stipulated to be "4096", for network 1 "2048", and for network 2 "1024".</p><p><a name="nt-id2262370" id="nt-id2262370">9</a>. The fact that both parties send candidates means that Jingle requires each party to be a full implementation of ICE, not a lite implementation as specified in <span class="ref">ICE-CORE</span>.</p><p><a name="nt-id2251103" id="nt-id2251103">10</a>. Session Traversal Utilities for NAT (STUN) &lt;<a href="http://tools.ietf.org/html/draft-ietf-behave-rfc3489bis">http://tools.ietf.org/html/draft-ietf-behave-rfc3489bis</a>&gt;.</p><p><a name="nt-id2251184" id="nt-id2251184">11</a>. Thus when Romeo sends a STUN Binding Request to Juliet the credentials will be STUN username "8hhy:9uB6" and password "YH75Fviy6338Vbrhrlp8Yh" whereas when Juliet sends a STUN Binding Request to Romeo the credentials will be STUN username "9uB6:8hhy" and password "asd88fgpdd777uzjYhagZg".</p><p><a name="nt-id2263786" id="nt-id2263786">12</a>. XEP-0030: Service Discovery &lt;<a href="http://www.xmpp.org/extensions/xep-0030.html">http://www.xmpp.org/extensions/xep-0030.html</a>&gt;.</p><p><a name="nt-id2263842" id="nt-id2263842">13</a>. XEP-0115: Entity Capabilities &lt;<a href="http://www.xmpp.org/extensions/xep-0115.html">http://www.xmpp.org/extensions/xep-0115.html</a>&gt;.</p><p><a name="nt-id2263945" id="nt-id2263945">14</a>. XEP-0215: External Service Discovery &lt;<a href="http://www.xmpp.org/extensions/xep-0215.html">http://www.xmpp.org/extensions/xep-0215.html</a>&gt;.</p><p><a name="nt-id2263976" id="nt-id2263976">15</a>. The Internet Assigned Numbers Authority (IANA) is the central coordinator for the assignment of unique parameter values for Internet protocols, such as port numbers and URI schemes. For further information, see &lt;<a href="http://www.iana.org/">http://www.iana.org/</a>&gt;.</p><p><a name="nt-id2264052" id="nt-id2264052">16</a>. The XMPP Registrar maintains a list of reserved protocol namespaces as well as registries of parameters used in the context of XMPP extension protocols approved by the XMPP Standards Foundation. For further information, see &lt;<a href="http://www.xmpp.org/registrar/">http://www.xmpp.org/registrar/</a>&gt;.</p><p><a name="nt-id2264123" id="nt-id2264123">17</a>. XEP-0053: XMPP Registrar Function &lt;<a href="http://www.xmpp.org/extensions/xep-0053.html">http://www.xmpp.org/extensions/xep-0053.html</a>&gt;.</p></div><hr /><h2><a name="revs" id="revs"></a>Revision History</h2><div class="indent"><h4>Version 0.16 (2008-02-29)</h4><div class="indent"><p class="" style="">Changed content-modify to content-replace per XEP-0166.</p> (psa)
    </div><h4>Version 0.15 (2008-01-06)</h4><div class="indent"><p class="" style="">Clarified several small points regarding candidate gathering procedures and STUN connectivity checks.</p> (psa)
    </div><h4>Version 0.14 (2008-01-02)</h4><div class="indent"><p class="" style="">Modified flow for ICE completion to require content-modify from initiator to responder, thus mapping to sending of revised offer in SIP; added rem-addr and rem-port attributes to map to a=remote-candidates information in SDP; changed raddr and rport attributes to rel-addr and rel-port to prevent confusion with rem-addr and rem-port attributes.</p> (psa)
    </div><h4>Version 0.13 (2007-12-28)</h4><div class="indent"><p class="" style="">Added further details about connectivity checks; defined raddr and rport attributes for complete mapping to SDP.</p> (psa)
    </div><h4>Version 0.12 (2007-11-28)</h4><div class="indent"><p class="" style="">Moved ice-tcp definition to a separate specification.</p> (psa)
    </div><h4>Version 0.11 (2007-11-27)</h4><div class="indent"><p class="" style="">Further editorial review; also added sections on modification of existing candidates and exchange of subsequent candidates.</p> (psa)
    </div><h4>Version 0.10 (2007-11-15)</h4><div class="indent"><p class="" style="">Editorial review and consistency check.</p> (psa)
    </div><h4>Version 0.9 (2007-06-28)</h4><div class="indent"><p class="" style="">Updated to track ICE-16.</p> (psa)
    </div><h4>Version 0.8 (2007-04-17)</h4><div class="indent"><p class="" style="">Separately defined ice-tcp and ice-udp transport methods to enable clearer definition of transport methods and reuse by application types; specified Jingle conformance, including definition of ice-udp as lossy and ice-tcp as reliable.</p> (psa)
    </div><h4>Version 0.7 (2007-03-23)</h4><div class="indent"><p class="" style="">Updated to track ICE-14 and ICE-TCP-03; moved text on discovery of STUN servers to separate specification.</p> (psa)
    </div><h4>Version 0.6 (2006-12-21)</h4><div class="indent"><p class="" style="">Modified spec to use provisional namespace before advancement to Draft (per XEP-0053).</p> (psa)
    </div><h4>Version 0.5 (2006-10-31)</h4><div class="indent"><p class="" style="">Updated to track ICE-12; corrected service discovery process; completed editorial review; removed mention of DTMF, which is for audio only.</p> (psa)
    </div><h4>Version 0.4 (2006-09-13)</h4><div class="indent"><p class="" style="">Updated to track ICE-10; added section on service discovery.</p> (psa)
    </div><h4>Version 0.3 (2006-07-12)</h4><div class="indent"><p class="" style="">Specified that DTMF must use in-band signalling (XEP-0181).</p> (se/psa)
    </div><h4>Version 0.2 (2006-03-24)</h4><div class="indent"><p class="" style="">Recommended use of RTP-native methods for DTMF.</p> (psa)
    </div><h4>Version 0.1 (2006-03-01)</h4><div class="indent"><p class="" style="">Initial version (split from XEP-0166).</p> (psa/jb)
    </div></div><hr /><p>END</p></body></html>
